<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/icon.jpg">
  
  <title>Tomcat启动过程 | QWQ0QWQ&#39;s blog</title>
  
  <meta name="author" content="QWQ0QWQ" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="" />
  
  <meta name="description" content="Tomcat - 启动过程：初始化和启动流程 在有了Tomcat架构设计和源码入口以后，我们便可以开始真正读源码了。  # 总体流程 很多人在看框架代码的时候会很难抓住重点的，而一开始了解整体流程会很大程度提升理解的效率。  我们看下整体的初始化和启动的流程，在理解的时候可以直接和Tomcat架构设计中组件关联上：  # 代码浅析看了下网上关于Tomcat的文章，很多直接关注在纯代码的分析，这种是">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat启动过程">
<meta property="og:url" content="https://qwq0qwq.github.io/2023/08/11/Tomcat%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/index.html">
<meta property="og:site_name" content="QWQ0QWQ&#39;s blog">
<meta property="og:description" content="Tomcat - 启动过程：初始化和启动流程 在有了Tomcat架构设计和源码入口以后，我们便可以开始真正读源码了。  # 总体流程 很多人在看框架代码的时候会很难抓住重点的，而一开始了解整体流程会很大程度提升理解的效率。  我们看下整体的初始化和启动的流程，在理解的时候可以直接和Tomcat架构设计中组件关联上：  # 代码浅析看了下网上关于Tomcat的文章，很多直接关注在纯代码的分析，这种是">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qwq0qwq.github.io/images/icon.jpg">
<meta property="article:published_time" content="2023-08-10T23:56:52.000Z">
<meta property="article:modified_time" content="2023-08-10T23:57:38.701Z">
<meta property="article:author" content="QWQ0QWQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qwq0qwq.github.io/images/icon.jpg">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/bg.webp');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 7.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">QWQ0QWQ&#39;s blog</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>QWQ0QWQ&#39;s blog</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2023/08/11/Tomcat%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">Tomcat启动过程</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-08-10T23:56:52.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-08-11</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">QWQ0QWQ</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~30.61K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1691711858701"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><h1 id="Tomcat-启动过程：初始化和启动流程"><a href="#Tomcat-启动过程：初始化和启动流程" class="headerlink" title="Tomcat - 启动过程：初始化和启动流程"></a>Tomcat - 启动过程：初始化和启动流程</h1><blockquote>
<p>在有了Tomcat架构设计和源码入口以后，我们便可以开始真正读源码了。</p>
</blockquote>
<h2 id="总体流程"><a href="#总体流程" class="headerlink" title="# 总体流程"></a><a href="#%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B">#</a> 总体流程</h2><blockquote>
<p>很多人在看框架代码的时候会很难抓住重点的，而一开始了解整体流程会很大程度提升理解的效率。</p>
</blockquote>
<p>我们看下整体的初始化和启动的流程，在<strong>理解的时候可以直接和Tomcat架构设计中组件关联上</strong>：</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-start-1.png" alt="img"></p>
<h2 id="代码浅析"><a href="#代码浅析" class="headerlink" title="# 代码浅析"></a><a href="#%E4%BB%A3%E7%A0%81%E6%B5%85%E6%9E%90">#</a> 代码浅析</h2><p>看了下网上关于Tomcat的文章，很多直接关注在纯代码的分析，这种是很难的；我建议你一定要把代码加载进来自己看一下，然后这里我把它转化为核心的几个问题来帮助你理解。</p>
<h3 id="Bootstrap主入口？"><a href="#Bootstrap主入口？" class="headerlink" title="# Bootstrap主入口？"></a><a href="#bootstrap%E4%B8%BB%E5%85%A5%E5%8F%A3">#</a> Bootstrap主入口？</h3><p>Tomcat源码就从它的main方法开始。Tomcat的main方法在org.apache.catalina.startup.Bootstrap 里。 如下代码我们就是创建一个 Bootstrap 对象，调用它的 init 方法初始化，然后根据启动参数，分别调用 Bootstrap 对象的不同方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Bootstrap</span> &#123;</span><br><span class="line">    ……</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Daemon object used by main.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">daemonLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    </span><br><span class="line">    ……</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Main method and entry point when starting Tomcat via the provided</span></span><br><span class="line"><span class="comment">     * scripts.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args Command line arguments to be processed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个 Bootstrap 对象，调用它的 init 方法初始化</span></span><br><span class="line">        <span class="keyword">synchronized</span> (daemonLock) &#123;</span><br><span class="line">            <span class="keyword">if</span> (daemon == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t set daemon until init() has completed</span></span><br><span class="line">                <span class="type">Bootstrap</span> <span class="variable">bootstrap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bootstrap</span>();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bootstrap.init();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    handleThrowable(t);</span><br><span class="line">                    t.printStackTrace();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                daemon = bootstrap;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// When running as a service the call to stop will be on a new</span></span><br><span class="line">                <span class="comment">// thread so make sure the correct class loader is used to</span></span><br><span class="line">                <span class="comment">// prevent a range of class not found exceptions.</span></span><br><span class="line">                Thread.currentThread().setContextClassLoader(daemon.catalinaLoader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据启动参数，分别调用 Bootstrap 对象的不同方法</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">command</span> <span class="operator">=</span> <span class="string">&quot;start&quot;</span>; <span class="comment">// 默认是start</span></span><br><span class="line">            <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                command = args[args.length - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (command.equals(<span class="string">&quot;startd&quot;</span>)) &#123;</span><br><span class="line">                args[args.length - <span class="number">1</span>] = <span class="string">&quot;start&quot;</span>;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                daemon.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stopd&quot;</span>)) &#123;</span><br><span class="line">                args[args.length - <span class="number">1</span>] = <span class="string">&quot;stop&quot;</span>;</span><br><span class="line">                daemon.stop();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;start&quot;</span>)) &#123;</span><br><span class="line">                daemon.setAwait(<span class="literal">true</span>);</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                daemon.start();</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;stop&quot;</span>)) &#123;</span><br><span class="line">                daemon.stopServer(args);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">&quot;configtest&quot;</span>)) &#123;</span><br><span class="line">                daemon.load(args);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                    System.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                System.exit(<span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Bootstrap: command \&quot;&quot;</span> + command + <span class="string">&quot;\&quot; does not exist.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="comment">// Unwrap the Exception for clearer error reporting</span></span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InvocationTargetException &amp;&amp;</span><br><span class="line">                    t.getCause() != <span class="literal">null</span>) &#123;</span><br><span class="line">                t = t.getCause();</span><br><span class="line">            &#125;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            t.printStackTrace();</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Bootstrap如何初始化Catalina的？"><a href="#Bootstrap如何初始化Catalina的？" class="headerlink" title="# Bootstrap如何初始化Catalina的？"></a><a href="#bootstrap%E5%A6%82%E4%BD%95%E5%88%9D%E5%A7%8B%E5%8C%96catalina%E7%9A%84">#</a> Bootstrap如何初始化Catalina的？</h3><p>我们用<code>Sequence Diagram</code>插件来看main方法的时序图，但是可以发现它并没有帮我们画出Bootstrap初始化Catalina的过程，这和上面的组件初始化不符合？</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-start-2.png" alt="img"></p>
<p>让我们带着这个为看下Catalina的初始化的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 初始化守护进程</span></span><br><span class="line"><span class="comment">  * </span></span><br><span class="line"><span class="comment">  * <span class="doctag">@throws</span> Exception Fatal initialization error</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化classloader（包括catalinaLoader），下文将具体分析</span></span><br><span class="line">    initClassLoaders();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置当前的线程的contextClassLoader为catalinaLoader</span></span><br><span class="line">    Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line"></span><br><span class="line">    SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过catalinaLoader加载Catalina，并初始化startupInstance 对象</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Loading startup class&quot;</span>);</span><br><span class="line">    Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);</span><br><span class="line">    <span class="type">Object</span> <span class="variable">startupInstance</span> <span class="operator">=</span> startupClass.getConstructor().newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过反射调用了setParentClassLoader 方法</span></span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled())</span><br><span class="line">        log.debug(<span class="string">&quot;Setting startup class properties&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;setParentClassLoader&quot;</span>;</span><br><span class="line">    Class&lt;?&gt; paramTypes[] = <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">1</span>];</span><br><span class="line">    paramTypes[<span class="number">0</span>] = Class.forName(<span class="string">&quot;java.lang.ClassLoader&quot;</span>);</span><br><span class="line">    Object paramValues[] = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">1</span>];</span><br><span class="line">    paramValues[<span class="number">0</span>] = sharedLoader;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span></span><br><span class="line">        startupInstance.getClass().getMethod(methodName, paramTypes);</span><br><span class="line">    method.invoke(startupInstance, paramValues);</span><br><span class="line"></span><br><span class="line">    catalinaDaemon = startupInstance;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面几行关键代码的注释，我们就可以看出Catalina是如何初始化的。这里还留下一个问题，tomcat为什么要初始化不同的classloader呢</p>
<hr>
<h1 id="Tomcat-启动过程-类加载机制详解"><a href="#Tomcat-启动过程-类加载机制详解" class="headerlink" title="Tomcat - 启动过程:类加载机制详解"></a>Tomcat - 启动过程:类加载机制详解</h1><blockquote>
<p>上文我们讲了Tomcat在初始化时会初始化classLoader。本文将具体分析Tomcat的类加载机制，特别是区别于传统的<code>双亲委派模型</code>的加载机制。</p>
</blockquote>
<h2 id="Tomcat初始化了哪些classloader"><a href="#Tomcat初始化了哪些classloader" class="headerlink" title="# Tomcat初始化了哪些classloader"></a><a href="#tomcat%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%86%E5%93%AA%E4%BA%9Bclassloader">#</a> Tomcat初始化了哪些classloader</h2><p>在Bootstrap中我们可以看到有如下三个classloader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassLoader</span> <span class="variable">commonLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">catalinaLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">ClassLoader</span> <span class="variable">sharedLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<h3 id="如何初始化的呢？"><a href="#如何初始化的呢？" class="headerlink" title="# 如何初始化的呢？"></a><a href="#%E5%A6%82%E4%BD%95%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9A%84%E5%91%A2">#</a> 如何初始化的呢？</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initClassLoaders</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// commonLoader初始化</span></span><br><span class="line">        commonLoader = createClassLoader(<span class="string">&quot;common&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (commonLoader == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// no config file, default to this loader - we might be in a &#x27;single&#x27; env.</span></span><br><span class="line">            commonLoader = <span class="built_in">this</span>.getClass().getClassLoader();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// catalinaLoader初始化, 父classloader是commonLoader</span></span><br><span class="line">        catalinaLoader = createClassLoader(<span class="string">&quot;server&quot;</span>, commonLoader);</span><br><span class="line">        <span class="comment">// sharedLoader初始化</span></span><br><span class="line">        sharedLoader = createClassLoader(<span class="string">&quot;shared&quot;</span>, commonLoader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        handleThrowable(t);</span><br><span class="line">        log.error(<span class="string">&quot;Class loader creation threw exception&quot;</span>, t);</span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以看出，catalinaLoader 和 sharedLoader 的 parentClassLoader 是 commonLoader。</p>
</blockquote>
<h3 id="如何创建classLoader的？"><a href="#如何创建classLoader的？" class="headerlink" title="# 如何创建classLoader的？"></a><a href="#%E5%A6%82%E4%BD%95%E5%88%9B%E5%BB%BAclassloader%E7%9A%84">#</a> 如何创建classLoader的？</h3><p>不妨再看下如何创建的？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ClassLoader <span class="title function_">createClassLoader</span><span class="params">(String name, ClassLoader parent)</span></span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> CatalinaProperties.getProperty(name + <span class="string">&quot;.loader&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ((value == <span class="literal">null</span>) || (value.equals(<span class="string">&quot;&quot;</span>)))</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line"></span><br><span class="line">    value = replace(value);</span><br><span class="line"></span><br><span class="line">    List&lt;Repository&gt; repositories = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    String[] repositoryPaths = getPaths(value);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (String repository : repositoryPaths) &#123;</span><br><span class="line">        <span class="comment">// Check for a JAR URL repository</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unused&quot;)</span></span><br><span class="line">            <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(repository);</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.URL));</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Local repository</span></span><br><span class="line">        <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;*.jar&quot;</span>)) &#123;</span><br><span class="line">            repository = repository.substring</span><br><span class="line">                (<span class="number">0</span>, repository.length() - <span class="string">&quot;*.jar&quot;</span>.length());</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.GLOB));</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (repository.endsWith(<span class="string">&quot;.jar&quot;</span>)) &#123;</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.JAR));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            repositories.add(<span class="keyword">new</span> <span class="title class_">Repository</span>(repository, RepositoryType.DIR));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ClassLoaderFactory.createClassLoader(repositories, parent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方法的逻辑也比较简单就是从 catalina.property文件里找 common.loader, shared.loader, server.loader 对应的值，然后构造成Repository 列表，再将Repository 列表传入ClassLoaderFactory.createClassLoader 方法，ClassLoaderFactory.createClassLoader 返回的是 URLClassLoader，而Repository 列表就是这个URLClassLoader 可以加在的类的路径。 在catalina.property文件里</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">common.loader=<span class="string">&quot;<span class="variable">$&#123;catalina.base&#125;</span>/lib&quot;</span>,<span class="string">&quot;<span class="variable">$&#123;catalina.base&#125;</span>/lib/*.jar&quot;</span>,<span class="string">&quot;<span class="variable">$&#123;catalina.home&#125;</span>/lib&quot;</span>,<span class="string">&quot;<span class="variable">$&#123;catalina.home&#125;</span>/lib/*.jar&quot;</span></span><br><span class="line">server.loader=</span><br><span class="line">shared.loader=</span><br></pre></td></tr></table></figure>

<p>其中 shared.loader, server.loader 是没有值的，createClassLoader 方法里如果没有值的话，就返回传入的 parent ClassLoader，也就是说，commonLoader,catalinaLoader,sharedLoader 其实是一个对象。在Tomcat之前的版本里，这三个是不同的URLClassLoader对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; startupClass = catalinaLoader.loadClass(<span class="string">&quot;org.apache.catalina.startup.Catalina&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">startupInstance</span> <span class="operator">=</span> startupClass.getConstructor().newInstance();</span><br></pre></td></tr></table></figure>

<p>初始化完三个ClassLoader对象后，init() 方法就使用 catalinaClassLoader 加载了org.apache.catalina.startup.Catalina 类，并创建了一个对象，然后通过反射调用这个对象的 setParentClassLoader 方法，传入的参数是 sharedClassLoader。最后吧这个 Catania 对象复制给 catalinaDaemon 属性。</p>
<h2 id="深入理解"><a href="#深入理解" class="headerlink" title="# 深入理解"></a><a href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3">#</a> 深入理解</h2><p>可以复习下类加载机制的基础：<a href>JVM基础 - Java 类加载机制</a></p>
<h3 id="什么是类加载机制"><a href="#什么是类加载机制" class="headerlink" title="# 什么是类加载机制"></a><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6">#</a> 什么是类加载机制</h3><p>Java是一门面向对象的语言，而对象又必然依托于类。类要运行，必须首先被加载到内存。我们可以简单地把类分为几类：</p>
<ul>
<li>Java自带的核心类</li>
<li>Java支持的可扩展类</li>
<li>我们自己编写的类</li>
<li><strong>为什么要设计多个类加载器</strong>？</li>
</ul>
<blockquote>
<p>如果所有的类都使用一个类加载器来加载，会出现什么问题呢？</p>
</blockquote>
<p>假如我们自己编写一个类<code>java.util.Object</code>，它的实现可能有一定的危险性或者隐藏的bug。而我们知道Java自带的核心类里面也有<code>java.util.Object</code>，如果JVM启动的时候先行加载的是我们自己编写的<code>java.util.Object</code>，那么就有可能出现安全问题！</p>
<p>所以，Sun（后被Oracle收购）采用了另外一种方式来保证最基本的、也是最核心的功能不会被破坏。你猜的没错，那就是双亲委派模式！</p>
<ul>
<li><strong>什么是双亲委派模型</strong>？</li>
</ul>
<blockquote>
<p>双亲委派模型解决了类错乱加载的问题，也设计得非常精妙。</p>
</blockquote>
<p>双亲委派模式对类加载器定义了层级，每个类加载器都有一个父类加载器。在一个类需要加载的时候，首先委派给父类加载器来加载，而父类加载器又委派给祖父类加载器来加载，以此类推。如果父类及上面的类加载器都加载不了，那么由当前类加载器来加载，并将被加载的类缓存起来。</p>
<p><img src="https://pdai.tech/images/jvm/java_jvm_classload_3.png" alt="img"></p>
<p>所以上述类是这么加载的</p>
<ul>
<li>Java自带的核心类 – 由启动类加载器加载</li>
<li>Java支持的可扩展类 – 由扩展类加载器加载</li>
<li>我们自己编写的类 – 默认由应用程序类加载器或其子类加载</li>
</ul>
<blockquote>
<p>但它也不是万能的，在有些场景也会遇到它解决不了的问题，比如如下场景。</p>
</blockquote>
<h3 id="双亲委派模型问题是如何解决的？"><a href="#双亲委派模型问题是如何解决的？" class="headerlink" title="# 双亲委派模型问题是如何解决的？"></a><a href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B%E9%97%AE%E9%A2%98%E6%98%AF%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%9A%84">#</a> 双亲委派模型问题是如何解决的？</h3><blockquote>
<p>在Java核心类里面有SPI（Service Provider Interface），它由Sun编写规范，第三方来负责实现。SPI需要用到第三方实现类。如果使用双亲委派模型，那么第三方实现类也需要放在Java核心类里面才可以，不然的话第三方实现类将不能被加载使用。但是这显然是不合理的！怎么办呢？</p>
</blockquote>
<p><strong>ContextClassLoader</strong>（上下文类加载器）就来解围了。</p>
<p>在java.lang.Thread里面有两个方法，get&#x2F;set上下文类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContextClassLoader</span><span class="params">(ClassLoader cl)</span></span><br><span class="line"><span class="keyword">public</span> ClassLoader <span class="title function_">getContextClassLoader</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p>我们可以通过在SPI类里面调用getContextClassLoader来获取第三方实现类的类加载器。由第三方实现类通过调用setContextClassLoader来传入自己实现的类加载器, 这样就变相地解决了双亲委派模式遇到的问题。</p>
<h3 id="为什么Tomcat的类加载器也不是双亲委派模型"><a href="#为什么Tomcat的类加载器也不是双亲委派模型" class="headerlink" title="# 为什么Tomcat的类加载器也不是双亲委派模型"></a><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88tomcat%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%B9%9F%E4%B8%8D%E6%98%AF%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%9E%8B">#</a> 为什么Tomcat的类加载器也不是双亲委派模型</h3><blockquote>
<p>我们知道，Java默认的类加载机制是通过双亲委派模型来实现的，而Tomcat实现的方式又和双亲委派模型有所区别。</p>
</blockquote>
<p><strong>原因在于一个Tomcat容器允许同时运行多个Web程序，每个Web程序依赖的类又必须是相互隔离的</strong>。因此，如果Tomcat使用双亲委派模式来加载类的话，将导致Web程序依赖的类变为共享的。</p>
<p>举个例子，假如我们有两个Web程序，一个依赖A库的1.0版本，另一个依赖A库的2.0版本，他们都使用了类xxx.xx.Clazz，其实现的逻辑因类库版本的不同而结构完全不同。那么这两个Web程序的其中一个必然因为加载的Clazz不是所使用的Clazz而出现问题！而这对于开发来说是非常致命的！</p>
<h3 id="Tomcat类加载机制是怎么样的呢"><a href="#Tomcat类加载机制是怎么样的呢" class="headerlink" title="# Tomcat类加载机制是怎么样的呢"></a><a href="#tomcat%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%E6%98%AF%E6%80%8E%E4%B9%88%E6%A0%B7%E7%9A%84%E5%91%A2">#</a> Tomcat类加载机制是怎么样的呢</h3><blockquote>
<p>既然Tomcat的类加载机器不同于双亲委派模式，那么它又是一种怎样的模式呢？</p>
</blockquote>
<p>我们在这里一定要看下官网提供的<a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html">类加载的文档在新窗口打开</a></p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-classloader-1.png" alt="img"></p>
<p>结合经典的类加载机制，我们完整的看下Tomcat类加载图</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-classloader-2.png" alt="img"></p>
<p>我们在这张图中看到很多类加载器，除了Jdk自带的类加载器，我们尤其关心Tomcat自身持有的类加载器。仔细一点我们很容易发现：Catalina类加载器和Shared类加载器，他们并不是父子关系，而是兄弟关系。为啥这样设计，我们得分析一下每个类加载器的用途，才能知晓。</p>
<ul>
<li><p>Common类加载器</p>
<p>，负责加载Tomcat和Web应用都复用的类 </p>
<ul>
<li><p><strong>Catalina类加载器</strong>，负责加载Tomcat专用的类，而这些被加载的类在Web应用中将不可见</p>
</li>
<li><p>Shared类加载器</p>
<p>，负责加载Tomcat下所有的Web应用程序都复用的类，而这些被加载的类在Tomcat中将不可见 </p>
<ul>
<li><strong>WebApp类加载器</strong>，负责加载具体的某个Web应用程序所使用到的类，而这些被加载的类在Tomcat和其他的Web应用程序都将不可见</li>
<li><strong>Jsp类加载器</strong>，每个jsp页面一个类加载器，不同的jsp页面有不同的类加载器，方便实现jsp页面的热插拔</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>同样的，我们可以看到通过<strong>ContextClassLoader</strong>（上下文类加载器）的<strong>setContextClassLoader</strong>来传入自己实现的类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">  initClassLoaders();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 看这里</span></span><br><span class="line">  Thread.currentThread().setContextClassLoader(catalinaLoader);</span><br><span class="line"></span><br><span class="line">  SecurityClassLoad.securityClassLoad(catalinaLoader);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="WebApp类加载器"><a href="#WebApp类加载器" class="headerlink" title="# WebApp类加载器"></a><a href="#webapp%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">#</a> WebApp类加载器</h3><blockquote>
<p>到这儿，我们隐隐感觉到少分析了点什么！没错，就是WebApp类加载器。整个启动过程分析下来，我们仍然没有看到这个类加载器。它又是在哪儿出现的呢？</p>
</blockquote>
<p>我们知道WebApp类加载器是Web应用私有的，而每个Web应用其实算是一个Context，那么我们通过Context的实现类应该可以发现。在Tomcat中，Context的默认实现为StandardContext，我们看看这个类的startInternal()方法，在这儿我们发现了我们感兴趣的WebApp类加载器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">startInternal</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException &#123;</span><br><span class="line">    <span class="keyword">if</span> (getLoader() == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">WebappLoader</span> <span class="variable">webappLoader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebappLoader</span>(getParentClassLoader());</span><br><span class="line">        webappLoader.setDelegate(getDelegate());</span><br><span class="line">        setLoader(webappLoader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>入口代码非常简单，就是webappLoader不存在的时候创建一个，并调用setLoader方法。我们接着分析setLoader</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLoader</span><span class="params">(Loader loader)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Lock</span> <span class="variable">writeLock</span> <span class="operator">=</span> loaderLock.writeLock();</span><br><span class="line">    writeLock.lock();</span><br><span class="line">    <span class="type">Loader</span> <span class="variable">oldLoader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Change components if necessary</span></span><br><span class="line">        oldLoader = <span class="built_in">this</span>.loader;</span><br><span class="line">        <span class="keyword">if</span> (oldLoader == loader)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        <span class="built_in">this</span>.loader = loader;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stop the old component if necessary</span></span><br><span class="line">        <span class="keyword">if</span> (getState().isAvailable() &amp;&amp; (oldLoader != <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">            (oldLoader <span class="keyword">instanceof</span> Lifecycle)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((Lifecycle) oldLoader).stop();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;StandardContext.setLoader: stop: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the new component if necessary</span></span><br><span class="line">        <span class="keyword">if</span> (loader != <span class="literal">null</span>)</span><br><span class="line">            loader.setContext(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (getState().isAvailable() &amp;&amp; (loader != <span class="literal">null</span>) &amp;&amp;</span><br><span class="line">            (loader <span class="keyword">instanceof</span> Lifecycle)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((Lifecycle) loader).start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;StandardContext.setLoader: start: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Report this property change to interested listeners</span></span><br><span class="line">    support.firePropertyChange(<span class="string">&quot;loader&quot;</span>, oldLoader, loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这儿，我们感兴趣的就两行代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">((Lifecycle) oldLoader).stop(); <span class="comment">// 旧的加载器停止</span></span><br><span class="line">((Lifecycle) loader).start(); <span class="comment">// 新的加载器启动</span></span><br></pre></td></tr></table></figure>

<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="# 参考文章"></a><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">#</a> 参考文章</h3><ul>
<li><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html">https://tomcat.apache.org/tomcat-9.0-doc/class-loader-howto.html</a></li>
<li>juconcurrent <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/51b2c50c58eb">https://www.jianshu.com/p/51b2c50c58eb</a></li>
</ul>
<h1 id="Tomcat-启动过程-Catalina的加载"><a href="#Tomcat-启动过程-Catalina的加载" class="headerlink" title="Tomcat - 启动过程:Catalina的加载"></a>Tomcat - 启动过程:Catalina的加载</h1><blockquote>
<p>通过前两篇文章，我们知道了<a href>Tomcat的类加载机制</a>和<a href>整体的组件加载流程</a>；我们也知道通过Bootstrap初始化的catalinaClassLoader加载了Catalina，那么进而引入了一个问题就是Catalina是如何加载的呢？加载了什么呢？本文将带你进一步分析。</p>
</blockquote>
<h2 id="Catalina的引入"><a href="#Catalina的引入" class="headerlink" title="# Catalina的引入"></a><a href="#catalina%E7%9A%84%E5%BC%95%E5%85%A5">#</a> Catalina的引入</h2><blockquote>
<p>通过前两篇文章，我们知道了Tomcat的类加载机制和整体的组件加载流程；我们也知道通过Bootstrap初始化的catalinaClassLoader加载了Catalina，那么进而引入了一个问题就是Catalina是如何加载的呢？加载了什么呢？</p>
</blockquote>
<ul>
<li>先回顾下整个流程，和我们分析的阶段</li>
</ul>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-catalina-1.png" alt="img"></p>
<ul>
<li>看下Bootstrap中Load的过程</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 加载守护进程</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String[] arguments)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Call the load() method</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;load&quot;</span>;</span><br><span class="line">    Object param[];</span><br><span class="line">    Class&lt;?&gt; paramTypes[];</span><br><span class="line">    <span class="keyword">if</span> (arguments==<span class="literal">null</span> || arguments.length==<span class="number">0</span>) &#123;</span><br><span class="line">        paramTypes = <span class="literal">null</span>;</span><br><span class="line">        param = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        paramTypes = <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">1</span>];</span><br><span class="line">        paramTypes[<span class="number">0</span>] = arguments.getClass();</span><br><span class="line">        param = <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">1</span>];</span><br><span class="line">        param[<span class="number">0</span>] = arguments;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span></span><br><span class="line">        catalinaDaemon.getClass().getMethod(methodName, paramTypes); </span><br><span class="line">    <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;Calling startup class &quot;</span> + method);</span><br><span class="line">    &#125;</span><br><span class="line">    method.invoke(catalinaDaemon, param);<span class="comment">// 本质上就是调用catalina的load方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Catalina的加载"><a href="#Catalina的加载" class="headerlink" title="# Catalina的加载"></a><a href="#catalina%E7%9A%84%E5%8A%A0%E8%BD%BD">#</a> Catalina的加载</h2><p>上一步，我们知道catalina load的触发，因为有参数所以是load(String[])方法。我们进而看下这个load方法做了什么？</p>
<ul>
<li>load(String[])本质上还是调用了load方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * Load using arguments</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">(String args[])</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (arguments(args)) &#123; <span class="comment">// 处理命令行的参数</span></span><br><span class="line">            load();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace(System.out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>load加载过程本质上是初始化Server的实例</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Start a new server instance.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">load</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果已经加载则退出</span></span><br><span class="line">    <span class="keyword">if</span> (loaded) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    loaded = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// （已经弃用）</span></span><br><span class="line">    initDirs();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before digester - it may be needed</span></span><br><span class="line">    initNaming();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析 server.xml</span></span><br><span class="line">    parseServerXml(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Server</span> <span class="variable">s</span> <span class="operator">=</span> getServer();</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getServer().setCatalina(<span class="built_in">this</span>);</span><br><span class="line">    getServer().setCatalinaHome(Bootstrap.getCatalinaHomeFile());</span><br><span class="line">    getServer().setCatalinaBase(Bootstrap.getCatalinaBaseFile());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Stream redirection</span></span><br><span class="line">    initStreams();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动Server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getServer().init();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Boolean.getBoolean(<span class="string">&quot;org.apache.catalina.startup.EXIT_ON_INIT_FAILURE&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.lang.Error(e);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">&quot;catalina.initError&quot;</span>), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(sm.getString(<span class="string">&quot;catalina.init&quot;</span>, Long.toString(TimeUnit.NANOSECONDS.toMillis(System.nanoTime() - t1))));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总体流程如下：</p>
<p><img src="https://pdai.tech/images/tomcat/tomcat-x-catalina-2.png" alt="img"></p>
<h3 id="initDirs"><a href="#initDirs" class="headerlink" title="# initDirs"></a><a href="#initdirs">#</a> initDirs</h3><p>已经弃用了，Tomcat10会删除这个方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@deprecated</span> unused. Will be removed in Tomcat 10 onwards.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initDirs</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initNaming"><a href="#initNaming" class="headerlink" title="# initNaming"></a><a href="#initnaming">#</a> initNaming</h3><p>设置额外的系统变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initNaming</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// Setting additional variables</span></span><br><span class="line">  <span class="keyword">if</span> (!useNaming) &#123;</span><br><span class="line">      log.info(sm.getString(<span class="string">&quot;catalina.noNaming&quot;</span>));</span><br><span class="line">      System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      System.setProperty(<span class="string">&quot;catalina.useNaming&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> <span class="string">&quot;org.apache.naming&quot;</span>;</span><br><span class="line">      <span class="type">String</span> <span class="variable">oldValue</span> <span class="operator">=</span></span><br><span class="line">          System.getProperty(javax.naming.Context.URL_PKG_PREFIXES);</span><br><span class="line">      <span class="keyword">if</span> (oldValue != <span class="literal">null</span>) &#123;</span><br><span class="line">          value = value + <span class="string">&quot;:&quot;</span> + oldValue;</span><br><span class="line">      &#125;</span><br><span class="line">      System.setProperty(javax.naming.Context.URL_PKG_PREFIXES, value);</span><br><span class="line">      <span class="keyword">if</span>( log.isDebugEnabled() ) &#123;</span><br><span class="line">          log.debug(<span class="string">&quot;Setting naming prefix=&quot;</span> + value);</span><br><span class="line">      &#125;</span><br><span class="line">      value = System.getProperty</span><br><span class="line">          (javax.naming.Context.INITIAL_CONTEXT_FACTORY);</span><br><span class="line">      <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">          System.setProperty</span><br><span class="line">              (javax.naming.Context.INITIAL_CONTEXT_FACTORY,</span><br><span class="line">                <span class="string">&quot;org.apache.naming.java.javaURLContextFactory&quot;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          log.debug(<span class="string">&quot;INITIAL_CONTEXT_FACTORY already set &quot;</span> + value );</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Server-xml的解析"><a href="#Server-xml的解析" class="headerlink" title="# Server.xml的解析"></a><a href="#server-xml%E7%9A%84%E8%A7%A3%E6%9E%90">#</a> Server.xml的解析</h3><p>分三大块，下面的代码还是很清晰的:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parseServerXml</span><span class="params">(<span class="type">boolean</span> start)</span> &#123;</span><br><span class="line">    <span class="comment">// Set configuration source</span></span><br><span class="line">    ConfigFileLoader.setSource(<span class="keyword">new</span> <span class="title class_">CatalinaBaseConfigurationSource</span>(Bootstrap.getCatalinaBaseFile(), getConfigFile()));</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> configFile();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (useGeneratedCode &amp;&amp; !Digester.isGeneratedCodeLoaderSet()) &#123;</span><br><span class="line">        <span class="comment">// Load loader</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loaderClassName</span> <span class="operator">=</span> generatedCodePackage + <span class="string">&quot;.DigesterGeneratedCodeLoader&quot;</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Digester.<span class="type">GeneratedCodeLoader</span> <span class="variable">loader</span> <span class="operator">=</span></span><br><span class="line">                    (Digester.GeneratedCodeLoader) Catalina.class.getClassLoader().loadClass(loaderClassName).newInstance();</span><br><span class="line">            Digester.setGeneratedCodeLoader(loader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.info(sm.getString(<span class="string">&quot;catalina.noLoader&quot;</span>, loaderClassName), e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.info(sm.getString(<span class="string">&quot;catalina.noLoader&quot;</span>, loaderClassName));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// No loader so don&#x27;t use generated code</span></span><br><span class="line">            useGeneratedCode = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化server.xml的位置</span></span><br><span class="line">    <span class="type">File</span> <span class="variable">serverXmlLocation</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">xmlClassName</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (generateCode || useGeneratedCode) &#123;</span><br><span class="line">        xmlClassName = start ? generatedCodePackage + <span class="string">&quot;.ServerXml&quot;</span> : generatedCodePackage + <span class="string">&quot;.ServerXmlStop&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (generateCode) &#123;</span><br><span class="line">        <span class="keyword">if</span> (generatedCodeLocationParameter != <span class="literal">null</span>) &#123;</span><br><span class="line">            generatedCodeLocation = <span class="keyword">new</span> <span class="title class_">File</span>(generatedCodeLocationParameter);</span><br><span class="line">            <span class="keyword">if</span> (!generatedCodeLocation.isAbsolute()) &#123;</span><br><span class="line">                generatedCodeLocation = <span class="keyword">new</span> <span class="title class_">File</span>(Bootstrap.getCatalinaHomeFile(), generatedCodeLocationParameter);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            generatedCodeLocation = <span class="keyword">new</span> <span class="title class_">File</span>(Bootstrap.getCatalinaHomeFile(), <span class="string">&quot;work&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        serverXmlLocation = <span class="keyword">new</span> <span class="title class_">File</span>(generatedCodeLocation, generatedCodePackage);</span><br><span class="line">        <span class="keyword">if</span> (!serverXmlLocation.isDirectory() &amp;&amp; !serverXmlLocation.mkdirs()) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;catalina.generatedCodeLocationError&quot;</span>, generatedCodeLocation.getAbsolutePath()));</span><br><span class="line">            <span class="comment">// Disable code generation</span></span><br><span class="line">            generateCode = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用 SAXParser 来解析 xml，解析完了之后，xml 里定义的各种标签就有对应的实现类对象了</span></span><br><span class="line">    <span class="type">ServerXml</span> <span class="variable">serverXml</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (useGeneratedCode) &#123;</span><br><span class="line">        serverXml = (ServerXml) Digester.loadGeneratedClass(xmlClassName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (serverXml != <span class="literal">null</span>) &#123;</span><br><span class="line">        serverXml.load(<span class="built_in">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (ConfigurationSource.<span class="type">Resource</span> <span class="variable">resource</span> <span class="operator">=</span> ConfigFileLoader.getSource().getServerXml()) &#123;</span><br><span class="line">            <span class="comment">// Create and execute our Digester</span></span><br><span class="line">            <span class="type">Digester</span> <span class="variable">digester</span> <span class="operator">=</span> start ? createStartDigester() : createStopDigester();</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> resource.getInputStream();</span><br><span class="line">            <span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(resource.getURI().toURL().toString());</span><br><span class="line">            inputSource.setByteStream(inputStream);</span><br><span class="line">            digester.push(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (generateCode) &#123;</span><br><span class="line">                digester.startGeneratingCode();</span><br><span class="line">                generateClassHeader(digester, start);</span><br><span class="line">            &#125;</span><br><span class="line">            digester.parse(inputSource);</span><br><span class="line">            <span class="keyword">if</span> (generateCode) &#123;</span><br><span class="line">                generateClassFooter(digester);</span><br><span class="line">                <span class="keyword">try</span> (<span class="type">FileWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileWriter</span>(<span class="keyword">new</span> <span class="title class_">File</span>(serverXmlLocation,</span><br><span class="line">                        start ? <span class="string">&quot;ServerXml.java&quot;</span> : <span class="string">&quot;ServerXmlStop.java&quot;</span>))) &#123;</span><br><span class="line">                    writer.write(digester.getGeneratedCode().toString());</span><br><span class="line">                &#125;</span><br><span class="line">                digester.endGeneratingCode();</span><br><span class="line">                Digester.addGeneratedClass(xmlClassName);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.warn(sm.getString(<span class="string">&quot;catalina.configFail&quot;</span>, file.getAbsolutePath()), e);</span><br><span class="line">            <span class="keyword">if</span> (file.exists() &amp;&amp; !file.canRead()) &#123;</span><br><span class="line">                log.warn(sm.getString(<span class="string">&quot;catalina.incorrectPermissions&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="initStreams"><a href="#initStreams" class="headerlink" title="# initStreams"></a><a href="#initstreams">#</a> initStreams</h3><p>替换掉System.out, System.err为自定义的PrintStream</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initStreams</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Replace System.out and System.err with a custom PrintStream</span></span><br><span class="line">    System.setOut(<span class="keyword">new</span> <span class="title class_">SystemLogHandler</span>(System.out));</span><br><span class="line">    System.setErr(<span class="keyword">new</span> <span class="title class_">SystemLogHandler</span>(System.err));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Catalina-的启动"><a href="#Catalina-的启动" class="headerlink" title="# Catalina 的启动"></a><a href="#catalina-%E7%9A%84%E5%90%AF%E5%8A%A8">#</a> Catalina 的启动</h2><p>在 load 方法之后，Tomcat 就初始化了一系列的组件，接着就可以调用 start 方法进行启动了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Start a new server instance.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        load();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getServer() == <span class="literal">null</span>) &#123;</span><br><span class="line">        log.fatal(sm.getString(<span class="string">&quot;catalina.noServer&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">t1</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the new server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getServer().start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        log.fatal(sm.getString(<span class="string">&quot;catalina.serverStartFail&quot;</span>), e);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            getServer().destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException e1) &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;destroy() failed for failed Server &quot;</span>, e1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">t2</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    <span class="keyword">if</span>(log.isInfoEnabled()) &#123;</span><br><span class="line">        log.info(sm.getString(<span class="string">&quot;catalina.startup&quot;</span>, Long.valueOf((t2 - t1) / <span class="number">1000000</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Register shutdown hook</span></span><br><span class="line">    <span class="keyword">if</span> (useShutdownHook) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shutdownHook == <span class="literal">null</span>) &#123;</span><br><span class="line">            shutdownHook = <span class="keyword">new</span> <span class="title class_">CatalinaShutdownHook</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If JULI is being used, disable JULI&#x27;s shutdown hook since</span></span><br><span class="line">        <span class="comment">// shutdown hooks run in parallel and log messages may be lost</span></span><br><span class="line">        <span class="comment">// if JULI&#x27;s hook completes before the CatalinaShutdownHook()</span></span><br><span class="line">        <span class="type">LogManager</span> <span class="variable">logManager</span> <span class="operator">=</span> LogManager.getLogManager();</span><br><span class="line">        <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">            ((ClassLoaderLogManager) logManager).setUseShutdownHook(</span><br><span class="line">                    <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (await) &#123;</span><br><span class="line">        await();</span><br><span class="line">        stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面这段代码，逻辑非常简单，首先确定 getServer() 方法不为 null ，也就是确定 server 属性不为null，而 server 属性是在 load 方法就初始化了。</p>
<p>整段代码的核心就是 try-catch 里的 getServer().start() 方法了，也就是调用 Server 对象的 start() 方法来启动 Tomcat。本篇文章就先不对 Server 的 start() 方法进行解析了，下篇文章会单独讲。</p>
<h2 id="Catalina-的关闭"><a href="#Catalina-的关闭" class="headerlink" title="# Catalina 的关闭"></a><a href="#catalina-%E7%9A%84%E5%85%B3%E9%97%AD">#</a> Catalina 的关闭</h2><p>调用完 Server#start 方法之后，注册了一个ShutDownHook，也就是 CatalinaShutdownHook 对象，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Shutdown hook which will perform a clean shutdown of Catalina if needed.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">class</span> <span class="title class_">CatalinaShutdownHook</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (getServer() != <span class="literal">null</span>) &#123;</span><br><span class="line">              Catalina.<span class="built_in">this</span>.stop();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">          ExceptionUtils.handleThrowable(ex);</span><br><span class="line">          log.error(sm.getString(<span class="string">&quot;catalina.shutdownHookFail&quot;</span>), ex);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">// If JULI is used, shut JULI down *after* the server shuts down</span></span><br><span class="line">          <span class="comment">// so log messages aren&#x27;t lost</span></span><br><span class="line">          <span class="type">LogManager</span> <span class="variable">logManager</span> <span class="operator">=</span> LogManager.getLogManager();</span><br><span class="line">          <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">              ((ClassLoaderLogManager) logManager).shutdown();</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CatalinaShutdownHook 的逻辑也简单，就是调用 Catalina 对象的 stop 方法来停止 tomcat。</p>
<p>最后就进入 if 语句了，await 是在 Bootstrap 里调用的时候设置为 true 的，也就是本文开头的时候提到的三个方法中的一个。await 方法的作用是停住主线程，等待用户输入shutdown 命令之后，停止等待，之后 main 线程就调用 stop 方法来停止Tomcat。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Stop an existing server instance.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Remove the ShutdownHook first so that server.stop()</span></span><br><span class="line">        <span class="comment">// doesn&#x27;t get invoked twice</span></span><br><span class="line">        <span class="keyword">if</span> (useShutdownHook) &#123;</span><br><span class="line">            Runtime.getRuntime().removeShutdownHook(shutdownHook);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If JULI is being used, re-enable JULI&#x27;s shutdown to ensure</span></span><br><span class="line">            <span class="comment">// log messages are not lost</span></span><br><span class="line">            <span class="type">LogManager</span> <span class="variable">logManager</span> <span class="operator">=</span> LogManager.getLogManager();</span><br><span class="line">            <span class="keyword">if</span> (logManager <span class="keyword">instanceof</span> ClassLoaderLogManager) &#123;</span><br><span class="line">                ((ClassLoaderLogManager) logManager).setUseShutdownHook(</span><br><span class="line">                        <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ExceptionUtils.handleThrowable(t);</span><br><span class="line">        <span class="comment">// This will fail on JDK 1.2. Ignoring, as Tomcat can run</span></span><br><span class="line">        <span class="comment">// fine without the shutdown hook.</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shut down the server</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">Server</span> <span class="variable">s</span> <span class="operator">=</span> getServer();</span><br><span class="line">        <span class="type">LifecycleState</span> <span class="variable">state</span> <span class="operator">=</span> s.getState();</span><br><span class="line">        <span class="keyword">if</span> (LifecycleState.STOPPING_PREP.compareTo(state) &lt;= <span class="number">0</span></span><br><span class="line">                &amp;&amp; LifecycleState.DESTROYED.compareTo(state) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Nothing to do. stop() was already called</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            s.stop();</span><br><span class="line">            s.destroy();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">        log.error(sm.getString(<span class="string">&quot;catalina.stopError&quot;</span>), e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Catalina 的 stop 方法主要逻辑是调用 Server 对象的 stop 方法。</p>
<h2 id="聊聊关闭钩子"><a href="#聊聊关闭钩子" class="headerlink" title="# 聊聊关闭钩子"></a><a href="#%E8%81%8A%E8%81%8A%E5%85%B3%E9%97%AD%E9%92%A9%E5%AD%90">#</a> 聊聊关闭钩子</h2><p>上面我们看到CatalinaShutdownHook, 这里有必要谈谈JVM的关闭钩子。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shutdownHook == <span class="literal">null</span>) &#123;</span><br><span class="line">    shutdownHook = <span class="keyword">new</span> <span class="title class_">CatalinaShutdownHook</span>();</span><br><span class="line">&#125;</span><br><span class="line">Runtime.getRuntime().addShutdownHook(shutdownHook);</span><br></pre></td></tr></table></figure>

<p>关闭钩子是指通过<strong>Runtime.addShutdownHook注册的但尚未开始的线程</strong>。这些钩子可以用于<strong>实现服务或者应用程序的清理工作</strong>，例如删除临时文件，或者清除无法由操作系统自动清除的资源。</p>
<p>JVM既可以正常关闭，也可以强行关闭。正常关闭的触发方式有多种，包括：当最后一个“正常（非守护）”线程结束时，或者当调用了System.exit时，或者通过其他特定于平台的方法关闭时（例如发送了SIGINT信号或者键入Ctrl-C）。</p>
<p>在<strong>正常关闭中，JVM首先调用所有已注册的关闭钩子</strong>。JVM并不能保证关闭钩子的调用顺序。在关闭应用程序线程时，如果有（守护或者非守护）线程仍然在执行，那么这些线程接下来将与关闭进程并发执行。当所有的关闭钩子都执行结束时，如果runFinalizersOnExit为true【通过Runtime.runFinalizersOnExit(true)设置】，那么JVM将运行这些Finalizer（对象重写的finalize方法），然后再停止。JVM不会停止或中断任何在关闭时仍然运行的应用程序线程。当JVM最终结束时，这些线程将被强行结束。如果关闭钩子或者Finalizer没有执行完成，那么正常关闭进程“挂起”并且JVM必须被强行关闭。当<strong>JVM被强行关闭时，只是关闭JVM，并不会运行关闭钩子</strong>（举个例子，类似于电源都直接拔了，还怎么做其它动作呢？）。</p>
<p>下面是一个简单的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">T</span> &#123;</span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;deprecation&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		<span class="comment">//启用退出JVM时执行Finalizer</span></span><br><span class="line">		Runtime.runFinalizersOnExit(<span class="literal">true</span>);</span><br><span class="line">		<span class="type">MyHook</span> <span class="variable">hook1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHook</span>(<span class="string">&quot;Hook1&quot;</span>);</span><br><span class="line">		<span class="type">MyHook</span> <span class="variable">hook2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHook</span>(<span class="string">&quot;Hook2&quot;</span>);</span><br><span class="line">		<span class="type">MyHook</span> <span class="variable">hook3</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHook</span>(<span class="string">&quot;Hook3&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//注册关闭钩子</span></span><br><span class="line">		Runtime.getRuntime().addShutdownHook(hook1);</span><br><span class="line">		Runtime.getRuntime().addShutdownHook(hook2);</span><br><span class="line">		Runtime.getRuntime().addShutdownHook(hook3);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//移除关闭钩子</span></span><br><span class="line">		Runtime.getRuntime().removeShutdownHook(hook3);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//Main线程将在执行这句之后退出</span></span><br><span class="line">		System.out.println(<span class="string">&quot;Main Thread Ends.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHook</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">MyHook</span> <span class="params">(String name)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.name = name;</span><br><span class="line">		setName(name);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		System.out.println(name + <span class="string">&quot; Ends.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//重写Finalizer，将在关闭钩子后调用</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">		System.out.println(name + <span class="string">&quot; Finalize.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>和（可能的）执行结果（因为JVM不保证关闭钩子的调用顺序，因此结果中的第二、三行可能出现相反的顺序）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Main Thread Ends.</span><br><span class="line">Hook2 Ends.</span><br><span class="line">Hook1 Ends.</span><br><span class="line">Hook3 Finalize.</span><br><span class="line">Hook2 Finalize.</span><br><span class="line">Hook1 Finalize.</span><br></pre></td></tr></table></figure>

<p>可以看到，main函数执行完成，首先输出的是Main Thread Ends，接下来执行关闭钩子，输出Hook2 Ends和Hook1 Ends。这两行也可以证实：JVM确实不是以注册的顺序来调用关闭钩子的。而由于hook3在调用了addShutdownHook后，接着对其调用了removeShutdownHook将其移除，于是hook3在JVM退出时没有执行，因此没有输出Hook3 Ends。</p>
<p>另外，由于MyHook类实现了finalize方法，而main函数中第一行又通过Runtime.runFinalizersOnExit(true)打开了退出JVM时执行Finalizer的开关，于是3个hook对象的finalize方法被调用，输出了3行Finalize。</p>
<p>注意，多次调用addShutdownHook来注册同一个关闭钩子将会抛出IllegalArgumentException:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread <span class="string">&quot;main&quot;</span> java.lang.IllegalArgumentException: Hook previously registered</span><br><span class="line">	at java.lang.ApplicationShutdownHooks.add(ApplicationShutdownHooks.java:72)</span><br><span class="line">	at java.lang.Runtime.addShutdownHook(Runtime.java:211)</span><br><span class="line">	at T.main(T.java:12)</span><br></pre></td></tr></table></figure>

<p>另外，从JavaDoc中得知：<strong>一旦JVM关闭流程开始，就只能通过调用halt方法来停止该流程，也不可能再注册或移除关闭钩子了，这些操作将导致抛出IllegalStateException</strong>。</p>
<p>如果在关闭钩子中关闭应用程序的公共的组件，如日志服务，或者数据库连接等，像下面这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">try</span> &#123; </span><br><span class="line">			LogService.<span class="built_in">this</span>.stop();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException ignored)&#123;</span><br><span class="line">			<span class="comment">//ignored</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>由于<strong>关闭钩子将并发执行，因此在关闭日志时可能导致其他需要日志服务的关闭钩子产生问题</strong>。<strong>为了避免这种情况，可以使关闭钩子不依赖那些可能被应用程序或其他关闭钩子关闭的服务</strong>。实现这种功能的一种方式是对所有服务使用同一个关闭钩子（而不是每个服务使用一个不同的关闭钩子），并且在该关闭钩子中执行一系列的关闭操作。这确保了关闭操作在单个线程中串行执行，从而避免了在关闭操作之前出现竞态条件或死锁等问题。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="# 使用场景"></a><a href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF">#</a> 使用场景</h3><p>通过Hook实现临时文件清理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">test</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          Thread.sleep(<span class="number">20000</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">          <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">              System.out.println(<span class="string">&quot;auto clean temporary file&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="# 小结"></a><a href="#%E5%B0%8F%E7%BB%93">#</a> 小结</h2><p>Catalina 类承接了 Bootstrap 类的 load 和 start 方法，然后根据配置初始化了 Tomcat 的组件，并调用了 Server 类的 init 和 start 方法来启动 Tomcat。</p>
<h2 id="参考文章-1"><a href="#参考文章-1" class="headerlink" title="# 参考文章"></a><a href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0">#</a> 参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022012525">https://segmentfault.com/a/1190000022012525</a></li>
<li><a target="_blank" rel="noopener" href="https://my.oschina.net/itblog/blog/811053">https://my.oschina.net/itblog/blog/811053</a></li>
</ul>
<hr>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://qwq0qwq.github.io/2023/08/11/Tomcat%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://qwq0qwq.github.io/2023/08/11/Tomcat%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/";
            const title         = "「Tomcat启动过程」";
            const excerpt       = `Tomcat - 启动过程：初始化和启动流程
在有了Tomcat架构设计和源码入口以后，我们便可以开始真正读源码了。

# 总体流程
很多人在看框架代码的时候会很难抓住重点的，而一开始了解整体流程会很大程度提升理解的效率。

我们看下...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    
                </div>
                <div class="pull-date">
                    <time datetime="2023-08-10T23:57:38.701Z" itemprop="dateModified">最后编辑：2023-08-11</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" Flask（Jinja2） 服务端模板注入漏洞" href="/2023/08/09/Flask（Jinja2）-服务端模板注入漏洞/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" 域控提权" href="/2023/10/10/域控提权/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/icon.jpg" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                20
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                0
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                2
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                

            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/HTB/" style="font-size: 0.6em;">HTB</a> <a href="/tags/web/" style="font-size: 0.8em;">web</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2025/01/19/%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa  fa-book"></i> 免杀学习笔记</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/01/19/EscapeTwo/"><i class="fa  fa-book"></i> EscapeTwo</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/01/07/plt%E8%A1%A8%E5%92%8Cgot%E8%A1%A8/"><i class="fa  fa-book"></i> plt表和got表</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/11/24/%E6%9C%A8%E9%A9%AC%E9%9A%90%E8%97%8F%E6%8A%80%E5%B7%A7%EF%BC%88%E4%B8%80%EF%BC%89/"><i class="fa  fa-book"></i> 木马隐藏技巧（一）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/11/23/%E5%AE%89%E5%8D%93%E6%8A%93%E5%8C%85/"><i class="fa  fa-book"></i> 安卓抓包</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2025 QWQ0QWQ's blog 版权所有.</li>
                            <li>本站已运行1亿年<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by QWQ0QWQ.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="3204190542"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>